(function(){if(window.BookEx)return;var BookEx={Prop:{ajaxUrl:"/ajax/bookex.ashx",forumIndex:1,lastPostTime:"",chapterIndex:0,isDesc:0,pageIndex:1,pageSize:10},ajax:function(params,callback){var that=this;$.ajax({type:"get",cache:false,dataType:"json",url:that.Prop.ajaxUrl,data:params,error:function(data){if(window.console){console.log("error log: "+data.responseText);}},success:function(data){callback.call(that,data);}});},getChapterList:function(bookId,index,pageload){var that=this;var vl=$("#volumeList");var curItem=vl.children().eq(index);var optValue=index>=0?curItem.val():vl.val();var loading=$(".chapter_list .loading");$("#chapterList").empty();if(pageload!=1)that.scrollTop();loading.show();var params={ajaxMethod:"getchapterlist",bookId:bookId,optValue:optValue};var callback=function(data){loading.hide();if(data.isSuccess){$("#chapterList").html(data.content);if(index>=0){curItem.attr("selected","selected");}
$("#selText").text($("#volumeList option:selected").text());}else{Common.ShowMessage(data.msg);}};that.ajax(params,callback);},getPage:function(bookId,type,pageload){var list=$("#volumeList").children();var count=list.length;var index=0;var optValue=$("#volumeList").val();var that=this;list.each(function(i){if(optValue===$(this).val()){index=i;return false;}});if(type===1&&index>0){index--;}else if(type===2&&index<(count-1)){index++;}
that.getChapterList(bookId,index,pageload);},reverse:function(tar,bookId){var that=this;that.Prop.isDesc=(that.Prop.isDesc===1?0:1);$(tar).text(that.Prop.isDesc?"顺序":"倒序");var index=0;if(that.Prop.isDesc===1){index=$("#volumeList").children().length-1;}
that.getChapterList(bookId,index);},scrollTop:function(){$("html,body").animate({scrollTop:$("#chpaterDirBox").offset().top},100);},switchTab:function(obj){$(obj).siblings().removeClass("hover");$(obj).addClass("hover");},scroll:function(contId,dotId){var width=$("#"+contId).width();var slide=new ScrollPic();slide.scrollContId=contId;slide.dotListId=dotId;slide.dotOnClassName="on";slide.frameWidth=width;slide.pageWidth=width;slide.speed=10;slide.space=30;slide.initialize();},listLink:function(obj){location.href=$(obj).find("a:first").attr("href");},descLink:function(obj){var a=$(obj).parent().prev().children("a:first");location.href=a.attr("href");},descSwitch:function(obj){$(obj).hide().siblings("p").show();},cancelPost:function(){$("#txtBody").val("写出你的精彩评论");},createPost:function(tar,bookId){var that=this;$(tar).attr("disabled","disabled");var body=$("#txtBody");var content=body.val().trim();if(!content||content==="写出你的精彩评论"){Common.ShowMessage("请填写帖子内容");$(tar).removeAttr("disabled");return false;}
if(content.length>2000){Common.ShowMessage("评论内容不能超出2000字");$(tar).removeAttr("disabled");return false;};content=content.replace(/</g,"&lt;");content=content.replace(/>/g,"&gt;");content=content.replace(/\+/g,"＋");content=that.replaceUnsafeKeyword(content);var params={ajaxMethod:"createpost",bookId:bookId,content:content};var callback=function(data){if(data.isSuccess===1){$("#postWrapper").prepend(data.content);$(tar).removeAttr("disabled");body.val("写出你的精彩评论");}else if(data.isSuccess===-1){Common.login();}else{Common.ShowMessage(data.msg);}};$.ajax({type:"post",url:"/ajax/bookex.ashx",data:params,dataType:"json",success:function(data){callback(data);},error:function(data){Common.ShowMessage("发表评论失败！");$(tar).removeAttr("disabled");}});},replaceUnsafeKeyword:function(text){var unsafeString="•";var regEx=new RegExp("("+unsafeString+")","gim");text=text.replace(regEx,"");unsafeString="&#\\d+";regEx=new RegExp("("+unsafeString+")","gim");return text.replace(regEx,function($1){return"&amp;#"+$1.substring(2);});},toggleNav:function(){var box=$("#bookNavBox");box.is(":visible")?box.hide():box.show();},scrollNew:function(contId,leftBtnId,rightBtnId){var width=$("#"+contId).width();var slide=new ScrollPic();slide.scrollContId=contId;slide.arrLeftId=leftBtnId;slide.arrRightId=rightBtnId;slide.enableTouch=false;slide.dotOnClassName="on";slide.frameWidth=width;slide.pageWidth=width;slide.speed=10;slide.space=30;slide.initialize();},getBookLabels:function(SearchKey,bookId){$.ajax({type:"get",url:"/ajax/top.ashx",data:{ajaxMethod:"getbookstorenew",key:SearchKey,showbook:1},dataType:"json",success:function(data){if(data&&data.Data&&data.Data.search_response&&data.Data.search_response.groupby&&data.Data.search_response.groupby.all&&data.Data.search_response.groupby.all.authortagid){var list=data.Data.search_response.groupby.all.authortagid;var html='<ul>';var i=0;for(var key in list){i++;if(i>6){break;}
html+='<li onclick="location.href=\'/book/booklabels.aspx?key={0}&bookid={2}\';"><a href="javascript:void(0);">{1}</a></li>'.format(encodeURIComponent(key),key,bookId);}
html+='</ul>';$("#booklabels").html(html);if(i==0){$("#booklabels").hide();}
else{$("#booklabels").show();}}},error:function(e){$("#booklabels").hide();}});}};window.BookEx=BookEx;})();