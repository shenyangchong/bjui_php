define("home/activities/comment",function(require,exports,module){var Doing=require("common/module/doing"),Comment=require("common/module/comment");require("component/prettify/prettify"),require("component/prettify/prettify.css"),Class({manualDoingEle:$("#manualDoing"),initial:function(){this.mineManualDoing=new Doing({url:Config.get("commentDoingPath"),tempData:{jumpPath:Config.get("jumpPath")},activeItemTpl:2,doingListEle:this.manualDoingEle,parseData:function(data){for(var i=0;i<data.length;i++)"content"in data[i]&&(data[i].content=Comment.replaceCode(data[i].content));return data},onAddDoingItem:function(item){prettyPrint()}}),this.manualDoingEle.delegate(".m-replace-code .code-placehoder","click",function(){var _content='<div class="m-code-view">';_content+=$(this).closest(".m-replace-code").find(".code-hide").html(),_content+="</div>",$.dialog(_content,{title:"查看代码",cache:"viewCode"})})}})}),define("home/activities/index",function(require,exports,module){var Doing=require("common/module/doing");Class({manualDoingEle:$("#manualDoing"),initial:function(){this.mineManualDoing=new Doing({url:Config.get("timelineDoingPath"),doingListEle:this.manualDoingEle,tempData:{jumpPath:Config.get("jumpPath")},onCreate:function(){}})}})}),define("home/activities/system",function(require,exports,module){var Doing=require("common/module/doing");Class({systemDoingListEle:$("#systemDoingList"),initial:function(){this.mineManualDoing=new Doing({url:Config.get("systemDoingPath"),tempData:{jumpPath:Config.get("jumpPath")},cls:"system",doingListEle:this.systemDoingListEle,activeItemTpl:3,onCreate:function(){}})}})}),define("home/auth/bind",function(require,exports,module){require("common/extend/validator/validator"),Class({authBindEle:$("#authBind"),loginFormEle:$("#loginForm"),registerFormEle:$("#registerForm"),registerAgreementEle:$("#registerAgreement"),bindTabEle:$("#bindTab"),initial:function(){var self=this;this.bindTabEle.find(".tab-navg .navg-item").click(function(){var _item=self.bindTabEle.find(".tab-item").eq($(this).index());$(this).addClass("active").siblings().removeClass("active"),_item.addClass("active").siblings().removeClass("active"),_item.find("form").clearValidate(),_item.find("input:first").focus(),$(this).index()?self.authBindEle.removeClass("auth-bind-login").addClass("auth-bind-register"):self.authBindEle.removeClass("auth-bind-register").addClass("auth-bind-login")}).eq(0).click(),this.loginVerifyImageEle=this.loginFormEle.find(".verity-code .code-image"),this.loginVerifyTextEle=this.loginFormEle.find(".verity-code .code-input :text"),this.loginFormEle.submitForm({autoValidate:!1,onAfter:function(data){data.status?($.dialog.success(data.info),self.synchroLogin(data.code,function(){location.replace(data.url)})):("string"==typeof data.info&&$.dialog.error(data.info),self.loginVerifyImageEle.click(),self.loginVerifyTextEle.val(""))}}),this.registerVerifyImageEle=this.registerFormEle.find(".verity-code .code-image"),this.registerVerifyTextEle=this.registerFormEle.find(".verity-code .code-input :text"),this.registerAgreementEle.click(function(){return $.dialog('<div class="m-agreement"><p>1. 条款接受<br/>译言网站（以下简称“译言网”）为北京译言协力传媒科技有限公司所独立拥有，译言网同意按照本协议的规定及其不时发布的操作规则提供基于互联网的相关服务(以下称"网络服务")。<br/>本用户协议所称的用户是指完全同意所有条款并完成注册程序或未经注册而使用译言网服务（以下简称“本服务”）的用户。用户在注册程序过程中点击"同意"按钮即表示用户完全接受本协议项下的全部条款。这些条款可由译言网域名所有者随时更新，本协议一旦发生变动，译言网将会在相关页面上提示修改内容。修改后的协议一旦在译言网站页面上公布即代替原来的协议并即时生效。用户可随时查阅最新协议。用户在使用译言网提供的各项服务之前，应仔细阅读本协议，如用户不同意本协议及/或译言网随时对其进行的修改，用户应主动放弃译言网提供的服务。</p><p>1. 条款接受<br/>译言网站（以下简称“译言网”）为北京译言协力传媒科技有限公司所独立拥有，译言网同意按照本协议的规定及其不时发布的操作规则提供基于互联网的相关服务(以下称"网络服务")。<br/>本用户协议所称的用户是指完全同意所有条款并完成注册程序或未经注册而使用译言网服务（以下简称“本服务”）的用户。用户在注册程序过程中点击"同意"按钮即表示用户完全接受本协议项下的全部条款。这些条款可由译言网域名所有者随时更新，本协议一旦发生变动，译言网将会在相关页面上提示修改内容。修改后的协议一旦在译言网站页面上公布即代替原来的协议并即时生效。用户可随时查阅最新协议。用户在使用译言网提供的各项服务之前，应仔细阅读本协议，如用户不同意本协议及/或译言网随时对其进行的修改，用户应主动放弃译言网提供的服务。</p><p>1. 条款接受<br/>译言网站（以下简称“译言网”）为北京译言协力传媒科技有限公司所独立拥有，译言网同意按照本协议的规定及其不时发布的操作规则提供基于互联网的相关服务(以下称"网络服务")。<br/>本用户协议所称的用户是指完全同意所有条款并完成注册程序或未经注册而使用译言网服务（以下简称“本服务”）的用户。用户在注册程序过程中点击"同意"按钮即表示用户完全接受本协议项下的全部条款。这些条款可由译言网域名所有者随时更新，本协议一旦发生变动，译言网将会在相关页面上提示修改内容。修改后的协议一旦在译言网站页面上公布即代替原来的协议并即时生效。用户可随时查阅最新协议。用户在使用译言网提供的各项服务之前，应仔细阅读本协议，如用户不同意本协议及/或译言网随时对其进行的修改，用户应主动放弃译言网提供的服务。</p><p>1. 条款接受<br/>译言网站（以下简称“译言网”）为北京译言协力传媒科技有限公司所独立拥有，译言网同意按照本协议的规定及其不时发布的操作规则提供基于互联网的相关服务(以下称"网络服务")。<br/>本用户协议所称的用户是指完全同意所有条款并完成注册程序或未经注册而使用译言网服务（以下简称“本服务”）的用户。用户在注册程序过程中点击"同意"按钮即表示用户完全接受本协议项下的全部条款。这些条款可由译言网域名所有者随时更新，本协议一旦发生变动，译言网将会在相关页面上提示修改内容。修改后的协议一旦在译言网站页面上公布即代替原来的协议并即时生效。用户可随时查阅最新协议。用户在使用译言网提供的各项服务之前，应仔细阅读本协议，如用户不同意本协议及/或译言网随时对其进行的修改，用户应主动放弃译言网提供的服务。</p><p>1. 条款接受<br/>译言网站（以下简称“译言网”）为北京译言协力传媒科技有限公司所独立拥有，译言网同意按照本协议的规定及其不时发布的操作规则提供基于互联网的相关服务(以下称"网络服务")。<br/>本用户协议所称的用户是指完全同意所有条款并完成注册程序或未经注册而使用译言网服务（以下简称“本服务”）的用户。用户在注册程序过程中点击"同意"按钮即表示用户完全接受本协议项下的全部条款。这些条款可由译言网域名所有者随时更新，本协议一旦发生变动，译言网将会在相关页面上提示修改内容。修改后的协议一旦在译言网站页面上公布即代替原来的协议并即时生效。用户可随时查阅最新协议。用户在使用译言网提供的各项服务之前，应仔细阅读本协议，如用户不同意本协议及/或译言网随时对其进行的修改，用户应主动放弃译言网提供的服务。</p><p>1. 条款接受<br/>译言网站（以下简称“译言网”）为北京译言协力传媒科技有限公司所独立拥有，译言网同意按照本协议的规定及其不时发布的操作规则提供基于互联网的相关服务(以下称"网络服务")。<br/>本用户协议所称的用户是指完全同意所有条款并完成注册程序或未经注册而使用译言网服务（以下简称“本服务”）的用户。用户在注册程序过程中点击"同意"按钮即表示用户完全接受本协议项下的全部条款。这些条款可由译言网域名所有者随时更新，本协议一旦发生变动，译言网将会在相关页面上提示修改内容。修改后的协议一旦在译言网站页面上公布即代替原来的协议并即时生效。用户可随时查阅最新协议。用户在使用译言网提供的各项服务之前，应仔细阅读本协议，如用户不同意本协议及/或译言网随时对其进行的修改，用户应主动放弃译言网提供的服务。</p><p>1. 条款接受<br/>译言网站（以下简称“译言网”）为北京译言协力传媒科技有限公司所独立拥有，译言网同意按照本协议的规定及其不时发布的操作规则提供基于互联网的相关服务(以下称"网络服务")。<br/>本用户协议所称的用户是指完全同意所有条款并完成注册程序或未经注册而使用译言网服务（以下简称“本服务”）的用户。用户在注册程序过程中点击"同意"按钮即表示用户完全接受本协议项下的全部条款。这些条款可由译言网域名所有者随时更新，本协议一旦发生变动，译言网将会在相关页面上提示修改内容。修改后的协议一旦在译言网站页面上公布即代替原来的协议并即时生效。用户可随时查阅最新协议。用户在使用译言网提供的各项服务之前，应仔细阅读本协议，如用户不同意本协议及/或译言网随时对其进行的修改，用户应主动放弃译言网提供的服务。</p><p>1. 条款接受<br/>译言网站（以下简称“译言网”）为北京译言协力传媒科技有限公司所独立拥有，译言网同意按照本协议的规定及其不时发布的操作规则提供基于互联网的相关服务(以下称"网络服务")。<br/>本用户协议所称的用户是指完全同意所有条款并完成注册程序或未经注册而使用译言网服务（以下简称“本服务”）的用户。用户在注册程序过程中点击"同意"按钮即表示用户完全接受本协议项下的全部条款。这些条款可由译言网域名所有者随时更新，本协议一旦发生变动，译言网将会在相关页面上提示修改内容。修改后的协议一旦在译言网站页面上公布即代替原来的协议并即时生效。用户可随时查阅最新协议。用户在使用译言网提供的各项服务之前，应仔细阅读本协议，如用户不同意本协议及/或译言网随时对其进行的修改，用户应主动放弃译言网提供的服务。</p></div>',{title:"ThinkPHP云手册服务条款"}),!1}),this.registerFormEle.submitForm({autoValidate:!1,onAfter:function(data){data.status?$.dialog.success(data.info,function(){data.url&&(location.href=data.url)}):("string"==typeof data.info&&$.dialog.error(data.info),self.registerVerifyImageEle.click(),self.registerVerifyTextEle.val(""))}})},synchroLogin:function(urls,callback){var _urls=$.isArray(urls)?urls:[urls],_funs=[],_mask=0;$.each(_urls,function(_index,_value){"string"==typeof _value&&_funs.push(function(){$.ajax({url:_value,dataType:"jsonp",complete:function(){++_mask,_mask<_funs.length?_funs[_mask]():$.isFunction(callback)&&callback()}})})}),_funs.length?_funs[_mask]&&_funs[_mask]():$.isFunction(callback)&&callback()}})}),define("home/auth/complete",function(require,exports,module){Class({completeFormEle:$("#completeForm"),initial:function(){this.completeFormEle.submitForm({onAfter:function(data){data.status?data.url?location.replace(data.url):location.reload():"string"==typeof data.info&&$.dialog.error(data.info)}})}})}),define("home/auth/forgot",function(require,exports,module){require("common/extend/validator/validator"),Class({forgotFormEle:$("#forgotForm"),initial:function(){var self=this;this.verifyImageEle=this.forgotFormEle.find(".verity-code .code-image"),this.verifyTextEle=this.forgotFormEle.find(".verity-code .code-input :text"),this.forgotFormEle.submitForm({autoValidate:!1,onAfter:function(data){data.status?$.dialog.success(data.info,{time:3e3,onClose:function(){location.replace(data.url)}}):("string"==typeof data.info&&$.dialog.error(data.info),self.verifyImageEle.click(),self.verifyTextEle.val(""))}}),this.forgotFormEle.find("input:first").focus()}})}),define("home/auth/login",function(require,exports,module){require("common/extend/validator/validator"),Class({loginFormEle:$("#loginForm"),keepLoginEle:$(':checkbox[name="is_auto"]'),cooperateEle:$(".auth-cooperate .cooperate-list .item"),initial:function(){var self=this;this.verifyImageEle=this.loginFormEle.find(".verity-code .code-image"),this.verifyTextEle=this.loginFormEle.find(".verity-code .code-input :text"),this.loginFormEle.submitForm({autoValidate:!1,onAfter:function(data){data.status?($.dialog.success(data.info),self.synchroLogin(data.code,function(){location.replace(data.url)})):("string"==typeof data.info&&$.dialog.error(data.info),self.verifyImageEle.click(),self.verifyTextEle.val(""))}}),this.loginFormEle.find("input:first").focus(),this.loginFormEle.delegate(".field-msg a","click",function(){var _ele=$(this),_text=_ele.text(),_input=_ele.closest(".form-item").find(":text");_ele.hasClass("loading")||(_ele.addClass("loading"),_ele.text("邮件发送中..."),_input.click(),$.dialog.loading("正在发送帐号激活邮件"),$.get(_ele.data("href"),function(data){data.status?$.dialog.success(data.info,{time:3e3}):$.dialog.error(data.info),$.dialog.get("loading").close(),_ele.removeClass("loading"),_ele.text(_text)}))}),$.each(this.cooperateEle,function(){$(this).data("href")||$(this).data("href",$(this).attr("href"))}),this.keepLoginEle.click(function(){self.findKeepLogin($(this).is(":checked"))}),this.findKeepLogin(this.keepLoginEle.is(":checked"))},synchroLogin:function(urls,callback){var _urls=$.isArray(urls)?urls:[urls],_funs=[],_mask=0;$.each(_urls,function(_index,_value){"string"==typeof _value&&_funs.push(function(){$.ajax({url:_value,dataType:"jsonp",complete:function(){++_mask,_mask<_funs.length?_funs[_mask]():$.isFunction(callback)&&callback()}})})}),_funs.length?_funs[_mask]&&_funs[_mask]():$.isFunction(callback)&&callback()},findKeepLogin:function(status){var _value=this.keepLoginEle.val();$.each(this.cooperateEle,function(){var _href=$(this).data("href");status?$(this).attr("href",_href+(_href.indexOf("?")>=0?"&":"?")+"is_auto="+_value):$(this).attr("href",_href)})}})}),define("home/auth/register",function(require,exports,module){require("common/extend/validator/validator"),Class({registerFormEle:$("#registerForm"),initial:function(){var self=this;this.verifyImageEle=this.registerFormEle.find(".verity-code .code-image"),this.verifyTextEle=this.registerFormEle.find(".verity-code .code-input :text"),this.registerFormEle.submitForm({autoValidate:!1,onAfter:function(data){data.status?$.dialog.success(data.info,function(){data.url&&(location.href=data.url)}):("string"==typeof data.info&&$.dialog.error(data.info),self.verifyImageEle.click(),self.verifyTextEle.val(""))}}),this.registerFormEle.find("input:first").focus()}})}),define("home/auth/reset",function(require,exports,module){require("common/extend/validator/validator"),Class({resetFormEle:$("#resetForm"),initial:function(){var self=this;this.verifyImageEle=this.resetFormEle.find(".verity-code .code-image"),this.verifyTextEle=this.resetFormEle.find(".verity-code .code-input :text"),this.resetFormEle.submitForm({autoValidate:!1,onAfter:function(data){data.status?$.dialog.success(data.info,function(){location.replace(data.url)}):("string"==typeof data.info&&$.dialog.error(data.info),self.verifyImageEle.click(),self.verifyTextEle.val(""))}}),this.resetFormEle.find("input:first").focus()}})}),define("home/book/domain/update",function(require,exports,module){return require("common/extend/validator/validator"),require("component/jquery.form"),Class({manualUpdateFormEle:$("#manualUpdateForm"),initial:function(){this.manualUpdateFormEle.submitForm({autoValidate:!1,onAfter:function(data){data.status?$.dialog.success(data.info):$.dialog.error(data.info)}})}})}),define("home/book/edit",function(require,exports,module){require("component/jstree/dist/jstree.js"),require("component/jstree/dist/themes/default/style.min.css");var editor=require("editor/script/editor"),Template=require("common/extend/template");return Class({_options:{manualElement:null,manualTabElement:null,editorElement:null,catalogElement:null,addCatalogBtnElement:null,catalogData:[],catalogHash:null,manualId:null,saveArticleContentUrl:null,getArticleDataUrl:null,deleteCatalogUrl:null,createCatalogUrl:null,updateCatalogUrl:null,saveCatalogSortUrl:null,uploadImageUrl:null,downloadImageUrl:null,downloadImageHost:null,checkManualStatusUrl:null,getHistoryUrl:null,getCommitUrl:null,resetUrl:null,configUrl:null,manualStatus:1},currentArticleId:null,currentArticleHash:null,isImportComplete:function(status,url,data,callback){var _self=this,_arguments=arguments;switch(status){case 2:$.ajax({url:url,type:"get",data:data,success:function(data){1==data.status?$.isFunction(callback)&&callback.call(_self):2==data.status?setTimeout(function(){_self.isImportComplete.apply(_self,_arguments)},6e3):window.location.reload()}});break;case 3:return!1;default:$.isFunction(callback)&&callback.call(_self)}},initial:function(options){Config.del("checkNotification");var self=this;this.options=$.extend({},this._options,options),this.isImportComplete(this.options.manualStatus,this.options.checkManualStatusUrl,{book_id:this.options.manualId},function(){return this.manualElement=this.options.manualElement,this.getEditor(),this.catalogElement=this.options.catalogElement,this.catalogElement&&this.catalogElement.length&&$.isNumeric(this.options.manualId)?(this.manualId=this.options.manualId,self.lastArticleId=this.getIdFromLocal(),self.lastArticleContent=this.getContentFromLocal(),this.treeCatalog=this.catalogElement.jstree({core:{check_callback:!0,data:this.options.catalogData},plugins:["wholerow","dnd","contextmenu"],dnd:{inside_pos:"last",large_drag_target:!0,large_drop_target:!0,copy:!1},contextmenu:{show_at_node:!1,select_node:!1,items:{create:{separator_before:!1,separator_after:!0,_disabled:!1,label:"新建章节",action:function(data){var inst=$.jstree.reference(data.reference),node=inst.get_node(data.reference);self.openCreateCatalogDialog(node.id)},icon:"icon icon-plus2"},edit:{separator_before:!1,separator_after:!0,_disabled:!1,label:"编辑",action:function(data){var inst=$.jstree.reference(data.reference),node=inst.get_node(data.reference);self.openUpdateCatalogDialog(node.id)},icon:"icon icon-mode-edit"},remove:{separator_before:!1,separator_after:!0,_disabled:!1,label:"删除",action:function(data){var inst=$.jstree.reference(data.reference),node=inst.get_node(data.reference);$.dialog.confirm("确定删除目录吗？",function(action){1==action&&self.deleteCatalog(node.id,node.text)})},icon:"icon icon-trash-o"}}}}).jstree(),this.catalogElement.bind("loaded.jstree",function(){if(self.options.addCatalogBtnElement&&self.options.addCatalogBtnElement.click(function(){self.openCreateCatalogDialog(0)}),!self.findArticleIsEmpty()){var _mask="#"+(self.lastArticleId||"").toString(),_node=self.treeCatalog.get_node(_mask),_child=null;_node&&null!==_node.parent||(_child=self.treeCatalog.get_children_dom("#"),_child[0]&&(_node=self.treeCatalog.get_node(_child[0]))),_node&&self.treeCatalog.select_node(_node)}}),this.catalogElement.bind("redraw.jstree",function(){self.treeCatalog.get_container_ul().delegate(".jstree-anchor","click",function(event){self.treeCatalog.trigger("before_select_node.jstree",{event:event,reference:$(this).closest(".jstree-node")})})}),this.catalogElement.bind("select_node.jstree",function(event,data){data.selected!==self.currentArticleId&&self.editTargetArticle(data.selected[0])}),this.catalogElement.bind("before_select_node.jstree",function(event,data){self.getEditor().isChanged()&&(data.event.stopPropagation(),$.dialog.confirm("确定要取消编辑吗？",function(action){if(1==action){var _node=self.treeCatalog.get_node(data.reference);_node&&(self.treeCatalog.deselect_all(!0),self.treeCatalog.select_node(_node))}}))}),$(document).bind("dnd_stop.vakata",function(event,data){setTimeout(function(){self.saveCatalogSort()},0)}),$(window).on("beforeunload",function(event){return self.getEditor().isChanged()?"确定取消编辑吗？":void 0}),$(".m-manual").show(),void $("#pageLoading").remove()):!1})},getArticleData:function(id,callback){if("string"!=$.type(this.options.getArticleDataUrl)||"undefined"==typeof this.manualId)return!1;var _id=id;$.dialog.loading("数据加载中!"),this._getArticleContentAjax&&this._getArticleContentAjax.abort(),this._getArticleContentAjax=$.ajax({url:this.options.getArticleDataUrl,type:"post",context:this,data:{id:_id,book_id:this.manualId},success:function(data){data.status?$.isFunction(callback)&&callback.call(this,data.data):$.dialog.error(data.info)},complete:function(){$.dialog.get("loading").close()}})},editTargetArticle:function(id){var _self=this;this.getArticleData(id,function(data){this.currentArticleId=id,this.currentArticleHash=data.hash,this.setEditorContent(data.content),_self.lastArticleContent&&(_self.lastArticleContent!=data.content&&(_self.getEditor().setValue(_self.lastArticleContent),this._cacheTiper=$(['<div class="manual-cache-tiper">','<div class="tiper-content">这是你上次未保存的数据，<a class="revoke">[撤销]</a></div>',"</div>"].join("")),this._cacheTiper.appendTo(this.manualElement.find(".manual-editor")).find(".revoke").click(function(){_self.getEditor().setValue(data.content)})),delete _self.lastArticleContent),this.saveIdToLocal(id)})},saveArticleContent:function(id,content,force,callback){var self=this;return"string"==$.type(this.options.saveArticleContentUrl)&&this.getEditor().isChanged()?($.dialog.loading("文章保存中..."),this._saveArticleContentAjax&&this._saveArticleContentAjax.abort(),void(this._saveArticleContentAjax=$.ajax({url:this.options.saveArticleContentUrl,type:"post",context:this,data:{id:id,title:this.getCurrentArticleTitle(),content:content,book_id:this.manualId,hash:this.currentArticleHash,force:force?1:0},success:function(data){1===data.status?(self.getEditor().reset(),self.currentArticleHash=data.hash,self.saveContentToLocal(null),self._cacheTiper&&(self._cacheTiper.remove(),delete self._cacheTiper),$.isFunction(callback)&&callback.call(this,data)):2===data.status?$.dialog.confirm("本章节在你打开之后已经被其他人修改过了，直接覆盖吗？",function(action){1==action&&self.saveArticleContent(id,content,!0,callback)}):$.dialog.error(data.info)},complete:function(){$.dialog.get("loading").close()}}))):!1},getCurrentArticleTitle:function(){var _title="";if(this.currentArticleId&&this.treeCatalog){var _node=this.treeCatalog.get_node(this.currentArticleId);if(_node)return _node.text}return _title},_getCatalogEditTemp:function(){var _catalogEditTemp=$(['<div class="m-manual-add">','<form class="w-form form-horizon dialog-form" method="post">','<div class="form-item">','<span class="form-label"><i class="form-must">*</i>目录标题</span>','<div class="form-target">','<label class="w-text text-m text-full">','<input class="text-input" type="text" name="title" />',"</label>","</div>","</div>",'<div class="form-item">','<span class="form-label"><i class="form-must">*</i>对应文件</span>','<div class="form-target">','<label class="w-text text-m text-full">','<input class="text-input" type="text" name="file" />','<input name="book_id" type="hidden" value="'+this.manualId+'"/>',"</label>",'<p class="field-msg w-fragment fragment-s fragment-tip">输入路径创建一个新目录和任何必要的子目录<br />例如："test/myfile.md"<br /><strong>文件后缀代表文件类型</strong><br />目前仅支持md(MarkDown),html类型的解析，其他类型原样输出</p>',"</div>","</div>",'<input type="submit" style="display: none;" />',"</form>","</div>"].join(""));return _catalogEditTemp},openUpdateCatalogDialog:function(id){var self=this,node=null;if(node=this.treeCatalog.get_node("#"+id),!node)return!1;var dialog=$.dialog.form(this._getCatalogEditTemp(),{title:"更新目录",onCreate:function(){var _form=this.bodyElement.find("form");_form.append($('<input type="hidden" name="id" value="'+id+'">')),_form.attr("action",self.options.updateCatalogUrl),_form.find(":text[name=title]").val(Util.HTMLDeCode(node.text)).focus(),_form.find(":text[name=file]").val(node.id),_form.submitForm({onBefore:function(options){var file=options.data.file.trim().replace(/\/\s+/g,"/"),pathinfo=Util.pathinfo(file),data={id:file,text:Util.HTMLEnCode(options.data.title),name:pathinfo.name,ext:pathinfo.ext};if(""===data.id||""===data.name||""===data.text)return $.dialog.error("目录标题和对应文件均不能为空"),!1;if(data.id!==node.id){var _node=self.treeCatalog.get_node(data.id);if(_node)return $.dialog.error("文件名称已存在"),!1}return data.id===node.id&&data.text===node.text?(dialog.close(),!1):(self.localUpdateCatalog(node,data),options.data.new_id=data.id,options.data.summary=JSON.stringify(self.treeCatalog.get_json(null,{no_state:!0,no_data:!0})),void(options.data.hash=self.options.catalogHash))},onAfter:function(data,options){data.status?(self.currentArticleId==options.data.id&&(self.currentArticleId=options.data.new_id,self.saveIdToLocal(self.currentArticleId)),$.dialog.success(data.info),self.options.catalogHash=data.hash):self.setCatalogError(data.info),dialog.close()}})}})},openCreateCatalogDialog:function(pid){var self=this,dialog=$.dialog.form(this._getCatalogEditTemp(),{title:"创建目录",onCreate:function(){var _form=this.bodyElement.find("form");_form.attr("action",self.options.createCatalogUrl),_form.find(":text[name=title]").on("keyup",function(){_form.find(":text[name=file]").val($(this).val().trim().replace(/\//g,"-")+".md")}),_form.find(":text[name=title]").focus(),_form.append($('<input type="hidden" name="pid" value="'+pid+'">')),_form.submitForm({onBefore:function(options){var file=options.data.file.trim().replace(/\/\s+/g,"/"),pathinfo=Util.pathinfo(file),data={id:file,text:Util.HTMLEnCode(options.data.title),name:pathinfo.name,ext:pathinfo.ext};if(""===data.id||""===data.name||""===data.text)return $.dialog.error("目录标题和对应文件均不能为空"),!1;var node=self.treeCatalog.get_node(data.id);return node?($.dialog.error("文件名称已存在"),!1):(self.localCreateCatalog(pid,data),options.data.id=data.id,options.data.summary=JSON.stringify(self.treeCatalog.get_json(null,{no_state:!0,no_data:!0})),void(options.data.hash=self.options.catalogHash))},onAfter:function(data,options){var node=self.treeCatalog.get_node(options.data.id);data.status?(node&&(self.treeCatalog.deselect_all(!0),self.treeCatalog.select_node(node)),$.dialog.success(data.info),self.findArticleIsEmpty(),self.options.catalogHash=data.hash):self.setCatalogError(data.info),dialog.close()}})}})},localCreateCatalog:function(pid,data,callback){if(!data||!this.treeCatalog)return!1;var _mask=0==pid?"#":"#"+pid,_node=this.treeCatalog.create_node(_mask,data,"last");return $.isFunction(callback)&&callback.call(this,_node),_node},localUpdateCatalog:function(node,data){return data&&this.treeCatalog?(node.original=data,this.treeCatalog.rename_node(node,data.text),this.treeCatalog.set_id(node,data.id),node):!1},deleteCatalog:function(id,title,callback){if("string"!=$.type(this.options.deleteCatalogUrl)||!title||!this.treeCatalog)return!1;$.dialog.loading("目录删除中...");var _node=this.treeCatalog.get_node(id),nodes=JSON.stringify(this.treeCatalog.get_json(_node,{no_state:!0,no_data:!0}));if(_node){var _targetDom=this.treeCatalog.get_next_dom(_node),_targetNode=null;_targetDom.length||(_targetDom=this.treeCatalog.get_prev_dom(_node)),this.treeCatalog.delete_node(_node),_targetDom.length&&this.currentArticleId==id&&(_targetNode=this.treeCatalog.get_node(_targetDom),this.treeCatalog.select_node(_targetNode))}var summary=JSON.stringify(this.treeCatalog.get_json(null,{no_state:!0,no_data:!0}));$.ajax({url:this.options.deleteCatalogUrl,data:{nodes:nodes,book_id:this.manualId,title:title,summary:summary,hash:this.options.catalogHash},context:this,type:"post",success:function(data){data.status?(this.options.catalogHash=data.hash,this.findArticleIsEmpty(),$(this).trigger("deleteCatalog",id)):this.setCatalogError(data.info)},complete:function(){$.dialog.get("loading").close()}})},saveCatalogSort:function(callback){if(!this.treeCatalog||!this.options.saveCatalogSortUrl)return!1;var summary=JSON.stringify(this.treeCatalog.get_json(null,{no_state:!0,no_data:!0}));$.dialog.loading("保存排序中..."),$.ajax({url:this.options.saveCatalogSortUrl,data:{summary:summary,book_id:this.manualId,hash:this.options.catalogHash},context:this,type:"post",success:function(data){data.status?(this.options.catalogHash=data.hash,$.dialog.success(data.info)):this.setCatalogError(data.info)},complete:function(){$.dialog.get("loading").close()}})},setCatalogError:function(msg){this.options.catalogElement.hide(),this.options.catalogElement.next(".catalog-error").text(msg).show()},getEditor:function(){var self=this;if(!this._editor){var _editorHtml=$(['<div class="manual-editor">',"<textarea></textarea>","</div>",'<div class="manual-editor-status"><div class="filename"></div><div class="pull-right"></div></div>'].join("")),_textarea=_editorHtml.find("textarea");this.options.editorElement&&this.options.editorElement.append(_editorHtml),this._editor=editor(_textarea,{items:"save,-,undo,redo,-,h1,h2,h3,h4,-,bold,italic,-,ul,ol,-,link,image,code,hr,blockquote,table,htmlpaste,toc,-,sidebar,preview,history,help,more",uploader:{url:this.options.uploadImageUrl,callback:function(status,msg){status||$.dialog.error(msg)}},statusBar:_editorHtml[1],preview:!0,lang:{sidebar:"边栏",toc:"章节导航",history:"历史记录",htmlpaste:"粘贴HTML"},tools:{sidebar:{exec:function(){self.manualElement.hasClass("manual-fullscreen")?(self.manualElement.removeClass("manual-fullscreen"),this.getToolbar("sidebar").addClass("active")):(self.manualElement.addClass("manual-fullscreen"),this.getToolbar("sidebar").removeClass("active")),this.$ace.resize()},init:function(){this.getToolbar("sidebar").addClass("active")}},toc:{exec:function(){this.insert("\n[TOC]\n")},init:function(){var editor=this;this.preview.on("click","ul.markdown-toc-list a",function(e){e.stopImmediatePropagation();var id=$(this).attr("href");return editor.preview.animate({scrollTop:$(id).offset().top-60},500),!1})},markdown:!0},history:{exec:function(){var _html='<div class="dialog-history"><div class="history-commits"><div class="history-commits-title"><span class="commits-count">0</span> 条修改记录</div><div class="history-commits-inner"><ul class="commits-list"></ul></div></div><div class="history-commit-details"></div></div>';_html=$(_html);var commitTemp='<li data-hash="<%=hash%>" class="commit"><div class="commit-avatar"><img src="<%=avatar%>"></div><div class="commit-message"><%=message%></div><div class="commit-meta"><%=date%> by <%=author%></div></li>',dialog=$.dialog(_html,{button:[function(){var _self=this,cancelBtn=$('<label class="w-btn btn-default btn-m"><button class="btn-input">关闭</button></label>');return cancelBtn.click(function(){_self.close()}),cancelBtn}],style:"think-dialog-form",drag:!1,close:!1,onCreate:function(){var _total=$(".commits-count",_html),_list=$(".commits-list",_html),_detail=$(".history-commit-details",_html),currentHash=null;_list.on("click","li",function(){$(this).siblings(".active").removeClass("active"),$(this).addClass("active");var hash=$(this).data("hash");return hash==currentHash?!1:void self.getArticleCommit(hash,function(data){currentHash=hash,_detail.html(data)})}),_detail.on("click",".reset",function(){var hash=$(this).data("hash");$.dialog.confirm("确定要恢复当前章节至此版本吗？",function(action){1==action&&($.dialog.loading("章节恢复中..."),$.ajax({url:self.options.resetUrl,data:{book_id:self.manualId,path:self.currentArticleId,title:self.getCurrentArticleTitle(),hash:hash},context:this,type:"post",success:function(data){1==data.status?self.getArticleData(self.currentArticleId,function(data){self.currentArticleHash=data.hash,self.setEditorContent(data.content),dialog.close()}):($.dialog.get("loading").close(),$.dialog.error(data.info))}}))})});var offset=0;self.getArticleHistory(self.currentArticleId,offset,function(data){_total.text(data.total),$.each(data.list,function(k,v){_list.append(Template.parseTemp(commitTemp,v))}),0===offset&&$("li",_list).first().click()})}})}},htmlpaste:{exec:function(){var editor=this;require.async("component/to-markdown/dist/to-markdown",function(){var $text,$iframe,$html,doc,dialog,ie=navigator.userAgent.toLowerCase().indexOf("msie")>-1&&-1==navigator.userAgent.toLowerCase().indexOf("opera"),downloadAjax;$text=$("<p />").text("请使用快捷键(Ctrl+V)把内容粘贴到下面的方框里。"),$iframe=$('<iframe frameborder="0" style="width:600px;height:260px;padding: 5px;"></iframe>'),$html=$("<div/>").addClass("thinkeditor-plugin-htmlpaste").append($text).append($iframe),dialog=$.dialog.open($html,{title:"从HTML粘贴",onCancel:function(){$.dialog.get("loading").close(),downloadAjax&&downloadAjax.abort()},onOk:function(){$.dialog.get("loading").close(),downloadAjax&&downloadAjax.abort();var str=doc.body.innerHTML;str=str.replace(/~/g,"~T"),str=str.replace(/`/g,"~E"),str=str.replace(/\$/g,"~D"),str=toMarkdown(str,{gfm:!0});var cnum=0,arrcode=[];str=str.replace(/~~~([\s\S]*?)~~~/g,function(all){return cnum++,arrcode[cnum]=all,"[	codeplace_"+cnum+"	]"}),str=str.replace(/(`+)([^\r]*?[^`])\1(?!`)/g,function(wholeMatch,m1,m2,m3){return cnum++,arrcode[cnum]=wholeMatch,"[	codeplace_"+cnum+"	]"}),str=str.replace(/<\/?.+?>/g,""),str=str.replace(/\n{2,}/g,"\n\n");for(var i=1;cnum>=i;i++)str=str.replace("[	codeplace_"+i+"	]",function(){return arrcode[i]});str=str.replace(/~D/g,"$$"),str=str.replace(/~E/g,"`"),str=str.replace(/~T/g,"~"),editor.insert(str),dialog.close()}});var $localImageBtn=$('<label class="w-btn btn-m btn-success pull-left"><button class="btn-input" type="button">图片本地化</button></label>');$localImageBtn.click(function(){if("undefined"!=typeof $(this).attr("disabled"))return!1;var html=doc.body.innerHTML,reg=/<img\b[^>]*\ssrc\s*=\s*(["'])([^>'"]*)\1[^>]*>/gi,images=[];html.replace(reg,function(str,match1,match2){return match2.match(/^(https?:\/\/|\.)/i)&&-1===match2.indexOf(self.options.downloadImageHost)&&images.push(match2),str});var total=images.length,i=0,downloader=function(){if(images.length>0){var image=images.shift(),data={url:image};i++,$.dialog.get("loading").content("远程图片下载中…… ("+i+"/"+total+")","success"),downloadAjax=$.post(self.options.downloadImageUrl,data,function(result){html=html.replace(eval("/"+result.info.old_src.replace(/\//g,"\\/").replace(/\?/g,"\\?")+"/g"),result.info.new_src),doc.body.innerHTML=html,downloader()})}else $.dialog.get("loading").close(),$localImageBtn.removeAttr("disabled")};total>0?($.dialog.loading("远程图片下载中……"),downloader(),$localImageBtn.attr("disabled","disabled")):$.dialog.error("没有远程图片")}),dialog.footElement.append($localImageBtn),doc=$iframe[0].contentDocument||$iframe[0].contentWindow.document,ie||(doc.designMode="on"),doc.open(),doc.write('<!doctype html><html style="height:100%;"><head><title>WordPaste</title></head>'),doc.write('<body style="background-color:#ffffff;font-size:12px;padding:0px;margin:0px;height: 100%;">'),ie||doc.write("<br />"),doc.write("</body></html>"),doc.close(),ie&&(doc.body.contentEditable="true"),$iframe[0].contentWindow.focus()})},markdown:!0},more:{exec:function(){this.toolMore.toggle(),this.getToolbar("more").toggleClass("active")},init:function(){var _dropWrap=$('<div class="tools-more"><ul class="w-menu"><li class="menu-item"><a class="menu-link setting" href="javascript:;"><i class="icon icon-cog"></i> 文档配置</a></li></ul></div>'),editor=this;self.manualElement.append(_dropWrap),this.toolMore=_dropWrap,$("body").on("click",function(){editor.getToolbar("more").removeClass("active"),_dropWrap.hide()}),_dropWrap.on("click",".setting",function(){var dialog,$html=$('<div class="thinkeditor-plugin-more-setting" style="width: 600px;height: 300px"></div>'),$ace=ace.edit($html[0]);$ace.getSession().setMode("ace/mode/json"),$ace.$blockScrolling=1/0,$.dialog.loading("读取配置中..."),$.get(self.options.configUrl,{book_id:self.manualId},function(data){$.dialog.get("loading").close(),dialog=$.dialog.open($html,{title:"文档设置",onOk:function(){data.write&&($.dialog.loading("保存配置中..."),$.post(self.options.configUrl,{book_id:self.manualId,config:$ace.getValue()},function(){$.dialog.get("loading").close()})),dialog.close()}}),$ace.setValue(data.config),data.write||$ace.setReadOnly(!0)})})}},save:{bindKey:{win:"ctrl+s",mac:"command+s"},exec:function(){self.saveArticleContent(self.currentArticleId,self.getEditorContent(),!1)},init:function(){var editor=this;this.getToolbar("save").attr("disabled","disabled").removeClass("warning"),this.$ace.on("change",function(){editor.isChanged()?editor.getToolbar("save").removeAttr("disabled","disabled").addClass("warning"):editor.getToolbar("save").attr("disabled","disabled").removeClass("warning");
})}}}}),this._editor.$ace.on("change",function(){self._cacheTiper&&(self._cacheTiper.remove(),delete self._cacheTiper),setTimeout(function(){self.saveContentToLocal(self.getEditor().isChanged()?self._editor.getValue():null)},0)})}return this._editor},getArticleHistory:function(path,offset,callback){$.dialog.loading("获取历史记录中..."),this._getArticleHistoryAjax&&this._getArticleHistoryAjax.abort(),this._getArticleHistoryAjax=$.ajax({url:this.options.getHistoryUrl,data:{book_id:this.manualId,path:path,offset:offset},context:this,type:"get",success:callback,complete:function(){$.dialog.get("loading").close()}})},getArticleCommit:function(hash,callback){$.dialog.loading("获取提交信息中..."),this._getArticleCommitAjax&&this._getArticleCommitAjax.abort(),this._getArticleCommitAjax=$.ajax({url:this.options.getCommitUrl,data:{book_id:this.manualId,hash:hash},context:this,type:"get",success:callback,complete:function(){$.dialog.get("loading").close()}})},setEditorContent:function(content){var _editor=this.getEditor();if(_editor){var mode,node=this.treeCatalog.get_node(this.currentArticleId),type=node.original.ext;switch(type){case"md":mode="markdown";break;case"htm":case"xhtml":case"html":mode="html";break;default:mode="text"}this.options.editorElement.find(".manual-editor-status .filename").text(node.original.id),_editor.setMode(mode),_editor.setValue(content),_editor.reset()}return this},getEditorContent:function(){var _editor=this.getEditor();return _editor?_editor.getValue():void 0},findArticleIsEmpty:function(){var _status=!1;if(this.treeCatalog){if(_status=this.treeCatalog.get_json().length?!1:!0){if(this.manualElement){var _html="";_html+='<div class="manual-empty-message">',_html+='<div class="inner">',_html+="<h3>文档还没有目录，赶紧添加吧！</h3>",_html+="</div>",_html+="</div>",this.emptyEle=$(_html),this.manualElement.find(".manual-body").append(this.emptyEle),this.manualElement.addClass("manual-empty")}}else this.manualElement&&(this.manualElement.removeClass("manual-empty"),this.emptyEle&&(this.emptyEle.remove(),delete this.emptyEle));$(this).trigger("empty",_status)}return _status},saveIdToLocal:function(id){window.localStorage&&localStorage.setItem("kancloud-manual-"+this.manualId+"-id",id)},saveContentToLocal:function(content){window.localStorage&&(null===content?localStorage.removeItem("kancloud-manual-"+this.manualId+"-content"):localStorage.setItem("kancloud-manual-"+this.manualId+"-content",content))},getContentFromLocal:function(){return window.localStorage?localStorage.getItem("kancloud-manual-"+this.manualId+"-content"):void 0},getIdFromLocal:function(){return window.localStorage?localStorage.getItem("kancloud-manual-"+this.manualId+"-id"):void 0},instantiation:!1})}),define("home/book/history/detail",function(require,exports,module){Class({resetHistoryEle:$("#resetHistory"),initial:function(){this.resetHistoryEle.click(function(){$.dialog.confirm("确定文档回滚至此版本吗？回滚后，该版本之后的所有的修改记录将丢失。",function(action){1==action&&($.dialog.loading("文档回滚中..."),$.ajax({url:Config.get("resetUrl"),data:{book_id:Config.get("currentManual"),hash:Config.get("hash")},context:this,type:"post",success:function(data){1==data.status?$.dialog.success("回滚成功"):$.dialog.error(data.info),$.dialog.get("loading").close()}}))})})}})}),define("home/book/history/index",function(require,exports,module){require("component/infinite-ajax-scroll/dist/jquery-ias.min"),Class({initial:function(){var ias=jQuery.ias({container:".m-history-list",item:".m-history-item",pagination:".m-paging",next:".m-paging .next"});ias.extension(new IASSpinnerExtension),ias.extension(new IASTriggerExtension({offset:3,text:"点击加载更多"})),ias.extension(new IASNoneLeftExtension({text:"没有更多了"}))}})}),define("home/book/index",function(require,exports,module){require("component/jquery.tree"),require("component/jquery.cookie"),require("component/prettify/prettify"),require("component/prettify/prettify.css"),require("component/zclip/jquery.zclip"),require("common/extend/validator/validator"),require("component/jquery.textSearch-1.0"),require("component/jquery.thinkkeyboard");var Comment=require("common/module/comment"),Cache=require("common/library/cache"),Template=require("common/extend/template");Class({manualEle:$("#manual"),manualId:Config.get("bookId"),manualTitleELe:$("#manualTitle"),manualHomeEle:$("#manualHome"),manualLoadingEle:$("#pageLoading"),catalogSwitchEle:$("#catalogSwitch"),manualSearchEle:$("#manualSearch"),manualNavgEle:$(".manual-navg"),shareManualEle:$("#shareManual"),shareArticleEle:$("#shareArticle"),catalogAddEle:$("#catalogAdd b"),followTotal:Config.get("followTotal"),userFollowManual:[],articleMappingList:{},upPageEle:$("#upPage"),downPageEle:$("#downPage"),collectEle:$("#collect"),commentEle:$("#comment"),manualTopbarEle:$("#manualTopbar"),settingStartEle:$("#settingStart"),settingEndEle:$("#settingEnd"),articleEle:$("#article"),articleMenuEle:$("#articleMenu"),articleJumpEle:$("#articleJump"),manualFollowEle:$("#manualFollow"),manualCollectEle:$("#manualCollect"),articleCollectListEle:$("#articleCollectList"),articleSearchEle:$("#articleSearch"),articleViewEle:$("#articleView"),articleContentEle:$("#articleContent"),articleTitleEle:$("#articleTitle"),articleAddEle:$('<span class="article-add"><label class="w-btn btn-success btn-full btn-m"><button class="btn-input">新增文章</button></label></span>'),articleUpdateEle:$("#articleUpdate"),articleCommentEle:$("#articleComment"),articleBacktopEle:$("#articleBacktop"),currentMode:"view",beforePrintMode:"view",currentArticleId:Config.get("articleId"),manualUrl:Config.get("manualUrl"),manualInitialed:!1,articleUtilEle:$(".article-util"),createArticleLevel:3,isEdit:Config.get("isEdit"),isFormSearchResult:!1,isFullScreen:!1,catalogUpdateMode:"add",currentEditContent:"",isPhone:Util.isPhone(),fullscreenSwitchElement:$(".manual-fullscreen-switch"),copyPath:seajs.data.base+seajs.data.paths.component+"/zclip/ZeroClipboard.swf?t=ggg",articleSearchTemp:["<%if(data && data.length){%>",'<ul class="search-list">',"<%for(var i = 0; i < data.length; i++){%>",'<li data-id="<%=data[i].id%>"><span class="text"><%=data[i].title%></span></li>',"<%}%>","</ul>","<%}%>"].join(""),articleSearchResultItems:$(),initial:function(){var self=this;this.pageHref=location.href,this.firstPageHash=location.hash.substr(1),this.loadArticleNumber=0,this._collectArticleList=[];var _toggleSlideBarEle=$('<span class="slidebar"><i class="icon-menu"></i></span>'),_taoggleMaskEle=$('<div class="manual-mask"></div>').appendTo(this.manualEle);$("#manualTopbar").find(".left").prepend(_toggleSlideBarEle),_toggleSlideBarEle.click(function(){return self.manualEle.toggleClass("manual-mobile-show-left"),!1}),_taoggleMaskEle.click(function(){return _toggleSlideBarEle.click(),!1}),this.manualEle.find(".manual-left").click(function(){return!1}),self.onMenuSelect=function(){_toggleSlideBarEle.click()},this.isPhone?this.mobileStart():require.async("component/jquery.stretch",function(){var _manualBody=self.manualEle.find(".manual-body"),_slideBar=self.manualEle.find(".manual-left"),_docBody=$("body");_slideBar.stretch({direction:"horizon",maxDragRange:500,minDragRange:210,onDragStart:function(){Util.selectable(_docBody,!0),_manualBody.css("cursor","w-resize")},onDragging:function(actual){_manualBody.css({"padding-left":this.wrapEle.outerWidth()})},onDragEnd:function(){Util.selectable(_docBody,!1),_manualBody.css("cursor","auto")}}),self.stretchManualLeft=$.stretch.get(self.manualEle.find(".manual-left")),self.onInitEdit=function(){self.stretchManualLeft.disabled(!0),self.stretchManualLeft.reset(),_manualBody.css("padding-left",_slideBar.outerWidth())},self.onQuitEdit=function(){self.stretchManualLeft.disabled(!1)}}),this.menuElements=this.articleMenuEle.children(),this.articleMenuEle.empty(),this.isFullScreen=$.cookie("manualIsFullScreen",void 0,{path:this.manualUrl}),this.isFullScreen=this.isFullScreen&&"false"!=this.isFullScreen?!0:!1,this.menu=$.tree(this.formartData(this.menuElements),{appendTo:this.articleMenuEle,parseTemp:function(node){var _html="",_text=node.get("text");return self.isEdit?(_html+='<span class="tree-text" title="'+_text+'">'+_text+"</span>",self.isEdit&&(_html+='<span class="tree-operate">',_html+='<span class="operate-show" title="操作"><i class="icon-chevron-right"></i></span>',_html+='<span class="operate-hide">',_html+='<b class="delete icon-minus" title="删除"></b>',_html+='<b class="add icon-plus" title="新增"></b>',_html+='<b class="edit icon-pencil" title="编辑"></b>',_html+="</span>",_html+="</span>"),_html=$(_html),_html.filter(".tree-operate").click(function(event){$(this).toggleClass("hover"),event.stopPropagation()}).hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")}),_html.find(".add").click(function(event){self.addCatalog(node)}),_html.find(".edit").click(function(event){self.editCatalog(node)}),_html.find(".delete").click(function(event){$.dialog.confirm("确定删除吗？",function(action){1==action&&node&&self.deleteArticle(node)}),event.stopPropagation()})):_html+='<span class="tree-text">'+node.get("text")+"</span>",_html},onSelect:function(event,node){self.targetPageArticle(node),$.isFunction(self.onMenuSelect)&&self.onMenuSelect.call(self,node)},onBeforeSelect:function(){var _node=this;return"edit"==self.currentMode?(self.confrimCancelUpdate(function(){_node.release(!0)}),!1):void 0}}),this.setMode(this.currentMode,!1),this.articleJumpUpEle=this.articleJumpEle.find(".jump-up"),this.articleJumpDownEle=this.articleJumpEle.find(".jump-down"),this.onLoadAcritcle=function(data,cache){this.manualInitialed||(this.confrimCancelUpdate(),this.getArticleEditor(),this.manualEle.addClass("manual-active"),this.manualLoadingEle.removeClass("loading-active")),this.manualInitialed=!0},this.onCreatedEdit=function(){this.articleEditFormEle.submitForm({onBefore:function(options){self.articleEditLocalLock=!1,self.articleEle.loading(null,"loading-ripple")},onAfter:function(data,options){if(data.status){if(options.data.title=Util.HTMLEnCode($.trim(options.data.title)),"create"==self.currentMode||"add"==self.currentMode){var _data=self.formartData($.extend(options.data,data.data));self.menu.createNode(_data),self.findEmpty(),Cache.set("edit-"+options.data.id,{content:options.data.content}),self.setMode("view",!1)}else if("edit"==self.currentMode){self.menu.getSelected();Cache.del("view-"+options.data.id),Cache.set("edit-"+options.data.id,{content:options.data.content}),self.setMode("edit",!1),self.loadArticle(options.data.id,"view",function(data){self.setArticleContent(data.content,"view")})}self.removeArticleEditFromLocal(options.data.id)}else $.dialog.error(data.info);self.articleEle.loading("hide")}})},this.articleUpdateEle.click(function(){}),this.manualTitleELe.add(this.manualHomeEle).click(function(){return self.returnManualHome(),!1}),this.upPageEle.click(function(){return self.upPageAritcle(),!1}),this.downPageEle.click(function(){return self.downPageAritcle(),!1}),this.manualNavgEle.find(".navg-item").click(function(event){$(this).hasClass("disabled")&&event.stopImmediatePropagation()}),this.catalogSwitchEle.click(function(){self.confrimCancelUpdate(function(){self.setMode("view")})}),this.catalogAddEle.click(function(){return self.addCatalog(),!1}),this.searchFormEle=$("#manualSearchForm"),this.manualSearchEle.click(function(event){self.confrimCancelUpdate(function(){self.setMode("search")})}),this.manualCollectEle.click(function(){self.confrimCancelUpdate(function(){self.setMode("collect")})}),this.searchFormEle.find(":submit").click(function(){self.searchFormEle.submit()}),this.searchFormEle.submitForm({onBefore:function(options){return options.data.keyword=$.trim(options.data.keyword),options.data.keyword?void 0:(Util.wranStyle(self.searchFormEle.find(":text"),"text-wran"),!1)},onAfter:function(data){self.articleSearchEle.find(".search-result").html(Template.parseTemp(self.articleSearchTemp,data)).click(function(event){event.stopPropagation()}),self.articleSearchResultItems=self.articleSearchEle.find(".search-list li"),self.articleSearchResultItems.eq(0).click(),self.findSearchResult()}}),this.searchFormEle.find("button").on("touchstart",function(){return self.searchFormEle.submit(),!1}),self.articleSearchEle.find(".search-result").delegate(".search-list li","click",function(){var _ele=$(this);self.confrimCancelUpdate(function(){self.targetPageArticle(_ele.data("id"))})}),Config.get("colseComment")||(this.comment=new Comment({wrapEle:this.articleCommentEle,disabledPost:!Config.get("isLogin"),hidePost:!Config.get("isComment"),postParam:{book_id:this.manualId},delParam:{book_id:this.manualId},deletePath:Config.get("commentDeletePath"),votePath:Config.get("commentVotePath"),onePath:Config.get("commentOnePath"),listPath:Config.get("commentListPath"),delPath:Config.get("commentDelPath"),addPath:Config.get("commentAddPath"),onAddItem:function(item){self.copyCode(item.find("pre"))},onCreate:function(){this.articleIdHiddenEle=$('<input type="hidden" name="doc_id" />'),this.postEnterEle.after(this.articleIdHiddenEle)}})),function(){function loadCallback(callback){Config.get("isLogin")?self.getCollectArticle(function(){self.getUserFollowManual(function(){$.isFunction(callback)&&callback()})}):$.isFunction(callback)&&callback()}loadCallback(function(){self.findUserFollowManual(),self.findEmpty();location.hash;if(""!==self.currentArticleId)self.targetPageArticle(self.currentArticleId);else{var _param=self.urlGetBookParam();self.targetPageArticle(_param.article)}$(window).on("popstate hashchange",function(){var _param=self.urlGetBookParam();_param&&_param.article&&_param.article in self.articleMappingList&&self._targetPageArticle(self.articleMappingList[_param.article])})})}.call(this),this.comment&&$("#comment").click(function(){self.comment.postEnterEle.focus(),Util.scrollTop(self.comment.postEnterEle,-80)}),function(){var _timer=null,_doc=($(window),$(document));self.articleBacktopEle.click(function(){Util.scrollTop($("body"))}),_doc.scroll(function(){clearTimeout(_timer),_timer=setTimeout(function(){_doc.scrollTop()>200?self.articleBacktopEle.addClass("active"):self.articleBacktopEle.removeClass("active")},300)})}(),this.shareManualEle.on("mouseenter",function(){window.jiathis_config={url:Config.get("bookUrl"),title:Util.HTMLEnCode(document.title),summary:Util.HTMLEnCode(Util.substr($("meta[name=description]").attr("content"),200))}}),this.shareArticleEle.on("mouseenter",function(){window.jiathis_config={url:location.href,title:Util.HTMLEnCode(self.articleTitleEle.text()),summary:Util.HTMLEnCode(Util.substr(self.articleContentEle.text(),0,200))}}),this.fullScreen(this.isFullScreen),$(document).thinkkeyboard({left:function(event){if("view"==self.currentMode||"search"==self.currentMode||"collect"==self.currentMode){var target=event.target.nodeName.toLowerCase();if("input"!=target&&"textarea"!=target)return self.upPageAritcle(),!1}},right:function(event){if("view"==self.currentMode||"search"==self.currentMode||"collect"==self.currentMode){var target=event.target.nodeName.toLowerCase();if("input"!=target&&"textarea"!=target)return self.downPageAritcle(),!1}},"ctrl+f":function(){return"view"==self.currentMode||"search"==self.currentMode||"collect"==self.currentMode?(self.fullScreen(!self.isFullScreen),!1):void 0}}),this.fullscreenSwitchElement.find(".open").click(function(){self.fullScreen(!1),self.fullscreenSwitchElement.removeClass("fullscreen-switch-active"),self.manualEle.find(".manual-left").css("left",0)}).end().find(".close").click(function(){self.fullScreen(!0),self.fullscreenSwitchElement.addClass("fullscreen-switch-active"),self.manualEle.find(".manual-left").css("left",-1*self.manualEle.find(".manual-left").outerWidth())}),$(window).resize(function(){self.updateCatalogSize()}),this.updateCatalogSize(),this.topbarAuto(this.manualTopbarEle),this.collectEle.click(function(){var _node=self.menu.getNode(self.currentArticleId);if(_node)if($(this).hasClass("toggle")){var _did=_node.get("id"),_ele=self.articleCollectItems.filter("[data-did="+_did+"]"),_id=_ele.data("id");self.delCollectArticle(_id)}else self.addCollectArticle(_node);return!1}),this.settingStartEle.click(function(){return self.setSetting(!0),!1}),this.settingEndEle.click(function(){return self.setSetting(!1),!1}),this.articleContentEle.delegate("a","click",function(){return window.open($(this).attr("href"),"_blank"),!1}),this.manualFollowEle.find(".name").click(function(){self.inUserFollowManual(self.manualId)>=0?self.cancelFollowManual():self.addFollowManual()})},loadArticle:function(id,type,callback){if(id===!1)$.isFunction(this.onLoadAcritcle)&&this.onLoadAcritcle.call(this,!1,!1);else{var _type="edit"!=this.currentMode?"view":"edit",_ajaxType="get";"string"==typeof type?_type=type:callback=type;var _cacheMask=_type+"-"+id,_cacheData=Cache.get(_cacheMask);_ajaxData={},"edit"==_type?(_ajaxUrl=Config.get("updateUrl"),_ajaxType="post",_ajaxData={id:id,book_id:this.manualId}):(_ajaxUrl=this.manualUrl,_ajaxUrl=_ajaxUrl+"/"+id),this._loadArticleAjax&&this._loadArticleAjax.abort(),!_cacheData&&$.isNumeric(id)?(this.articleEle.loading(null,"loading-ripple"),this._loadArticleAjax=$.ajax({url:_ajaxUrl,type:_ajaxType,data:_ajaxData,context:this,success:function(data){data.status?(this.loadArticleNumber++,this.currentArticleId=id,Cache.set(_cacheMask,data.data),$.isFunction(this.onLoadAcritcle)&&this.onLoadAcritcle.call(this,data.data)):$.dialog.error(data.info),$.isFunction(callback)&&callback.call(this,data.data,!1)},complete:function(){this.articleEle.loading("hide")}})):(this.loadArticleNumber++,this.currentArticleId=id,$.isFunction(callback)&&callback.call(this,_cacheData,!0),$.isFunction(this.onLoadAcritcle)&&this.onLoadAcritcle.call(this,_cacheData,!0))}},deleteArticle:function(id,callback){var _id,_stnode=this.menu.getSelected(),_node=id,_same=!1;this.articleEle.loading("文章删除中..","loading-ripple"),"object"!=$.type(id)&&(_node=this.menu.nodes.find(id)),_id=_node.get("id"),_stnode&&_stnode.get("id")==_id&&(_same=!0),$.ajax({url:Config.get("deleteArticleUrl"),data:{id:_id,book_id:Config.get("bookId"),title:_node.get("text")},type:"post",context:this,success:function(data){if(data.status){if(this.menu.nodes.children(_node).length){var _childrens=this.menu.nodes.childrens(_node),_lastNode=_childrens[_childrens.length-1],nextNode=this.menu.nodes.next(_lastNode,this.menu.nodes.childrens());nextNode||(nextNode=this.menu.nodes.prev(_node,this.menu.nodes.childrens()))}else{var nextNode=this.menu.nodes.next(_node,this.menu.nodes.childrens());nextNode||(nextNode=this.menu.nodes.prev(_node,this.menu.nodes.childrens()))}_node.element.parent().find(".tree-create").removeClass("create-active"),this.articleSearchResultItems.filter("[data-id="+_id+"]").remove(),this.articleCollectItems&&this.articleCollectItems.filter("[data-did="+_id+"]").remove(),_node.remove(),this.findCollectArticle(),this.findSearchResult(),nextNode?nextNode.selected(!0):this.findEmpty()}else $.dialog.error(data.info)},complete:function(){this.articleEle.loading("hide")}})},updateJumpLink:function(node){var _prevId=null,_prevText=null,_nextId=null,_nextText=null;if("search"==this.currentMode){var _currentSearchEle=this.articleSearchResultItems.filter(".active"),_prevEle=_currentSearchEle.prev(),_nextEle=_currentSearchEle.next();_prevEle.length&&(_prevId=_prevEle.data("id"),_prevText=_prevEle.find(".text").html()),_nextEle.length&&(_nextId=_nextEle.data("id"),_nextText=_nextEle.find(".text").html())}else if("collect"==this.currentMode){var _currentSearchEle=this.articleCollectItems.filter(".active"),_prevEle=_currentSearchEle.prev(),_nextEle=_currentSearchEle.next();_prevEle.length&&(_prevId=_prevEle.data("did"),_prevText=_prevEle.find(".text").html()),_nextEle.length&&(_nextId=_nextEle.data("did"),_nextText=_nextEle.find(".text").html())}else{var _node=this.menu.getSelected(),_childrens=this.menu.nodes.childrens(),_prevEle=this.menu.nodes.prev(_node,_childrens),_nextEle=this.menu.nodes.next(_node,_childrens);_prevEle&&(_prevId=_prevEle.get("id"),_prevText=_prevEle.get("text")),_nextEle&&(_nextId=_nextEle.get("id"),_nextText=_nextEle.get("text"))}null!==_prevId?(this.articleJumpUpEle.show(),this.upPageEle.attr("data-articleid",_prevId).attr("href",this.manualUrl+"/"+_prevId).html(Util.HTMLEnCode(_prevText))):this.articleJumpUpEle.hide(),null!==_nextId?(this.articleJumpDownEle.show(),this.downPageEle.attr("data-articleid",_nextId).attr("href",this.manualUrl+"/"+_nextId).html(Util.HTMLEnCode(_nextText))):this.articleJumpDownEle.hide()},_targetPageArticle:function(id,callback){var _self=this,_node=this.menu.getNode(id),_id=id;if(_node&&(_id=_node.get("id")),"edit"==this.currentMode&&this.setMode("edit",!1),"search"==this.currentMode){var _ele=_id;$.isNumeric(_ele)&&(_ele=this.articleSearchResultItems.filter("[data-id="+_ele+"]")),_ele.length&&(_id=_ele.data("id"),_ele.addClass("active").siblings().removeClass("active")),_node||(_node=this.menu.getNode(_id))}else if("collect"==this.currentMode){var _ele=_id;$.isNumeric(_ele)&&(_ele=this.articleCollectItems.filter("[data-did="+_ele+"]")),_ele.length&&(_id=_ele.data("did"),_ele.addClass("active").siblings().removeClass("active")),_node||(_node=this.menu.getNode(_id))}else _node&&!_node.isSelected()&&_node.selected(!0,!0);"undefined"!=typeof _id&&null!==_id&&_node?this.loadArticle(_id,function(data,cache){var _selectedNode=_node,_articleId=null;if(this.setArticleContent(data?data.content:this.articleContentEle.html()),_selectedNode){_articleId=_selectedNode.get("id"),this.setArticleTitle(_selectedNode.get("text")),this.setArticleParent(_selectedNode),this.articleUpdateEle.attr("href",Config.get("jumpEditUrl")+"/"+_articleId),Template.setData({articleId:_articleId}),this.hasCurrentCollectArticle(_articleId);var _hashSplit=null;this.firstPageHash&&this.firstPageHash.indexOf("-")>=0&&(_hashSplit=this.firstPageHash.split("-")),1==this.loadArticleNumber&&_hashSplit&&_hashSplit[1]?this.comment?(this.comment.loadOne({id:_hashSplit[1],doc_id:_articleId},function(data){this.assignList({doc_id:_articleId},function(){data.status&&this.addItem(data.data,!0,!1)}),Util.scrollTop(this.listEle,-120)}),this.comment.setDelParam({doc_id:_articleId}),this.comment.articleIdHiddenEle.val(_articleId)):$.dialog.error("已关闭评论功能"):this.comment&&("edit"!=this.currentMode&&this.comment.assignList({doc_id:_articleId}),this.comment.resetForm(),this.comment.textareaHeightAuto(),this.comment.setDelParam({doc_id:_articleId}),this.comment.articleIdHiddenEle.val(_articleId)),this.updateJumpLink(),$(document).scrollTop(0)}this.updateReadProgress&&this.updateReadProgress(),$.isFunction(callback)&&callback.call(_self,_id)}):(_node=this.menu.nodes.first(),_node?this.targetPageArticle(_node,function(){_self.updateReadProgress&&_self.updateReadProgress(),$.isFunction(callback)&&callback.call(_self,_node)}):this.setMode("empty"))},targetPageArticle:function(id,callback){this._targetPageArticle(id,function(_id){var _node=this.menu.getNode(_id);if(_node){var _id=_node.get("id").toString(),_name=_node.get("name")||_id;"pushState"in history?history.pushState({},"",this.manualUrl+"/"+_name):location.hash=_name,this.articleMappingList[_name]=_id}$.isFunction(callback)&&callback(this,_id)})},upPageAritcle:function(){var _targetPage=null;if("search"==this.currentMode)if(this.articleSearchResultItems.length){var _currentSearchEle=this.articleSearchResultItems.filter(".active");_targetPage=_currentSearchEle.prev(),_targetPage.length||(_targetPage=this.articleSearchResultItems.last())}else this.articleJumpUpEle.is(":visible")&&(_targetPage=this.upPageEle.attr("data-articleid"),this.setMode("view"));else if("collect"==this.currentMode)if(this.articleCollectItems.length){var _currentCollectEle=this.articleCollectItems.filter(".active");_targetPage=_currentCollectEle.prev(),_targetPage.length||(_targetPage=this.articleCollectItems.last())}else this.articleJumpUpEle.is(":visible")&&(_targetPage=this.upPageEle.attr("data-articleid"),this.setMode("view"));else{var _node=this.menu.getSelected(),_childrens=this.menu.nodes.childrens();_targetPage=this.menu.nodes.prev(_node,_childrens),_targetPage||(_targetPage=this.menu.nodes.last())}_targetPage&&this.targetPageArticle(_targetPage)},downPageAritcle:function(){var _targetPage=null;if("search"==this.currentMode)if(this.articleSearchResultItems.length){var _currentSearchEle=this.articleSearchResultItems.filter(".active");_targetPage=_currentSearchEle.next(),_targetPage.length||(_targetPage=this.articleSearchResultItems.first())}else this.articleJumpDownEle.is(":visible")&&(_targetPage=this.downPageEle.attr("data-articleid"),this.setMode("view"));else if("collect"==this.currentMode)if(this.articleCollectItems.length){var _currentCollectEle=this.articleCollectItems.filter(".active");_targetPage=_currentCollectEle.next(),_targetPage.length||(_targetPage=this.articleCollectItems.first())}else this.articleJumpDownEle.is(":visible")&&(_targetPage=this.downPageEle.attr("data-articleid"),this.setMode("view"));else{var _node=this.menu.getSelected(),_childrens=this.menu.nodes.childrens();_targetPage=this.menu.nodes.next(_node,_childrens),_targetPage||(_targetPage=this.menu.nodes.first())}_targetPage&&this.targetPageArticle(_targetPage)},setArticleTitle:function(title){var _title=title;return"edit"==this.currentMode||(this.isFormSearchResult&&title&&(_title=this.highlightResult(_title,this.getSearchKeyword())),document.title=Util.HTMLDeCode(title+" - "+Config.get("bookTitle")),this.articleTitleEle.html(_title)),this},setArticleContent:function(content,type){var self=this,_scrollEle=null,_type=type||this.currentMode;return"edit"==_type?(this.findArticleEditHasLocal(self.currentArticleId,function(data){this.confirmEditContentEle||(this.confirmEditContentEle=$('<span class="confirm-content"><span class="inner">这是您上次未保存的内容，不需要点击 <b class="cancel">[撤销]</b></span></span>'),this.articleEditContentEle.after(this.confirmEditContentEle),this.confirmEditContentEle.find("b").click(function(){self.getArticleEditor(function(){this.articleEditor.value(content)}),self.currentEditContent=self.articleEditContentEle.val(),self.confirmEditContentEle.removeClass("active"),self.removeArticleEditFromLocal(self.currentArticleId)})),this.confirmEditContentEle.addClass("active"),self.getArticleEditor(function(){this.articleEditor.value(data)})},function(){this.confirmEditContentEle&&this.confirmEditContentEle.removeClass("active"),self.getArticleEditor(function(){this.articleEditor.value(content)})}),this.currentEditContent=this.articleEditContentEle.val()):(this._copyEle&&this._copyEle.appendTo($("body")),content=this.filterContent(content),this.isFormSearchResult&&content&&(content=this.highlightResult(content,this.getSearchKeyword())),this.articleContentEle.html(content),_scrollEle=this.articleContentEle.find(".e-search-highlight:first"),_scrollEle.length&&Util.scrollTop(_scrollEle,-60),this.articleContentEle.find("pre").each(function(){$(this).data("copyText",$(this).text())}),this.copyCode(this.articleContentEle.find("pre")),this.highlightCode(this.articleContentEle.find("pre"))),this},copyCode:function(element,content){var self=this;this.isPhone||(this._copyEle||(this._copyText="",this._copyEle=$('<div class="m-copy-code"><span class="hander"><i class="icon icon-paper-stack"></i><span class="text">复制代码</span></span></div>').appendTo($("body")),this._copyEle.find(".hander").zclip({path:self.copyPath,copy:function(){return self._copyText},afterCopy:function(){self._copyEle.addClass("copy-success"),self._copyEle.find(".text").text("复制成功")}})),element.mouseenter(function(){$(this).find(self._copyEle).length||(self._copyEle.appendTo($(this)),self._copyText=$(this).data("copyText")),self._copyEle.find(".text").text("复制代码")}))},updateCatalogSize:function(){if(this._isSetting){var _height=this.articleMenuEle.parent().height();this.articleMenuEle.siblings().each(function(){_height-=$(this).outerHeight()}),this.articleMenuEle.css({"max-height":_height-parseInt(this.articleMenuEle.css("paddingTop"),10)-parseInt(this.articleMenuEle.css("paddingBottom"),10)-2})}else this.articleMenuEle.css({"max-height":"100%"})},setArticleParent:function(node){var node=node,pid=0,text="";if(node)"edit"==this.currentMode||"add"==this.currentMode&&(node.getLevel()>=this.createArticleLevel&&(node=this.menu.nodes.parent(node)),text=node.get("text"),pid=node.get("id"),this.articleEditPidHiddenEle.val(pid));else{var _selectedNode=this.menu.getSelected();this.articleEditPidHiddenEle.val(0),_selectedNode&&_selectedNode.selected(!1,!0)}},formartData:function(element){var data=[];return $.isPlainObject(element)?data.push($.extend({url:this.manualUrl+"/"+element.id,text:element.title},element)):element.each(function(){data.push({url:$(this).attr("href"),id:$(this).data("id"),pid:$(this).data("pid"),name:$(this).data("name"),text:Util.HTMLEnCode($(this).text())})}),data},highlightCode:function(code){return code.each(function(){var $this=$(this),$code=$this.children("code"),lang=$code.attr("class");$this.addClass("prettyprint linenums").data("code",$code.text()),lang&&$this.addClass("lang-"+lang),navigator.userAgent.match(/AppleWebKit/gi)&&$this.addClass("webkit")}),prettyPrint(),this},highlightResult:function(content,keyword){var content=$("<div>"+content+"</div>");return content.textSearch(Util.HTMLEnCode(keyword),{markClass:"e-search-highlight"}),content.html()},getSearchKeyword:function(){return $.trim(this.searchFormEle.find("input:text").val())},setMode:function(mode,status){var self=this,status="undefined"==typeof status?!0:status?!0:!1,quitEdit=!1;this.currentMode=mode;var _selectedNode=this.menu.getNode(this.currentArticleId);if(_selectedNode)var _selectedNodeId=_selectedNode.get("id"),_selectedNodeText=_selectedNode.get("text");if($("html").css("overflow-y","scroll"),this.isFormSearchResult=!1,"edit"==mode)status?(this.getArticleEditor(function(){this.articleEditFormEle.attr("action",Config.get("updateArticleUrl")),this.articleEditIdHiddenEle.val(_selectedNodeId),this.articleEditTitleEle.val(_selectedNodeText),this.setArticleParent(_selectedNode),this.manualEle.addClass("manual-mode-edit"),self.loadArticle(_selectedNodeId,function(data){this.setArticleContent(data.content),Util.setCursorPosition(self.articleEditContentEle[0],0),setTimeout(function(){self.articleEditContentEle.scrollTop(0)},10)})}),$.isFunction(this.onInitEdit)&&this.onInitEdit.call(this)):(this.manualEle.removeClass("manual-mode-edit"),this.currentMode=this.beforePrintMode,quitEdit=!0),status&&$("html").css("overflow-y","hidden");else if("empty"==mode){if(this.manualLoadingEle.removeClass("loading-active"),this.currentEditContent="",!this.emptyEle){var _html="";_html+='<div class="manual-create-tip">',_html+="<h3>文档还没有目录，赶紧添加吧！</h3>",_html+=self.isEdit?'<p style="margin-top: 12px;"><a class="w-btn btn-success btn-l" href="'+Config.get("jumpEditUrl")+'" target="_blank"><span class="btn-input">新增文章</span></a></p>':"",_html+="</div>",this.emptyEle=$(_html),this.manualEle.find(".manual-body").append(this.emptyEle)}"pushState"in history?history.pushState({},"",this.manualUrl):location.hash="",this.beforePrintMode="empty",this.manualEle.removeClass("manual-mode-create manual-mode-view manual-mode-edit manual-mode-collect").addClass("manual-mode-empty manual-active"),quitEdit=!0}else if("create"==mode)status?(this.getArticleEditor(function(){this.articleEditor.value(""),this.articleEditFormEle.attr("action",Config.get("createUrl")),this.articleEditTitleEle.val("").focus()}),this.manualEle.removeClass("manual-mode-empty manual-mode-view manual-mode-edit manual-mode-add manual-mode-collect").addClass("manual-mode-create")):this.setMode("empty"),quitEdit=!0;else if("search"==mode){if(this.manualSearchEle.siblings().removeClass("active").end().addClass("active"),this.manualEle.removeClass("manual-mode-empty manual-mode-create manual-mode-add manual-mode-view manual-mode-edit manual-mode-collect").addClass("manual-mode-search"),this.isFormSearchResult=!0,this.articleSearchResultItems){
var _selected=this.articleSearchResultItems.filter(".active");_selected.length||(_selected=this.articleSearchResultItems.first()),_selected.click()}this.beforePrintMode="search",this.searchFormEle.find("input:text").focus().select(),this.findSearchResult(),quitEdit=!0}else if("collect"==mode){if(this.manualCollectEle.siblings().removeClass("active").end().addClass("active"),this.manualEle.removeClass("manual-mode-empty manual-mode-create manual-mode-search manual-mode-add manual-mode-edit manual-mode-view").addClass("manual-mode-collect"),this.articleCollectItems){var _selected=this.articleCollectItems.filter(".active");_selected.length||(_selected=this.articleCollectItems.eq(0)),_selected.click()}this.beforePrintMode="collect",this.findCollectArticle(),quitEdit=!0}else status&&_selectedNode&&this.targetPageArticle(_selectedNode),this.beforePrintMode="view",this.catalogSwitchEle.siblings().removeClass("active").end().addClass("active"),this.manualEle.removeClass("manual-mode-empty manual-mode-create manual-mode-search manual-mode-add manual-mode-edit manual-mode-collect").addClass("manual-mode-view"),this.updateCatalogSize(),quitEdit=!0;quitEdit&&$.isFunction(this.onQuitEdit)&&this.onQuitEdit.call(this),$.isFunction(this.onChnageMode)&&this.onChnageMode.call(this)},createEditModeHtml:function(){var self=this;if(!this.articleEditEle){this.articleEditEle=['<div class="article-edit">','<form id="articleEditForm" method="post" autocomplete="off">','<div class="edit-item title">','<label class="w-text text-full text-l"><input class="text-input" name="title" placeholder="请输入文章标题" type="text" /></label>',"</div>",'<div class="edit-item content manual-editor">','<textarea name="content" placeholder="请输入文章内容"></textarea>',"</div>",'<div class="edit-item util">','<input name="pid" type="hidden" value="0">','<input name="id" type="hidden">','<input name="book_id" type="hidden" value="'+Config.get("bookId")+'">','<input name="parse" type="hidden" value="1">','<label class="w-btn submit btn-l btn-success"><input class="btn-input" type="submit" value="&nbsp;保存&nbsp;"></label>&#12288;','<label class="w-btn cancel btn-l btn-default"><input class="btn-input" type="button" value="&nbsp;取消&nbsp;"></label>',"</div>","</form>","</div>"].join(""),this.articleEditEle=$(this.articleEditEle),this.articleEditFormEle=this.articleEditEle.find("#articleEditForm"),this.articleEditTitleEle=this.articleEditFormEle.find("[name=title]"),this.articleEditPidHiddenEle=this.articleEditFormEle.find("[name=pid]"),this.articleEditIdHiddenEle=this.articleEditFormEle.find("[name=id]"),this.articleViewEle.after(this.articleEditEle),this.articleEditContentEle=this.articleEditEle.find(".content textarea");this.articleEditTitleEle.thinkkeyboard({"ctrl+s":function(){return self.articleEditFormEle.submit(),!1}});var _keyupTimer=null;this.articleEditContentEle.focus(function(){self.articleEditLocalLock=!0}),this.articleEditContentEle.on("keyup",function(){clearTimeout(_keyupTimer),_keyupTimer=setTimeout(function(){self.articleEditLocalLock&&self.setArticleEditToLocal(self.currentArticleId,self.articleEditContentEle.val())},300)}),$.isFunction(this.onCreatedEdit)&&this.onCreatedEdit.call(this)}return this.articleEditorEle},updateEditorSize:function(joinHead){var _headEle=$(".m-manual .manual-head"),_headHeight=_headEle.outerHeight(),_enterPt=parseInt(this.articleEditContentEle.css("paddingTop")),_enterPb=parseInt(this.articleEditContentEle.css("paddingBottom"));joinHead===!1&&(_headHeight=0),$(".thinkeditor .thinkeditor-textarea").css({height:$(window).height()-_headHeight-$(".thinkeditor .thinkeditor-tools").outerHeight()-_enterPt-_enterPb-2})},getArticleEditor:function(callback){var self=this;this.articleEditor?$.isFunction(callback)&&callback.call(this,this.articleEditor):(1==Config.get("editor")?(require.async("component/thinkeditor/skin/manual/style.css"),require.async("component/thinkeditor/jquery.thinkeditor",function(){self.createEditModeHtml(),self.articleEditor=$.thinkeditor(self.articleEditEle.find("textarea").thinkeditor({style:"manual",uploader:{url:Config.get("uploadImageUrl"),data:{book_id:self.manualId}},items:"h1,h2,h3,h4,h5,h6,-,bold,italic,-,ul,ol,-,link,image,code,hr,blockquote,-,save,quit,fullscreen",onSave:function(){self.articleEditFormEle.submit()},onFullscreen:function(status){status?self.manualEle.addClass("manual-editor-fullscree-active"):self.manualEle.removeClass("manual-editor-fullscree-active")},onQuit:function(){var _textarea=$(this);self.confrimCancelUpdate(function(){var _editor=_textarea.closest(".thinkeditor");_editor.removeClass("thinkeditor-fullscreen"),"edit"==self.currentMode?self.setMode("edit",!1):self.setMode("create",!1),$("body").css("overflow",""),self.manualEle.removeClass("manual-editor-fullscree-active")})}})),$.isFunction(callback)&&callback.call(self,self.articleEditor)})):require.async("component/jquery-migrate-1.2.1.min",function(){require.async("component/xheditor/xheditor-1.2.1.min",function(){self.createEditModeHtml();var plugin={h1:{c:"xheIcon xheBtnH1",t:"h1",e:function(){this.loadBookmark(),this._exec("formatblock","<h1>")}},h2:{c:"xheIcon xheBtnH2",t:"h2",e:function(){this.loadBookmark(),this._exec("formatblock","<h2>")}},h3:{c:"xheIcon xheBtnH3",t:"h3",e:function(){this.loadBookmark(),this._exec("formatblock","<h3>")}},h4:{c:"xheIcon xheBtnH4",t:"h4",e:function(){this.loadBookmark(),this._exec("formatblock","<h4>")}},h5:{c:"xheIcon xheBtnH5",t:"h5",e:function(){this.loadBookmark(),this._exec("formatblock","<h5>")}},h6:{c:"xheIcon xheBtnH6",t:"h6",e:function(){this.loadBookmark(),this._exec("formatblock","<h6>")}},back:{c:"xheIcon xheBtnBack",t:"退出编辑",s:"esc",e:function(){self.confrimCancelUpdate(function(){"edit"==self.currentMode?self.setMode("edit",!1):self.setMode("create",!1),self.manualEle.removeClass("manual-editor-fullscree-active"),$("body").css("overflow","")})}},save:{c:"xheIcon xheBtnSave",t:"保存",s:"ctrl+s",e:function(){self.articleEditFormEle.submit()}},code:{c:"xheIcon btnCode",t:"插入代码",e:function(){var _this=this,htmlCode='<div><select id="xheCodeType"><option value="html">HTML/XML</option><option value="js">Javascript</option><option value="css">CSS</option><option value="php">PHP</option><option value="java">Java</option><option value="py">Python</option><option value="pl">Perl</option><option value="rb">Ruby</option><option value="cs">C#</option><option value="c">C++/C</option><option value="vb">VB/ASP</option><option value="">其它</option></select></div><div><textarea id="xheCodeValue" wrap="soft" spellcheck="false" style="width:300px;height:100px;" /></div><div style="text-align:right;"><input type="button" id="xheSave" value="确定" /></div>',jCode=$(htmlCode),jType=$("#xheCodeType",jCode),jValue=$("#xheCodeValue",jCode),jSave=$("#xheSave",jCode);jSave.click(function(){return _this.loadBookmark(),_this.pasteText("[code="+jType.val()+"]\r\n"+jValue.val()+"\r\n[/code]"),_this.hidePanel(),!1}),_this.saveBookmark(),_this.showDialog(jCode)}},Fullscreen:{c:"xheIcon xheBtnFullscreen",s:"Esc",t:"Fullscreen",e:function(){this.toggleFullscreen(),self.articleEditor._panelEle.parent().hasClass("xhe_Fullscreen")?(self.manualEle.addClass("manual-editor-fullscree-active"),self.articleEditEle._changeHeight($(window).height())):(self.manualEle.removeClass("manual-editor-fullscree-active"),self.onChnageMode())}}};self.articleEditor=self.articleEditEle.find("textarea").xheditor({fullscreen:!1,plugins:plugin,tools:"h1,h2,h3,h4,h5,h6,Bold,Italic,Underline,Strikethrough,Align,List,Link,Img,code,Hr,Fullscreen,back,save",width:"100%",height:540,skin:"manual",beforeSetSource:ubb2html,beforeGetSource:html2ubb,upLinkUrl:Config.get("uploadImageUrl")+"?book_id="+self.manualId,upImgUrl:Config.get("uploadImageUrl")+"?book_id="+self.manualId,parseData:function(data){if(data.status){var _image=[],_number=0;for(var i in data.files)_image.push({id:++_number,url:data.files[i].rootpath+data.files[i].savepath+data.files[i].savename,localname:data.files[i].savename});if(_image.length)return data.err="",data.msg=_image,data;$.dialog.error("未发现图片资源！")}else $.dialog.error(data.info);return!1},showBlocktag:!1,shortcuts:{"ctrl+s":function(){return self.articleEditFormEle.submit(),!1}}}),self.articleEditor.value=self.articleEditor.setSource,self.articleEditor._panelEle=self.articleEditEle.find(".manual-editor .xheLayout"),self.articleEditor._toolbarEle=self.articleEditor._panelEle.find("tr:first td"),self.articleEditor._workEle=self.articleEditor._panelEle.find("tr:last td"),self.articleEditor._toolbarHeight=50,self.articleEditor._changeWidth=function(width){self.articleEditor._panelEle.width(width)},self.articleEditEle._changeHeight=function(height){self.articleEditor._workEle.height(height-self.articleEditor._toolbarHeight),self.articleEditor._panelEle.height(height)},$.isFunction(callback)&&callback.call(self,self.articleEditor)})}),this.onChnageMode=function(){function updateEditorSize(){if(self.isFullScreen)self.articleEditEle._changeHeight($(window).height());else{var _wh=$(window).height(),_hh=self.manualEle.find(".manual-head").outerHeight();self.articleEditEle._changeHeight(_wh-_hh)}}if(2==Config.get("editor")&&self.articleEditor){var _timer=null;updateEditorSize(),$(window).resize(function(){clearTimeout(_timer),_timer=setTimeout(function(){updateEditorSize()},300)})}})},findEmpty:function(){this.menu.nodes.children().length?(this.manualEle.removeClass("manual-empty"),this.catalogSwitchEle.removeClass("disabled"),this.manualSearchEle.removeClass("disabled"),"create"==this.currentMode&&(this.setMode("view"),this.menu.nodes.first().selected(!0))):(this.setMode("empty"),this.catalogSwitchEle.addClass("disabled"),this.manualSearchEle.addClass("disabled"))},addCatalog:function(node){if(this.catalogUpdateMode="add",node){var _parent=node.element.parent(),_createEle=this.getAddCatalogTemp(node.getLevel()+1,node.get("id"));node.element.removeClass("tree-update"),_createEle.removeClass("create-root"),_createEle.closest(".tree-item").removeClass("tree-update"),_createEle.appendTo(_parent)}else{var _createEle=this.getAddCatalogTemp(1);_createEle.addClass("create-root"),_createEle.closest(".tree-item").removeClass("tree-update"),_createEle.appendTo(this.menu.tree)}this.getAddCatalogTemp().find("[name=title]").focus()},editCatalog:function(node){if(node){this.catalogUpdateMode="edit";var _createEle=this.getAddCatalogTemp(),_textEle=_createEle.find(":text");_textEle.val(Util.HTMLDeCode(node.get("text"))),_createEle.find(":hidden[name=id]").val(node.get("id")),_createEle.closest(".tree-item").removeClass("tree-update"),_createEle.addClass("create-active"),_createEle.removeClass("create-root"),node.element.addClass("tree-update"),node.element.append(_createEle),_textEle.focus().select()}},getAddCatalogTemp:function(level,pid){var self=this;if(!this._addCatalogTemp){var _html='<span class="tree-create">';_html+='<form class="form" action="/article/create" method="post" autocomplete="off">',_html+='<input name="id" type="hidden" value="0"/>',_html+='<input name="pid" type="hidden" value="0"/>',_html+='<input name="parse" type="hidden" value="1">',_html+='<input name="book_id" type="hidden" value="'+Config.get("bookId")+'"/>',_html+='<label class="w-text text-s"><input class="text-input" name="title" type="text" placeholder="文章标题" /></label>',_html+='<button type="submit" class="submit icon-check" title="保存"></button>',_html+="</form>",_html+='<b class="delete icon-trash" title="取消"></b>',_html+="</span>",this._addCatalogTemp=$(_html),this._addCatalogTemp.click(function(event){event.stopPropagation()}),this._addCatalogTemp.find("form").submitForm({autoValidate:!1,validate:[{name:"title",rule:"require",msg:"文章标题不能为空！",onAfter:function(status){status||$.dialog.error(this.msg)}}],onBefore:function(options){options.data.title=$.trim(options.data.title)},onAfter:function(data,options){if(data.status){if(options.data.title=Util.HTMLEnCode(options.data.title),"add"==self.catalogUpdateMode){self._addCatalogTemp.removeClass("create-active");var _data=self.formartData($.extend(options.data,data.data));self.menu.createNode(_data);var _node=self.menu.nodes.find(data.data.id);_node&&_node.selected(!0),self.findEmpty(),self.updateReadProgress()}else{var _node=self.menu.nodes.find(options.data.id);_node.setText(options.data.title),self.articleSearchResultItems.filter("[data-id="+options.data.id+"]").text(options.data.title),self.articleCollectItems.filter("[data-did="+options.data.id+"]").find(".text").text(options.data.title),self.currentArticleId==options.data.id&&self.setArticleTitle(options.data.title),_node.element.closest(".tree-item").removeClass("tree-update").find(".tree-create").removeClass("create-active")}self.updateJumpLink()}else $.dialog.error(data.info)}}),this._addCatalogTemp.find("[name=title]").thinkkeyboard({"ctrl+s":function(){return self._addCatalogTemp.find("form").submit(),!1}}),this._addCatalogTemp.find(".delete").click(function(event){self.cancelCatalogEdit(),event.stopPropagation()}),this.articleMenuEle.click(function(event){event.stopPropagation()}),$("body").click(function(){self._addCatalogTemp.is(":visible")&&(self._addCatalogTemp.find("[name=title]").val()?self._addCatalogTemp.find("form").submit():self._addCatalogTemp.find(".delete").click())})}if("add"==this.catalogUpdateMode?this._addCatalogTemp.find("form").attr("action",Config.get("createUrl")):this._addCatalogTemp.find("form").attr("action",Config.get("updateTitleUrl")),level){for(var _block="",i=0;level>i;i++)_block+='<i class="tree-block"></i>';this._addCatalogTemp.find("[name=pid]").val(pid||0),this._addCatalogTemp.find("[name=title]").val(""),this._addCatalogTemp.find(".tree-block").remove().end().prepend(_block),this._addCatalogTemp.addClass("create-active")}return this._addCatalogTemp},cancelCatalogEdit:function(){this._addCatalogTemp&&(this._addCatalogTemp.removeClass("create-active"),this._addCatalogTemp.closest(".tree-item").removeClass("tree-update"))},fullScreen:function(status){this.isFullScreen=status?!0:!1,this.isFullScreen?this.manualEle.addClass("manual-fullscreen-active"):this.manualEle.removeClass("manual-fullscreen-active"),$.cookie("manualIsFullScreen",this.isFullScreen,{path:this.manualUrl})},findSearchResult:function(){this.articleSearchResultItems=this.articleSearchEle.find(".search-list li"),this.articleSearchResultItems.length?this.articleSearchEle.find(".search-result").find(".search-empty").remove():this.articleSearchEle.find(".search-result").html('<div class="search-empty"><i class="image"></i><b class="text">暂无相关搜索结果！</b></div>')},confrimCancelUpdate:function(defineCallback,cancelCallback){var self=this;if("edit"==this.currentMode){var _content=this.articleEditContentEle.val();this.currentEditContent!=_content?$.dialog.confirm("确定取消编辑吗？",function(action){1==action?(self.removeArticleEditFromLocal(self.currentArticleId),$.isFunction(defineCallback)&&defineCallback.call(self)):$.isFunction(cancelCallback)&&cancelCallback.call(self)}):$.isFunction(defineCallback)&&defineCallback.call(this)}else $.isFunction(defineCallback)&&defineCallback.call(this);arguments.callee._inited||($(window).on("beforeunload",function(event){var _content=self.articleEditContentEle.val();return"edit"==self.currentMode&&self.currentEditContent!=_content?(event.returnValue="确定取消编辑吗？",event.returnValue):void 0}),arguments.callee._inited=!0)},returnManualHome:function(){var _firstNode=this.menu.nodes.first();_firstNode&&(_firstNode.selected(!0,!1,!1),this.setMode("view",!1))},addCollectArticle:function(id){var _node=this.menu.getNode(id);if(_node){var _id=_node.get("id");this.collectEle.hasClass("loading")||(this.collectEle.addClass("loading"),$.ajax({url:Config.get("addCollectUrl"),data:{doc_id:_id,book_id:this.manualId},context:this,type:"post",success:function(data){data.status?(this.createCollectArticle([data.data]),this.findCollectArticle(),this.hasCurrentCollectArticle(_id)):$.dialog.error(data.info)},complete:function(){this.collectEle.removeClass("loading")}}))}},delCollectArticle:function(id){var _ele=this.articleCollectListEle.find("li[data-id="+id+"]"),_del=_ele.find(".delete"),_did=_ele.data("did");_del.hasClass("loading")||this.collectEle.hasClass("loading")||(_del.addClass("loading"),this.collectEle.addClass("loading"),$.ajax({url:Config.get("delCollectUrl"),data:{id:id},type:"post",context:this,success:function(data){if(data.status){if("collect"==this.currentMode&&this.currentArticleId==_did){var _jump=_ele.next();_jump.length||(_jump=_ele.prev())}_ele.remove();for(var i=0;i<this._collectArticleList.length;i++)if(this._collectArticleList[i].id==id){this._collectArticleList.splice(i,1);break}this.findCollectArticle(),_jump&&_jump.length?_jump.click():(this.hasCurrentCollectArticle(_did),this.updateJumpLink())}else $.dialog.error(data.info)},complete:function(){_del.removeClass("loading"),this.collectEle.removeClass("loading")}}))},createCollectArticle:function(id,did){var self=this,_arr=[];_arr=$.isArray(id)?id:[{doc_id:did,id:id}],this._collectArticleList=this._collectArticleList.concat(_arr);for(var i=0;i<_arr.length;i++){var _node=this.menu.getNode(_arr[i].doc_id);if(_node){var _list=this.articleCollectListEle.children("ul");_list.length||(_list=$('<ul class="collect-list"></ul>').appendTo(this.articleCollectListEle),_list.delegate("li","click",function(){var _ele=$(this);self.confrimCancelUpdate(function(){self.targetPageArticle(_ele.data("did"))})}),_list.delegate(".delete","click",function(){var _ele=$(this);return self.confrimCancelUpdate(function(){self.delCollectArticle(_ele.data("id"))}),!1}));var _item=$('<li data-did="'+_arr[i].doc_id+'" data-id="'+_arr[i].id+'"><span class="text">'+_node.get("text")+'</span><b class="delete icon-trash" data-id="'+_arr[i].id+'" title="取消收藏"></b></li>');_list.append(_item)}}},getCollectArticle:function(callback){$.ajax({url:Config.get("getCollectUrl"),data:{book_id:this.manualId},type:"post",context:this,success:function(data){data.status&&(this.createCollectArticle(data.data),this.findCollectArticle()),$.isFunction(callback)&&callback.call(this,data)},complete:function(){}})},findCollectArticle:function(){this.articleCollectItems=this.articleCollectListEle.find(".collect-list li"),this.articleCollectItems.length?this.articleCollectListEle.find(".collect-empty").remove():this.articleCollectListEle.find(".collect-empty").length||this.articleCollectListEle.append('<div class="collect-empty"><div class="empty-inner"><i class="image"></i><b class="text">暂无相关收藏内容！</b></div></div>')},hasCurrentCollectArticle:function(id){var _status=!1;if("undefined"==typeof id&&(id=this.menu.getSelected(),id=id.get("id")),$.isNumeric(id))for(var i=0;i<this._collectArticleList.length;i++)if(this._collectArticleList[i].doc_id==id){_status=!0;break}return this.currentArticleId!=id?_status:void(_status?(this.collectEle.find(".cancel").length||this.collectEle.append($('<b class="cancel">取消</b>')),this.collectEle.attr("title","取消收藏").addClass("toggle")):(this.collectEle.find(".text").text("收藏"),this.collectEle.attr("title","收藏").removeClass("toggle")))},setSetting:function(status){this._isSetting="undefined"==typeof status?!0:status?!0:!1,this._isSetting?this.manualEle.addClass("manual-setting-active"):(this.manualEle.removeClass("manual-setting-active"),this.cancelCatalogEdit()),this.updateCatalogSize()},filterContent:function(content){var _content=content;return _content=_content.replace(/<[a-z A-Z]+.*?>/gi,function(str,index){return str.replace(/(on[\S]+?=)/gi,"data-$1")}),_content||content},getUserFollowManual:function(callback){$.ajax({url:Config.get("getFollowUrl"),context:this,type:"post",success:function(data){data.status&&(this.userFollowManual=data.data),$.isFunction(callback)&&callback.call(this)}})},inUserFollowManual:function(){for(var i=0;i<this.userFollowManual.length;i++)if(this.manualId==this.userFollowManual[i])return i;return-1},findUserFollowManual:function(){if(Config.get("memberIsAuther"))this.manualFollowEle.addClass("data-disabled").find(".text").text("关注数");else{var _index=this.inUserFollowManual();this.manualFollowEle.find(".text").text(_index>=0?"取消关注":"加关注")}},addFollowManual:function(){this.manualFollowEle.hasClass("loading")||this.manualFollowEle.hasClass("data-disabled")||(this.manualFollowEle.addClass("loading"),$.ajax({url:Config.get("confirmFollowUrl"),data:{book_id:this.manualId},context:this,type:"post",success:function(data){data.status?(this.userFollowManual.push(this.manualId),this.manualFollowEle.find(".number").text(++this.followTotal),this.findUserFollowManual(),$.dialog.success(data.info)):$.dialog.error(data.info)},complete:function(){this.manualFollowEle.removeClass("loading")}}))},cancelFollowManual:function(){this.manualFollowEle.hasClass("loading")||this.manualFollowEle.hasClass("data-disabled")||(this.manualFollowEle.addClass("loading"),$.ajax({url:Config.get("cancelFollowUrl"),data:{book_id:this.manualId},context:this,type:"post",success:function(data){if(data.status){var _index=this.inUserFollowManual();this.manualFollowEle.find(".number").text(--this.followTotal),this.userFollowManual.splice(_index,1),this.findUserFollowManual(),$.dialog.success(data.info)}else $.dialog.error(data.info)},complete:function(){this.manualFollowEle.removeClass("loading")}}))},topbarAuto:function(barEle,must){var _manualEle=this.manualEle,_safe=150,_timer=null,_doc=$(document),_prevScroll=_doc.scrollTop(),_self=this;_doc.scroll(function(){clearTimeout(_timer),_timer=setTimeout(function(){if(_self.isFullScreen||must===!0){var _scroll=_doc.scrollTop();_safe>=_scroll?_manualEle.removeClass("manual-auto-open manual-auto-close"):_scroll>_prevScroll?_manualEle.addClass("manual-auto-close").removeClass("manual-auto-open"):_manualEle.addClass("manual-auto-open").removeClass("manual-auto-close"),_prevScroll=_scroll}},90)})},isLocalStorage:window.localStorage?!0:!1,setArticleEditToLocal:function(id,content){if(this.isLocalStorage){var _data=this.getArticleEditFromLocal(id);_data!=content&&localStorage.setItem("manual-edit-"+this.manualId+"-"+id,content)}},getArticleEditFromLocal:function(id){return this.isLocalStorage?localStorage.getItem("manual-edit-"+this.manualId+"-"+id):void 0},removeArticleEditFromLocal:function(id){this.isLocalStorage&&localStorage.removeItem("manual-edit-"+this.manualId+"-"+id)},findArticleEditHasLocal:function(id,success,error){if(this.isLocalStorage){var _data=this.getArticleEditFromLocal(id);null!=_data?$.isFunction(success)&&success.call(this,_data):$.isFunction(error)&&error.call(this)}else $.isFunction(error)&&error.call(this)},updateReadProgress:function(){var _node=this.menu.getNode(this.currentArticleId),_index=this.menu.nodes.getIndex(_node)+1,_total=this.menu.nodes.getTotal(),_progress=_index/_total*100;this.manualProgressEle||(this.manualProgressEle=$('<div class="manual-progress"><b class="progress-bar"></b></div>').appendTo(this.manualEle.find(".manual-body")),this.manualProgressBarEle=this.manualProgressEle.find(".progress-bar")),this.manualProgressBarEle.width(_progress+"%")},urlGetBookParam:function(){var _param={},_block1=location.href.split("#"),_block2=location.pathname.split("/");return _block1[1]&&_block1[1].toString().indexOf("-")<0?_param.article=_block1[1]:_param.article=_block2[3],_param.book=_block2[2],_param},mobileStart:function(){var self=this;this.manualEle.addClass("manual-mobile"),this.topbarAuto(this.manualTopbarEle,!0),function(){var _touchLeft=0,_touchTop=0,_actualLeft=0,_actualTop=0,_moveStatus=!1,_dir="left",_ratio=0,_speed=0,_startTime=(new Date).getTime(),_distance=120,_doc=$(document);document.addEventListener("touchstart",function(event){_touchLeft=event.touches[0].pageX,_touchTop=_doc.scrollTop(),_startTime=(new Date).getTime()},!1),document.addEventListener("touchmove",function(event){_actualLeft=event.touches[0].pageX-_touchLeft,_actualTop=_doc.scrollTop()-_touchTop,_moveStatus=!0},!1),document.addEventListener("touchend",function(event){_moveStatus&&(_endTime=(new Date).getTime(),_ratio=(_endTime-_startTime)/1e3,_speed=Math.abs(_actualLeft/_ratio),_dir=_actualLeft>=0?"right":"left",_actualLeft=Math.abs(_actualLeft),_actualTop=Math.abs(_actualTop),50>_actualTop&&_distance<Math.abs(_actualLeft)&&("left"==_dir?self.downPageAritcle():self.upPageAritcle()),_moveStatus=!1)},!1)}()}})}),define("home/bookmember/index",function(require,exports,module){return require("component/select2/dist/css/select2.css"),require("component/select2/dist/js/select2.full.min"),Class({selectMemberEle:$("#selectMember"),currentManualId:Config.get("currentManual"),memberListEle:$("#memberList"),maxMemberNum:Config.get("maxSelectNumber"),initial:function(){var self=this;this.selectMemberEle.click(function(){var $html,dialog;$html=$("<div/>").addClass("m-manual-add").html('<form class="w-form form-horizon dialog-form" method="post"><div class="form-item"><span class="form-label">用户</span><div class="form-target"><label class="w-select select-m"><select class="select-input" name="user" multiple="multiple"></select></label></div></div><div class="form-item"><span class="form-label">角色</span><div class="form-target"><label class="w-select select-m"><select class="select-input" name="role"></select></label></div></div></div>'),dialog=$.dialog.form($html,{title:"添加成员",onCreate:function(){var _form=this.bodyElement.find("form");_form.append($('<input type="hidden" name="book_id" value="'+self.currentManualId+'">')),_form.attr("action",Config.get("createUserUrl")),_form.find('[name="role"]').append(function(){var options="";return $.each(Config.get("accessRoles"),function(k,v){options+="<option value='"+v+"'>"+k+"</option>"}),options}),_form.find('[name="user"]').select2({placeholder:"选择用户",width:232,multiple:!0,ajax:{url:Config.get("searchUserUrl"),data:function(params){return{nickname:params.term}},processResults:function(data){return{results:data.info}}},templateResult:function(repo){return repo.nickname},templateSelection:function(repo){return repo.nickname||repo.text}}),_form.submitForm({onBefore:function(options){var user=_form.find('[name="user"]').val();return user?void(options.data.user=user):($.dialog.error("请选择用户"),!1)},onAfter:function(data,options){data.status?window.location.reload():$.dialog.error(data.info)}})}})}),this.memberListEle.delegate(".delete","click",function(){var _id=$(this).closest(".m-member-item").data("id"),$this=$(this);$.dialog.confirm("确定要删除该用户吗？",function(action){1==action&&$.ajax({url:Config.get("delMemberPath"),data:{id:_id,book_id:self.currentManualId},context:this,type:"post",success:function(data){data.status?$this.closest(".m-member-item").remove():$.dialog.error(data.info)}})})}),this.memberListEle.delegate(".leave","click",function(){$.dialog.confirm("确定要退出吗？",function(action){1==action&&$.ajax({url:Config.get("leaveUserUrl"),data:{book_id:self.currentManualId},context:this,type:"post",success:function(data){data.status?window.location.href="/user/book":$.dialog.error(data.info)}})})}),this.memberListEle.delegate(".role>select","change",function(){var _id=$(this).closest(".m-member-item").data("id");$.ajax({url:Config.get("setMemberRolePath"),data:{id:_id,role:$(this).val(),book_id:self.currentManualId},context:this,type:"post",success:function(data){data.status?$.dialog.success(data.info):$.dialog.error(data.info)}})})}})}),define("home/compatible",function(require,exports,module){Class({initial:function(){var self=this;this.hasPlaceholderSupport()||this.placeholder($("[placeholder]")),$(document).on("onCompatible",function(event,name,element){"placeholder"==name&&element&&!self.hasPlaceholderSupport()&&self.placeholder(element)})},placeholder:function(element){require.async("component/jquery.placeholder",function(){element.placeholder()})},hasPlaceholderSupport:function(){var input=document.createElement("input");return"placeholder"in input}})}),define("home/globle",function(require,exports,module){if("undefined"!=typeof nonsupportIE&&nonsupportIE===!0)return!1;var Template=require("common/extend/template");require("component/jquery.loading"),require("component/jquery.drop"),require("common/extend/dialog/dialog"),require("common/library/function"),Template.setData({STATIC:Config.get("STATIC"),ROOT:Config.get("ROOT")}),Template.helper("getMemberAvatar",Util.getMemberAvatar),require("home/compatible"),require("component/hint.css/hint.min.css"),Class({topbarSearchEle:$("#topbarSearch"),placeholderImage:Config.get("STATIC")+"/home/image/20.png",initial:function(){var self=this;$(".e-cover img").each(function(){var _orgImage=$(this),_newImg=$("<img/>");_newImg.bind("error",function(){_orgImage.attr("src",self.placeholderImage),_orgImage.parent().addClass("cover-error")}),_newImg.attr("src",$(this).attr("src"))}),$(".m-manual-info .cover img").each(function(){var _orgImage=$(this),_newImg=$("<img/>");_newImg.bind("error",function(){_orgImage.attr("src",self.placeholderImage),_orgImage.closest(".cover").addClass("cover-error")}),_newImg.attr("src",$(this).attr("src"))}),this.topbarSearchEle.submit(function(){var _text=$(this).find(":text");return $.trim(_text.val())?void 0:(Util.wranStyle(_text,"text-wran"),!1)}),function(){var _page=$(".m-page"),_header=$('<b class="e-hander">搜索</b>').appendTo(_page.find(".page-head"));_header.click(function(){_page.hasClass("page-head-toggle")?(_page.removeClass("page-head-toggle"),_header.text("搜索")):(_page.addClass("page-head-toggle"),_header.text("取消"))})}(),Config.get("isLogin")&&this.checkNewNotification(),$(".m-navg-toggle").click(function(){$(".m-page .page-head .left .m-navg").slideToggle()})},checkNewNotification:function(){if(Config.get("checkNotification")){var _self=this;$.ajax({url:"/user/notification/check",type:"get",success:function(status){status>0?$(".page-head .navg-link .icon-email").addClass("new"):$(".page-head .navg-link .icon-email").removeClass("new"),setTimeout(function(){_self.checkNewNotification.apply(_self)},6e3)}})}}})}),define("home/index/forward",function(require,exports,module){require("component/fullPage/vendors/jquery.slimscroll.min"),require("component/fullPage/jquery.fullPage"),Class({initial:function(){var _page=$(".m-page"),_pageAnchors=["one","two","three","four","five","six","seven"];$("#fullpage").fullpage({anchors:_pageAnchors,navigation:!0,navigationPosition:"right",onLeave:function(leavingSection,leavingSectionIndex,sectionIndex,yMovement){$.each(_pageAnchors,function(i,v){_page.removeClass("page-fullpage-"+v)}),_page.addClass("page-fullpage-"+_pageAnchors[leavingSectionIndex-1])}})}})}),define("home/index/index",function(require,exports,module){require("component/carousel/owl-carousel/owl.carousel.css"),require("component/carousel/owl-carousel/owl.theme.css"),require("component/carousel/owl-carousel/owl.carousel.min"),Class({bannerSlideEle:$("#bannerSlide"),manualRecome1Ele:$("#manualRecome1"),manualRecome2Ele:$("#manualRecome2"),manualRecome3Ele:$("#manualRecome3"),initial:function(){this.bannerSlideEle.owlCarousel({navigation:!0,slideSpeed:300,paginationSpeed:400,autoPlay:!0,singleItem:!0})}})}),define("home/manage/book",function(require,exports,module){require("component/select2/dist/css/select2.css"),require("component/select2/dist/js/select2.full.min"),Class({namespaceEle:$("#namespace"),manualListEle:$(".list-right"),initial:function(){this.namespaceEle.select2({placeholder:"所属用户",allowClear:!0,ajax:{url:"/admin/user/search",data:function(params){return{nickname:params.term}},processResults:function(data){return{results:data.info}}},templateResult:function(repo){return repo.nickname},templateSelection:function(repo){return repo.nickname||repo.text}}),this.manualListEle.delegate(".delete","click",function(){var _ele=$(this),_id=$(this).data("id");return $.dialog.confirm("确定删除吗",function(action){1==action&&$.ajax({url:_ele.data("href"),data:{book_id:_id},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}})}),!1}),this.manualListEle.delegate(".cover","click",function(){var _ele=$(this),_id=$(this).data("id");
return $.ajax({url:_ele.data("href"),data:{book_id:_id},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}}),!1}),this.manualListEle.delegate(".recommend","click",function(){var _ele=$(this),_id=$(this).data("id");return $.ajax({url:_ele.attr("href"),data:{book_id:_id},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}}),!1})}})}),define("home/manage/config/index",function(require,exports,module){require("component/select2/dist/css/select2.css"),require("component/select2/dist/js/select2.full.min"),Class({namespaceEle:$("#namespace"),manualListEle:$(".list-right"),initial:function(){this.namespaceEle.select2({placeholder:"所属用户",allowClear:!0,ajax:{url:"/admin/user/search",data:function(params){return{nickname:params.term}},processResults:function(data){return{results:data.info}}},templateResult:function(repo){return repo.nickname},templateSelection:function(repo){return repo.nickname||repo.text}}),this.manualListEle.delegate(".delete","click",function(){var _ele=$(this),_id=$(this).data("id");return $.dialog.confirm("确定删除吗",function(action){1==action&&$.ajax({url:_ele.data("href"),data:{id:_id},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}})}),!1})}})}),define("home/manage/coupon/index",function(require,exports,module){require("component/select2/dist/css/select2.css"),require("component/select2/dist/js/select2.full.min"),Class({namespaceEle:$("#namespace"),manualListEle:$(".list-right"),initial:function(){this.namespaceEle.select2({placeholder:"所属用户",allowClear:!0,ajax:{url:"/admin/user/search",data:function(params){return{nickname:params.term}},processResults:function(data){return{results:data.info}}},templateResult:function(repo){return repo.nickname},templateSelection:function(repo){return repo.nickname||repo.text}}),this.manualListEle.delegate(".delete","click",function(){var _ele=$(this),_id=$(this).data("id");return $.dialog.confirm("确定删除吗",function(action){1==action&&$.ajax({url:_ele.data("href"),data:{id:_id},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}})}),!1})}})}),define("home/manage/coupon/make",function(require,exports,module){require("component/select2/dist/css/select2.css"),require("component/select2/dist/js/select2.full.min"),Class({namespaceEle:$("#namespace"),submitEle:$(".btn-input[type=submit]"),formEle:$(".list-left form"),clearMakeEle:$(".btn-clear-make"),initial:function(){var self=this;this.namespaceEle.select2({placeholder:"所属用户",allowClear:!0,ajax:{url:"/admin/user/search",data:function(params){return{nickname:params.term}},processResults:function(data){return{results:data.info}}},templateResult:function(repo){return repo.nickname},templateSelection:function(repo){return repo.nickname||repo.text}}),this.submitEle.on("click",function(){if("生成中..."!==self.submitEle.text()){self.submitEle.text("生成中...");var data=self.formEle.serialize();return $.post(self.formEle.attr("action"),data,function(result){result.status?location.reload():(self.submitEle.text("生成"),alert(result.info))}),!1}}),this.clearMakeEle.on("click",function(){return"清理中..."!==self.clearMakeEle.text()?($.dialog.confirm("确定要清理吗? 清理后将不能下载",function(action){1===action&&(self.clearMakeEle.text("清理中..."),$.post(self.clearMakeEle.data("url"),null,function(result){result.status?location.reload():(self.clearMakeEle.text("清除历史"),alert(result.info))}))}),!1):void 0})}})}),define("home/manage/email",function(require,exports,module){require("common/extend/thinkeditor/thinkeditor"),Class({emailContentEle:$("#emailContent"),emailFormEle:$("#emailForm"),initial:function(){this.getEditor(),this.emailFormEle.submitForm({onAfter:function(data){data.status?$.dialog.success(data.info,function(){location.reload()}):"string"==typeof data.info&&$.dialog.error(data.info)}})},getEditor:function(){var self=this;return this._editor||(this._editor=$.thinkeditor(self.emailContentEle.find("textarea").thinkeditor({style:"manual",items:"h1,h2,h3,h4,-,bold,italic,-,ul,ol,-,link,image,code,hr,blockquote,table,-,preview,fullscreen",uploader:{url:Config.get("uploadImageUrl")},preview:!1,onSave:function(){self.emailFormEle.submit()},onPreview:function(status){self._editor.preview(status)}})),self.emailContentEle.addClass("editor-markdown")),this._editor}})}),define("home/manage/order/index",function(require,exports,module){require("component/select2/dist/css/select2.css"),require("component/select2/dist/js/select2.full.min"),Class({namespaceEle:$("#namespace"),manualListEle:$(".list-right"),initial:function(){this.namespaceEle.select2({placeholder:"所属用户",allowClear:!0,ajax:{url:"/admin/user/search",data:function(params){return{nickname:params.term}},processResults:function(data){return{results:data.info}}},templateResult:function(repo){return repo.nickname},templateSelection:function(repo){return repo.nickname||repo.text}}),this.manualListEle.delegate(".delete","click",function(){var _ele=$(this),_id=$(this).data("id");return $.dialog.confirm("确定删除吗?",function(action){1===action&&$.ajax({url:_ele.data("href"),data:{id:_id},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}})}),!1}),this.manualListEle.delegate(".pay","click",function(){var _ele=$(this),_id=$(this).data("id");return $.dialog.confirm("确定要设为已支付吗?",function(action){1===action&&$.ajax({url:_ele.data("href"),data:{id:_id},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}})}),!1})}})}),define("home/manage/special/detail",function(require,exports,module){require("component/select2/dist/css/select2.css"),require("component/select2/dist/js/select2.full.min"),require("component/Sortable/jquery.fn.sortable.min"),Class({selectBookEle:$("#selectBook"),currentSpecialId:Config.get("specialId"),itemListEle:$(".content-right ul"),initial:function(){var self=this;this.selectBookEle.click(function(){var $html,dialog;$html=$("<div/>").addClass("m-manual-add").html('<form class="w-form form-horizon dialog-form" method="post"><div class="form-item"><span class="form-label">文档</span><div class="form-target"><label class="w-select select-m"><select class="select-input" name="item" multiple="multiple"></select></label></div></div></div>'),dialog=$.dialog.form($html,{title:"添加文档",onCreate:function(){var _form=this.bodyElement.find("form");_form.append($('<input type="hidden" name="special_id" value="'+self.currentSpecialId+'">')),_form.append($('<input type="hidden" name="type" value="1">')),_form.attr("action",Config.get("addItemUrl")),_form.find('[name="item"]').select2({placeholder:"选择文档",width:232,multiple:!0,ajax:{url:"/autocomplete/book",data:function(params){return{search:params.term}},processResults:function(data){return{results:data}}},templateResult:function(repo){return repo.id?$('<div style="overflow: hidden;"><img style="float: left;" width="40" src="'+repo.cover+'" /><span style="margin-left: 50px;font-style: normal;display: block;line-height: 1.5;">'+repo.title+"</span></div>"):repo.text},templateSelection:function(repo){return repo.title||repo.text}}),_form.submitForm({onBefore:function(options){var item=_form.find('[name="item"]').val();return item?void(options.data.item=item):($.dialog.error("请选择文档"),!1)},onAfter:function(data,options){data.status?window.location.reload():$.dialog.error(data.info)}})}})}),this.itemListEle.delegate(".item-delete","click",function(){var _ele=$(this),_id=$(this).data("id"),_type=$(this).data("type");return $.dialog.confirm("确定删除吗",function(action){1==action&&$.ajax({url:_ele.attr("href"),data:{special_id:self.currentSpecialId,id:_id,type:_type},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}})}),!1}),this.itemListEle.sortable({group:$(this).data("type"),onUpdate:function(evt){var items=this.toArray();$.ajax({url:Config.get("sortItemUrl"),data:{item:items},type:"post",success:function(data){data.status?$.dialog.success(data.info):$.dialog.error(data.info)}})}})}})}),define("home/manage/special/index",function(require,exports,module){Class({manualListEle:$(".list-right"),initial:function(){this.manualListEle.delegate(".delete","click",function(){var _ele=$(this),_id=$(this).data("id");return $.dialog.confirm("确定删除吗",function(action){1==action&&$.ajax({url:_ele.data("href"),data:{special_id:_id},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}})}),!1})}})}),define("home/manage/special/update",function(require,exports,module){Class({uploadCoverFormEle:$("#uploadCoverForm"),uploadCoverEle:$("#uploadCover"),manualInfoCoverEle:$(".m-manual-info .cover img"),uploadNumber:0,specialFormEle:$("#specialUpdateForm"),initial:function(){var self=this;this.specialFormEle.submitForm({autoValidate:!1,onAfter:function(data,options){data.status?($.dialog.success(data.info),data.url&&(window.location.href=data.url)):"string"==typeof data.info&&$.dialog.error(data.info)}}),this.uploadCoverEle.click(function(){self.cutImageDialog?self.cutImageDialog.open():(self.cutImageDialog=$.dialog('<div class="m-dialog-loading"><b class="loading-text">裁剪组件加载中...</b></div>',{title:"封面裁剪",cache:!0}),require.async("common/module/cutImage",function(cutImage){self.cutCover=new cutImage({cls:"m-cover-cutting",cutWidth:173,cutHeight:231,boxWidth:420,boxHeight:300,uploadUrl:Config.get("uploadCoverUrl"),saveCutUrl:Config.get("saveCoverUrl"),onSuccess:function(data){var _image=self.uploadCoverEle.find("img"),_input=self.uploadCoverEle.find("input"),_src=data.data.url.indexOf("?")>=0?data.data.url+"&v="+self.uploadNumber:data.data.url+"?v="+self.uploadNumber;self.cutImageDialog.close(),self.uploadNumber++,_image.length||(_image=$("<img/>"),self.uploadCoverEle.find(".upload-image").html(_image)),self.manualInfoCoverEle.attr("src",_src),_image.attr("src",_src),_input.val(data.data.url)}}),self.cutImageDialog.content(self.cutCover.getHtml()),self.cutImageDialog.offset(self.cutImageDialog._options.offset[0],self.cutImageDialog._options.offset[1])}))})}})}),define("home/manage/team/edit",function(require,exports,module){Class({teamFormEle:$("#teamForm"),initial:function(){this.teamFormEle.submitForm({autoValidate:!1,onAfter:function(data,options){data.status?$.dialog.success("修改成功"):"string"==typeof data.info&&$.dialog.error(data.info)}})}})}),define("home/manage/template",function(require,exports,module){require("component/select2/dist/css/select2.css"),require("component/select2/dist/js/select2.full.min"),Class({namespaceEle:$("#namespace"),manualListEle:$(".template_content"),uploadCoverFormEle:$("#uploadCoverForm"),uploadCoverEle:$("#uploadCover"),manualInfoCoverEle:$("#templatePreview img"),initial:function(){var self=this;this.namespaceEle.select2({placeholder:"所属用户",allowClear:!0,ajax:{url:"/admin/user/search",data:function(params){return{nickname:params.term}},processResults:function(data){return{results:data.info}}},templateResult:function(repo){return repo.nickname},templateSelection:function(repo){return repo.nickname||repo.text}}),this.uploadCoverEle.click(function(){self.cutImageDialog?self.cutImageDialog.open():(self.cutImageDialog=$.dialog('<div class="m-dialog-loading"><b class="loading-text">裁剪组件加载中...</b></div>',{title:"封面裁剪",cache:!0}),require.async("common/module/cutImage",function(cutImage){self.cutCover=new cutImage({cls:"m-cover-cutting",cutWidth:175,cutHeight:130,boxWidth:525,boxHeight:393,uploadUrl:Config.get("uploadCoverUrl"),uploadParam:{template_id:Config.get("templateId"),title:Config.get("templateTitle")},saveCutUrl:Config.get("saveCoverUrl"),saveCutParam:{template_id:Config.get("templateId"),title:Config.get("templateTitle")},onSuccess:function(data){var _image=self.uploadCoverEle.find("img"),_src=data.data.url.indexOf("?")>=0?data.data.url+"&t="+self.uploadNumber:data.data.url+"?t="+self.uploadNumber;self.cutImageDialog.close(),self.uploadNumber++,_image.length||(_image=$("<img/>"),self.uploadCoverEle.find(".upload-image").html(_image)),self.manualInfoCoverEle.attr("src",_src),_image.attr("src",_src)}}),self.cutImageDialog.content(self.cutCover.getHtml()),self.cutImageDialog.offset(self.cutImageDialog._options.offset[0],self.cutImageDialog._options.offset[1])}))}),this.manualListEle.delegate(".delete","click",function(){var _ele=$(this),_id=$(this).data("id"),_tips=$(this).data("tips");return $.dialog.confirm(_tips,function(action){1==action&&$.ajax({url:_ele.data("href"),data:{id:_id},type:"post",success:function(data){data.status?location.href=data.url:$.dialog.error(data.info)}})}),!1})}})}),define("home/manage/user/detail",function(require,exports,module){require("component/semantic-ui-tab/tab.min"),Class({tabEle:$(".nav-tabs .navg-item"),initial:function(){this.tabEle.tab({selector:{tabs:".tab-content"}})}})}),define("home/manage/user/edit",function(require,exports,module){Class({userFormEle:$("#userForm"),initial:function(){var self=this;this.userFormEle.submitForm({autoValidate:!1,onBefore:function(data,options){data.data.is_admin=self.userFormEle.find('[name="is_admin"]').is(":checked")?1:0},onAfter:function(data,options){data.status?$.dialog.success("修改成功"):"string"==typeof data.info&&$.dialog.error(data.info)}})}})}),define("home/order/buy",function(require,exports,module){return require("component/jquery.spinner"),Class({initial:function(){var self=this;this.buyFormEle=$("#buyForm"),this.selectMonthEle=$("#selectMonth"),this.selectMonthCycleEle=$("#selectMonthCycle"),this.selectPriceEle=$("#selectPrice"),this.serverDate=Util.getDate(1e3*Config.get("buyStartTime")),this.buyPrice=Config.get("buyPrice"),this.startDate=Util.formartDate(this.serverDate,"yyyy-MM-dd"),this.endDate=this.serverDate,this.endTime=this.endDate.getTime(),this.endMonth=this.endDate.getMonth(),this.buyFormEle.submit(function(){$.dialog.confirm("确定支付已完成？",function(action){1==action&&location.reload()})}),this.selectMonthEle.spinner({minValue:1,maxValue:Number(Config.get("buyMonth")),onChange:function(){var _value=Number(this.value());self.countDate(_value),self.countPrice(_value)},onCreate:function(){this.options.onChange.call(this)}})},countDate:function(month){this.endDate.setTime(this.endTime),this.endDate.setMonth(this.endMonth+month),this.selectMonthCycleEle.html("从"+this.startDate+"开始到"+Util.formartDate(this.endDate,"yyyy-MM-dd")+"截止")},countPrice:function(month){this.selectPriceEle.val((this.buyPrice*month).toFixed(2))},instantiation:!1})}),define("home/order/index",function(require,exports,module){Class({orderListEle:$("#orderList"),initial:function(){this.orderListEle.delegate(".pay","click",function(){return $(this).hasClass("disabled")?!1:void $.dialog.confirm("确定支付已完成？",function(action){1==action&&location.reload()})}),this.orderListEle.delegate(".cancel","click",function(){var ele=$(this);return $(this).hasClass("disabled")||$.dialog.confirm("确定取消订单吗？",function(action){1==action&&($.dialog.loading("操作中..."),$.ajax({url:ele.attr("href"),type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)},complete:function(){$.dialog.get("loading").close()}}))}),!1}),this.orderListEle.delegate(".delete","click",function(){var ele=$(this);return $(this).hasClass("disabled")||$.dialog.confirm("确定删除订单吗？",function(action){1==action&&($.dialog.loading("操作中..."),$.ajax({url:ele.attr("href"),type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)},complete:function(){$.dialog.get("loading").close()}}))}),!1})}})}),define("home/projects/comments",function(require,exports,module){var Doing=require("common/module/doing"),Comment=require("common/module/comment");require("component/prettify/prettify"),require("component/prettify/prettify.css"),Class({doingTabEle:$("#doingTab"),doingListEle:$("#doingList"),commentDoingListEle:$("#commentDoingList"),initial:function(){this.commentDoing=new Doing({activeItemTpl:2,param:{book_id:Config.get("currentManual")},url:Config.get("commentDoingPath"),tempData:{jumpPath:Config.get("jumpPath"),isShowManual:!1},doingListEle:this.commentDoingListEle,parseData:function(data){for(var i=0;i<data.length;i++)"content"in data[i]&&(data[i].content=Comment.replaceCode(data[i].content));return data},onAddDoingItem:function(item){prettyPrint()}}),this.commentDoingListEle.delegate(".m-replace-code .code-placehoder","click",function(){var _content='<div class="m-code-view">';_content+=$(this).closest(".m-replace-code").find(".code-hide").html(),_content+="</div>",$.dialog(_content,{title:"查看代码",cache:"viewCode"})})}})}),define("home/projects/common",function(){Class({manualReleaseEle:$("#manualRelease"),initial:function(){this.manualReleaseEle.click(function(){var _ele=$(this);$.dialog.confirm("确定发布吗？",function(action){1==action&&(_ele.hasClass("loading")||$.get(_ele.data("href"),function(data){data.status?location.reload():$.dialog.error(data.info),_ele.removeClass("loading")}),_ele.addClass("loading"))})})}})}),define("home/projects/create",function(require,exports,module){var TagCreate=require("common/module/tagCreate");return require("common/extend/validator/validator"),require("component/jquery.form"),require("component/webuploader/css/webuploader.css"),require("component/webuploader/dist/webuploader"),require("component/select2/dist/css/select2.css"),require("component/select2/dist/js/select2.full.min"),Class({manualCreateFormEle:$("#manualCreateForm"),importDocumentEle:$("#importDocument"),manualTagEle:$("#manualTag"),namespaceSelectEle:$("#namespaceSelect"),namespaceEle:$("#namespace"),initial:function(){var self=this;this.namespaceSelectEle.select2({placeholder:"所属用户",minimumResultsForSearch:1/0,templateResult:function(state){return state.id?$('<div style="line-height: 20px;"><img src="'+$(state.element).data("logo")+'" width="20" height="20" /> '+state.text+"</div>"):state.text}}).on("select2:select",function(e){self.namespaceEle.text(e.params.data.id)}),this.createTag=new TagCreate({appendEle:this.manualTagEle,maxNumber:10,hiddenName:"tags",data:Config.get("createdTags"),onRepeat:function(item,text){$.dialog.error(text+"标签已创建")},onMaxLimit:function(max){$.dialog.error("最多允许创建"+max+"个标签")}}),this.importDocumentEle.each(function(){var _documentType=$(this).find(".document-type :checkbox"),_documentSelect=$(this).find(".document-select"),_documentItem=_documentSelect.find(".item"),_isImport=$(this).find(":hidden[name=is_import]");_documentType.click(function(){_documentType.not($(this)).prop("checked",!1),_isImport.prop("disabled",!0),_documentItem.hide().find("input").prop("disabled",!0),_documentType.filter(":checked").length?(_documentSelect.show(),_documentItem.eq($(this).closest(".w-btn").index()).show().find("input").prop("disabled",!1),_isImport.prop("disabled",!1)):_documentSelect.hide()})}),this.createUploader("Epub"),this.createUploader("Chm"),this.manualCreateFormEle.submitForm({autoValidate:!1,uploadFile:!0,onAfter:function(data,options){data.status?data.url&&location.replace(data.url):"string"==typeof data.info&&$.dialog.error(data.info)}})},createUploader:function(type){var self=this,_selectUploadChmElement=$("#selectUpload"+type),_pickerElement=$("#picker"+type),_listElement=$("#upload"+type+"List"),_hiddenInputElement=$("#upload"+type+"Hidden"),uploader=null;_selectUploadChmElement.click(function(){$(this).is(":checked")&&!uploader&&(uploader=WebUploader.create({runtimeOrder:!1,auto:!0,width:86,height:34,server:Config.get("uploadImportSourceUrl"),fileNumLimit:1,pick:"#picker"+type,accept:{title:type,extensions:type.toLowerCase(),mimeTypes:"*"},formData:{ajax:1,import_type:type.toLowerCase()}}),uploader.on("uploadSuccess",function(file,data){data.status?(_hiddenInputElement.val(data.data.source),$("#"+file.id).find(".state").text("上传成功！"),$.dialog.success(data.info)):$.dialog.error(data.info),self.manualCreateFormEle.find('[type="submit"]').removeAttr("disabled")}),uploader.on("fileQueued",function(file){_listElement.append('<div id="'+file.id+'" class="upload-item"><h4 class="info">'+file.name+'</h4><p class="state">等待上传...</p><b class="delete" title="删除">x</b>',"</div>"),_pickerElement.hide(),self.manualCreateFormEle.find('[type="submit"]').attr("disabled","")}),_listElement.on("click",".delete",function(){uploader.stop(!0),uploader.reset(),_hiddenInputElement.val(""),$(this).closest(".upload-item").remove(),_pickerElement.show()}),uploader.on("uploadProgress",function(file,percentage){var $li=$("#"+file.id),$percent=$li.find(".progress .progress-bar");$percent.length||($percent=$('<div class="progress progress-striped active"><div class="progress-bar" role="progressbar" style="width: 0%"></div></div>').appendTo($li).find(".progress-bar")),$li.find("p.state").text("上传中"),$percent.css("width",100*percentage+"%")}))}),_selectUploadChmElement.click(function(){!$(this).is(":checked")&&uploader&&(uploader.stop(!0),uploader.reset(),_hiddenInputElement.val(""),_listElement.find(".upload-item").remove(),_pickerElement.show())})}})}),define("home/projects/general",function(require,exports,module){return require("component/zclip/jquery.zclip"),Class({copyPath:seajs.data.base+seajs.data.paths.component+"/zclip/ZeroClipboard.swf?t=ggg",manualReleaseEle:$("#manualRelease"),manualRetryEle:$("#manualRetry"),manualDeleteEle:$("#manualDelete"),showDiffEle:$("#showDiff"),checkImportComplete:function(){var _self=this;$.ajax({url:Config.get("checkManualStatusUrl"),type:"get",data:{book_id:Config.get("manualId")},success:function(data){1==data.status?window.location.reload():2==data.status?setTimeout(function(){_self.checkImportComplete.apply(_self)},6e3):$.dialog.error("文档导入失败，请删除或者重试",{time:3e3,onClose:function(){window.location.reload()}})}})},initial:function(){switch(Config.get("manualStatus")){case 2:this.checkImportComplete();break;case 3:this.manualDeleteEle.click(function(){var _ele=$(this),_id=$(this).data("id");return $.dialog.confirm("确定删除吗",function(action){1==action&&$.ajax({url:_ele.data("href"),data:{book_id:_id},type:"post",success:function(data){data.status?location.href="/user/book":$.dialog.error(data.info)}})}),!1}),this.manualRetryEle.click(function(){var _ele=$(this),_id=$(this).data("id");return $.ajax({url:_ele.data("href"),data:{book_id:_id},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}}),!1});break;default:this.showDiffEle.click(function(){var _html='<div class="dialog-history" style="padding-left: 0"><div class="history-commit-details"></div></div>';_html=$(_html);$.dialog(_html,{button:[function(){var _self=this,cancelBtn=$('<label class="w-btn btn-default btn-m"><button class="btn-input">关闭</button></label>');return cancelBtn.click(function(){_self.close()}),cancelBtn}],style:"think-dialog-form",drag:!1,close:!1,onCreate:function(){var _detail=$(".history-commit-details",_html);$.dialog.loading("获取差异信息中..."),$.ajax({url:Config.get("showDiffUrl"),data:{book_id:Config.get("manualId")},context:this,type:"get",success:function(data){$.dialog.get("loading").close(),_detail.html(data)},complete:function(){$.dialog.get("loading").close()}})}})}),this.manualReleaseEle.click(function(){var _ele=$(this);$.dialog.confirm("确定发布吗？",function(action){1==action&&(_ele.hasClass("loading")||($.dialog.loading("发布中..."),$.post(_ele.data("href"),{book_id:Config.get("manualId")},function(data){data.status?location.reload():$.dialog.error(data.info),_ele.removeClass("loading")})),_ele.addClass("loading"))})})}""==Config.get("token")?$("#label_token_del").hide():$("#label_token_del").removeAttr("style"),$("#token_set").click(function(){var _ele=$(this),_id=$(this).data("id"),_tips=$(this).data("tips");return $.dialog.confirm(_tips,function(action){1==action&&$.ajax({url:_ele.data("href"),data:{book_id:_id},type:"post",success:function(data){data.status?($("#token_text").val(data.tokenUrl),$("#token_set").text("重新生成"),$("#zclipBtn").attr("style")&&$("#zclipBtn").removeAttr("style"),$("#label_token_del").show(),$("#label_token_del").removeAttr("style")):$.dialog.error(data.info)}})}),!1}),$("#token_del").click(function(){var _ele=$(this),_id=$(this).data("id"),_tips=$(this).data("tips");return $.dialog.confirm(_tips,function(action){1==action&&$.ajax({url:_ele.data("href"),data:{book_id:_id},type:"post",success:function(data){data.status?($("#token_text").val(""),$("#token_set").text("生成"),$("#zclipBtn").attr("style","visibility: hidden;"),$("#label_token_del").hide(),$("#label_token_del").attr("style","visibility: hidden;")):$.dialog.error(data.info)}})}),!1}),$("#url_clone").zclip({path:this.copyPath,copy:function(){return $("#token_text").val()},afterCopy:function(){$("#token_text").val()?$.dialog.success("复制成功"):$.dialog.error("阅读令牌为空")}})}})}),define("home/projects/index",function(require,exports,module){Class({manualListEle:$("#manualList"),manualAddEle:$(".e-manual-add"),initial:function(){this.manualAddEle.click(function(){return $.dialog.form($(this).attr("href"),{title:"新增手册",onClose:function(action){"ok"==action&&location.reload()}}),!1}),this.manualListEle.delegate(".pay","click",function(){return $.dialog.form($(this).attr("href"),{title:"付费"}),!1}),this.manualListEle.delegate(".attention-cancel","click",function(){var _ele=$(this),_id=($(this).closest("tr").find(".title").text(),$(this).data("id"));return $.dialog.confirm("确定取消关注吗？",function(action){1==action&&$.ajax({url:_ele.data("href"),data:{book_id:_id},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}})}),!1}),this.manualListEle.delegate(".join-cancel","click",function(){var _ele=$(this),_id=($(this).closest("tr").find(".title").text(),$(this).data("id"));return $.dialog.confirm("确定取消参与吗？",function(action){1==action&&$.ajax({url:_ele.data("href"),data:{book_id:_id},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}})}),!1})}})}),define("home/projects/tags",function(require,exports,module){var TagCreate=require("common/module/tagCreate");return Class({tagFormEle:$("#tagForm"),manualTagEle:$("#manualTag"),initial:function(){this.createTag=new TagCreate({appendEle:this.manualTagEle,maxNumber:10,hiddenName:"tags",data:function(){var _createdData=Config.get("createdTags"),_data=[];if($.isPlainObject(_createdData))for(var i in _createdData)_data.push(_createdData[i]);return _data},onRepeat:function(item,text){$.dialog.error(text+"标签已创建")},onMaxLimit:function(max){$.dialog.error("最多允许创建"+max+"个标签")}}),this.tagFormEle.submitForm({onAfter:function(data,options){data.status?$.dialog.success(data.info):"string"==typeof data.info&&$.dialog.error(data.info)}})}})}),define("home/projects/template",function(require,exports,module){return require("common/extend/validator/validator"),require("component/jquery.form"),Class({manualContainer:$(".m-manual-list"),templateSelected:$(".select-input"),initial:function(){this.manualContainer.delegate("a[class$='pro_tmpl_save']","click",function(){var _ele=$(this),_url=_ele.data("href"),_id=_ele.data("id"),_tips=_ele.data("tips");$.dialog.confirm(_tips,function(action){1==action&&$.ajax({url:_url,data:{template:_id},type:"post",success:function(data){data.status?($.dialog.success(data.info),$(".template_checked").remove(),_ele.parent().before('<a href="javascript:void(0);" class="private template_checked"><i class="icon-check private-icon "></i></a>')):$.dialog.error(data.info)}})})})}})}),define("home/projects/timeline",function(require,exports,module){var Doing=require("common/module/doing");require("common/module/comment");require("component/prettify/prettify"),require("component/prettify/prettify.css"),Class({doingTabEle:$("#doingTab"),doingListEle:$("#doingList"),updateDoinglListEle:$("#updateDoinglList"),initial:function(){this.updateDoing=new Doing({url:Config.get("timelineDoingPath"),tempData:{jumpPath:Config.get("jumpPath"),isShowManual:!1},param:{book_id:Config.get("currentManual")},doingListEle:this.updateDoinglListEle})}})}),define("home/projects/update",function(require,exports,module){var TagCreate=require("common/module/tagCreate");return require("common/extend/validator/validator"),require("component/jquery.form"),Class({uploadCoverFormEle:$("#uploadCoverForm"),uploadCoverEle:$("#uploadCover"),reCoverEle:$("#reCover"),manualUpdateFormEle:$("#manualUpdateForm"),manualDeleteEle:$("#manualDelete"),manualInfoCoverEle:$(".m-manual-info .cover img"),uploadNumber:0,manualTagEle:$("#manualTag"),manualId:Config.get("manualId"),initial:function(){var self=this;this.createTag=new TagCreate({appendEle:this.manualTagEle,maxNumber:10,hiddenName:"tags",data:Config.get("createdTags"),onRepeat:function(item,text){$.dialog.error(text+"标签已创建")},onMaxLimit:function(max){$.dialog.error("最多允许创建"+max+"个标签")}}),this.uploadCoverEle.click(function(){self.cutImageDialog?self.cutImageDialog.open():(self.cutImageDialog=$.dialog('<div class="m-dialog-loading"><b class="loading-text">裁剪组件加载中...</b></div>',{title:"封面裁剪",cache:!0}),require.async("common/module/cutImage",function(cutImage){self.cutCover=new cutImage({cls:"m-cover-cutting",cutWidth:173,cutHeight:231,boxWidth:420,boxHeight:300,uploadUrl:Config.get("uploadCoverUrl"),uploadParam:{book_id:Config.get("manualId"),title:Config.get("manualTitle")},saveCutUrl:Config.get("saveCoverUrl"),saveCutParam:{book_id:Config.get("manualId"),title:Config.get("manualTitle")},onSuccess:function(data){var _image=self.uploadCoverEle.find("img"),_src=data.data.url.indexOf("?")>=0?data.data.url+"&v="+self.uploadNumber:data.data.url+"?v="+self.uploadNumber;self.cutImageDialog.close(),self.uploadNumber++,_image.length||(_image=$("<img/>"),self.uploadCoverEle.find(".upload-image").html(_image)),self.manualInfoCoverEle.attr("src",_src),_image.attr("src",_src)}}),self.cutImageDialog.content(self.cutCover.getHtml()),self.cutImageDialog.offset(self.cutImageDialog._options.offset[0],self.cutImageDialog._options.offset[1])}))}),this.manualUpdateFormEle.submitForm({autoValidate:!1,onAfter:function(data,options){if(data.status)$.dialog.success(data.info,function(){location.reload()});else{var _errorInfo=[];if($.isPlainObject(data.info)){for(var i in data.info)_errorInfo.push(data.info[i]);_errorInfo=_errorInfo.join("<br/>")}else _errorInfo=data.info;$.dialog.error(_errorInfo)}}}),this.manualDeleteEle.click(function(){return $.dialog.confirm("确定删除吗",function(action){1==action&&$.ajax({url:Config.get("delUrl"),data:{book_id:Config.get("manualId")},type:"post",success:function(data){data.status?location.href="/user/book":$.dialog.error(data.info)}})}),!1}),this.reCoverEle.click(function(){return $.dialog.confirm("将使用系统生成的图片作为本文档的封面",function(action){1==action&&($.dialog.loading("重建封面中..."),$.ajax({url:Config.get("reCoverUrl"),data:{book_id:Config.get("manualId")},type:"post",success:function(data){if(data.status){var _image=self.uploadCoverEle.find("img"),_src=data.data.url;_image.length||(_image=$("<img/>"),self.uploadCoverEle.find(".upload-image").html(_image)),_image.attr("src",_src),$.dialog.success("封面重建完成")}else $.dialog.error(data.info)},complete:function(){$.dialog.get("loading").close()}}))}),!1})}})}),define("home/reader/entrance",function(require,exports,module){var Comment=(require("common/extend/template"),require("common/module/comment")),Sharing=require("common/module/sharing");return Class({manual:$(".topic-main"),manualId:Config.get("bookId"),manualDownloadEle:$("#manualDownload"),shareArticleEle:$("#shareArticle"),articleTitleEle:$("#articleTitle"),articleDescriptionEle:$("#articleDescription"),manualFollowEle:$("#manualFollow"),manualFollowNumber:$("#manualFollowNumber"),followTotal:Config.get("followTotal"),manualSummary:$("#entrance_summary"),manualDirectory:$("#entrance_directory"),manualComment:$("#entrance_comment"),manualContainer:$(".ent-wrap"),commentEle:$("#articleComment"),initial:function(){var _self=this;if(Config.get("isDownload")&&this.manualDownloadEle.find(".menu-link").click(function(){_self.downloadManual($(this).data("type"))}),new Sharing({cover:Config.get("sharePicUrl"),url:location.href,title:Util.HTMLEnCode(_self.articleTitleEle.text()),
summary:Util.HTMLEnCode(Util.substr(_self.articleDescriptionEle.text(),0,200))}),this.manualFollowEle.click(function(){_self.inUserFollowManual(_self.manualId)>=0?_self.cancelFollowManual():_self.addFollowManual()}),Config.get("isComment")){_self.comment=new Comment({wrapEle:_self.commentEle,postParam:{book_id:_self.manualId,doc_id:0},delParam:{book_id:_self.manualId,doc_id:0},disabledPost:!Config.get("isLogin"),votePath:Config.get("commentVotePath"),onePath:Config.get("commentOnePath"),listPath:Config.get("commentListPath"),delPath:Config.get("commentDelPath"),addPath:Config.get("commentAddPath")});var hash=location.hash.substr(1),_hashSplit=null;hash&&hash.indexOf("-")>=0&&(_hashSplit=hash.split("-")),_hashSplit&&"comment"==_hashSplit[0]&&_hashSplit[1]?this.comment.loadOne({id:_hashSplit[1],doc_id:0,book_id:this.manualId},function(data){this.assignList({doc_id:0,book_id:_self.manualId},function(){data.status&&this.addItem(data.data,!0,!1)}),Util.scrollTop(this.listEle,-120)}):this.comment.assignList({doc_id:0,book_id:this.manualId})}(function(){function loadCallback(callback){_self.getUserFollowManual(function(){$.isFunction(callback)&&callback()})}loadCallback(function(){_self.findUserFollowManual()})}).call(this),this.manual.delegate("#entrance_summary","click",function(){_self.manualSummary.addClass("active"),_self.manualComment.removeClass("active"),_self.manualDirectory.removeClass("active"),$("html,body").animate({scrollTop:60})}),this.manual.delegate("#entrance_directory","click",function(){_self.manualSummary.removeClass("active"),_self.manualComment.removeClass("active"),_self.manualDirectory.addClass("active"),$("html,body").animate({scrollTop:$("#directory").offset().top-65})}),this.manual.delegate("#entrance_comment","click",function(){_self.manualSummary.removeClass("active"),_self.manualDirectory.removeClass("active"),_self.manualComment.addClass("active"),$("html,body").animate({scrollTop:$("#comment").offset().top-65})})},downloadManual:function(type){var ele=this.manualDownloadEle.find(".drop-show");ele.click();var self=this;$.ajax({url:Config.get("getDownloadUrl"),data:{book_id:this.manualId,type:type},context:this,type:"post",success:function(data){1==data.status?(window.location.href=data.url,ele.removeClass("loading")):2==data.status?($.dialog.success("有新版本,需要重新打包,大概需时10s,请稍后……打包完成后会自动下载",{time:1e4}),setTimeout(function(){self.checkDownloadStatus(type)},3e3)):$.dialog.error(data.info)}})},checkDownloadStatus:function(type){var ele=this.manualDownloadEle.find(".drop-show"),self=this;$.ajax({url:Config.get("checkDownloadStatusUrl"),data:{book_id:this.manualId,type:type},context:this,type:"post",success:function(data){1==data.status?(window.location.href=data.url,ele.removeClass("loading")):setTimeout(function(){self.checkDownloadStatus(type)},3e3)}})},addFollowManual:function(){$.ajax({url:Config.get("confirmFollowUrl"),data:{book_id:this.manualId},context:this,type:"post",success:function(data){data.status?(this.manualFollowNumber.text(parseInt(this.manualFollowNumber.text())+1),this.userFollowManual.push(this.manualId),this.manualFollowEle.find(".number").text(++this.followTotal),this.findUserFollowManual(),$.dialog.success(data.info)):$.dialog.error(data.info)},complete:function(){this.manualFollowEle.removeClass("loading")}})},cancelFollowManual:function(){$.ajax({url:Config.get("cancelFollowUrl"),data:{book_id:this.manualId},context:this,type:"post",success:function(data){if(data.status){this.manualFollowNumber.text(parseInt(this.manualFollowNumber.text())-1);var _index=this.inUserFollowManual();this.manualFollowEle.find(".number").text(--this.followTotal),this.userFollowManual.splice(_index,1),this.findUserFollowManual(),$.dialog.success(data.info)}else $.dialog.error(data.info)},complete:function(){this.manualFollowEle.removeClass("loading")}})},getUserFollowManual:function(callback){$.ajax({url:Config.get("getFollowUrl"),context:this,type:"post",success:function(data){data.status&&(this.userFollowManual=data.data),$.isFunction(callback)&&callback.call(this)}})},findUserFollowManual:function(){if(Config.get("memberIsAuthor"))this.manualFollowEle.addClass("data-disabled").find(".text").text("关注数");else{var _index=this.inUserFollowManual();_index>=0?(this.manualFollowEle.removeClass("btn-success").addClass("btn-default"),this.manualFollowEle.find(".text").text("取消关注")):(this.manualFollowEle.removeClass("btn-default").addClass("btn-success"),this.manualFollowEle.find(".text").text("加关注"))}},inUserFollowManual:function(){for(var i=0;i<this.userFollowManual.length;i++)if(this.manualId==this.userFollowManual[i])return i;return-1}})}),define("home/setting/info",function(require,exports,module){require("common/extend/validator/validator"),require("component/jquery.form"),Class({uploadCoverEle:$("#uploadAvatar"),userInfoAvatarEle:$(".m-manual-info .avatar img"),userInfoFormEle:$("#userInfoForm"),uploadNumber:0,initial:function(){var self=this;this.uploadCoverEle.click(function(){self.cutImageDialog?self.cutImageDialog.open():(self.cutImageDialog=$.dialog('<div class="m-dialog-loading"><b class="loading-text">裁剪组件加载中...</b></div>',{title:"头像裁剪",cache:!0}),require.async("common/module/cutImage",function(cutImage){self.cutCover=new cutImage({cls:"m-cover-cutting",cutWidth:150,cutHeight:150,boxWidth:420,boxHeight:300,uploadUrl:Config.get("uploadAvatarUrl"),saveCutUrl:Config.get("saveAvatarUrl"),onSuccess:function(data){var _image=self.uploadCoverEle.find("img"),_src=data.data.url.indexOf("?")>=0?data.data.url+"&v="+self.uploadNumber:data.data.url+"?v="+self.uploadNumber;self.cutImageDialog.close(),self.uploadNumber++,_image.length||(_image=$("<img/>"),self.uploadCoverEle.find(".upload-image").html(_image)),self.userInfoAvatarEle.attr("src",_src),_image.attr("src",_src)}}),self.cutImageDialog.content(self.cutCover.getHtml()),self.cutImageDialog.offset(self.cutImageDialog._options.offset[0],self.cutImageDialog._options.offset[1])}))}),this.userInfoFormEle.submitForm({autoValidate:!1,onAfter:function(data){data.status?$.dialog.success(data.info):$.dialog.error(data.info)}})}})}),define("home/setting/oauth",function(require,exports,module){Class({oauthListEle:$(".m-oauth-list"),initial:function(){this.oauthListEle.delegate(".oauth-cancel","click",function(){var _ele=$(this),_type=$(this).data("type");return $.dialog.confirm("确定取消绑定吗？",function(action){1==action&&$.ajax({url:_ele.data("href"),data:{type:_type},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}})}),!1})}})}),define("home/setting/security",function(require,exports,module){Class({securityFormEle:$("#securityForm"),initial:function(){this.securityFormEle.submitForm({autoValidate:!1,onAfter:function(data){data.status?$.dialog.success(data.info,function(){window.location.reload()}):"string"==typeof data.info&&$.dialog.error(data.info)}})}})}),define("home/suggest/detail",function(require,exports,module){var Comment=require("common/module/comment");Class({commentEle:$("#comment"),manualListEle:$("#manualList"),initial:function(){this.comment=new Comment({wrapEle:this.commentEle,postParam:{book_id:Config.get("bookId")},delParam:{book_id:Config.get("bookId"),doc_id:Config.get("articleId")},votePath:Config.get("commentVotePath"),onePath:Config.get("commentOnePath"),listPath:Config.get("commentListPath"),delPath:Config.get("commentDelPath"),addPath:Config.get("commentAddPath"),onCreate:function(){this.articleIdHiddenEle=$('<input type="hidden" name="doc_id" value="'+Config.get("articleId")+'" />'),this.postEnterEle.after(this.articleIdHiddenEle)}});var hash=location.hash.substr(1),_hashSplit=null;hash&&hash.indexOf("-")>=0&&(_hashSplit=hash.split("-")),_hashSplit&&"comment"==_hashSplit[0]&&_hashSplit[1]?this.comment.loadOne({id:_hashSplit[1],doc_id:0,book_id:0},function(data){this.assignList({doc_id:Config.get("articleId"),book_id:0},function(){data.status&&this.addItem(data.data,!0,!1)}),Util.scrollTop(this.listEle,-120)}):this.comment.assignList({doc_id:Config.get("articleId"),book_id:0}),this.manualListEle.delegate("a[class$='topic_op_status']","click",function(){var _ele=$(this),_id=$(this).data("id"),_opstatus=$(this).data("opstatus"),_tips=$(this).data("tips");return $.dialog.confirm(_tips,function(action){1==action&&$.ajax({url:_ele.data("href"),data:{id:_id,op_status:_opstatus},type:"post",success:function(data){data.status?location.reload():$.dialog.error(data.info)}})}),!1}),this.manualListEle.delegate("a[class$='e-operate']","click",function(){var _ele=$(this),_id=$(this).data("id"),_tips=$(this).data("tips");return $.dialog.confirm(_tips,function(action){1==action&&$.ajax({url:_ele.data("href"),data:{id:_id},type:"post",success:function(data){data.status?location.href=data.url:$.dialog.error(data.info)}})}),!1})}})}),define("home/suggest/send",function(require,exports,module){require("component/jquery.thinkkeyboard"),Class({suggestContentEle:$("#suggestContent"),suggestFormEle:$("#suggestForm"),initial:function(){var self=this;this.getEditor(),this.suggestFormEle.submitForm({onAfter:function(data){data.status?$.dialog.success(data.info,function(){location.reload()}):"string"==typeof data.info&&$.dialog.error(data.info)}}),this.suggestFormEle.find("[name=title]").thinkkeyboard({"ctrl+s":function(){return self.suggestFormEle.submit(),!1}})},getEditor:function(){var self=this;return self._editor?this._editor:(require.async("component/thinkeditor/skin/manual/style.css"),void require.async("component/thinkeditor/jquery.thinkeditor",function(){self._editor=$.thinkeditor(self.suggestContentEle.find("textarea").thinkeditor({style:"manual",uploader:{url:"/article/upload"},items:"h1,h2,h3,h4,h5,h6,-,bold,italic,-,ul,ol,-,link,image,code,hr,blockquote,-,fullscreen",onSave:function(){self.suggestFormEle.submit()}})),self.suggestContentEle.addClass("editor-markdown")}))}})}),define("home/team/create",function(require,exports,module){return Class({teamCreateFormEle:$("#teamCreateForm"),initial:function(){this.teamCreateFormEle.submitForm({autoValidate:!1,onAfter:function(data,options){data.status?data.url&&location.replace(data.url):"string"==typeof data.info&&$.dialog.error(data.info)}})}})}),define("home/team/index",function(require,exports,module){}),define("home/team/member",function(require,exports,module){return require("component/select2/dist/css/select2.css"),require("component/select2/dist/js/select2.full.min"),Class({selectMemberEle:$("#selectMember"),currentTeamId:Config.get("currentTeam"),memberListEle:$("#memberList"),initial:function(){var self=this;this.selectMemberEle.click(function(){var $html,dialog;$html=$("<div/>").addClass("m-manual-add").html('<form class="w-form form-horizon dialog-form" method="post"><div class="form-item"><span class="form-label">用户</span><div class="form-target"><label class="w-select select-m"><select class="select-input" name="user" multiple="multiple"></select></label></div></div><div class="form-item"><span class="form-label">角色</span><div class="form-target"><label class="w-select select-m"><select class="select-input" name="role"></select></label></div></div></div>'),dialog=$.dialog.form($html,{title:"添加成员",onCreate:function(){var _form=this.bodyElement.find("form");_form.append($('<input type="hidden" name="team_id" value="'+self.currentTeamId+'">')),_form.attr("action",Config.get("createUserUrl")),_form.find('[name="role"]').append(function(){var options="";return $.each(Config.get("accessRoles"),function(k,v){options+="<option value='"+v+"'>"+k+"</option>"}),options}),_form.find('[name="user"]').select2({placeholder:"选择用户",width:232,multiple:!0,ajax:{url:Config.get("searchUserUrl"),data:function(params){return{nickname:params.term}},processResults:function(data){return{results:data.info}}},templateResult:function(repo){return repo.nickname},templateSelection:function(repo){return repo.nickname||repo.text}}),_form.submitForm({onBefore:function(options){var user=_form.find('[name="user"]').val();return user?void(options.data.user=user):($.dialog.error("请选择用户"),!1)},onAfter:function(data,options){data.status?window.location.reload():$.dialog.error(data.info)}})}})}),this.memberListEle.delegate(".delete","click",function(){var _id=$(this).closest(".m-member-item").data("id"),$this=$(this);$.dialog.confirm("确定要删除该用户吗？",function(action){1==action&&$.ajax({url:Config.get("delMemberPath"),data:{id:_id,team_id:self.currentTeamId},context:this,type:"post",success:function(data){data.status?$this.closest(".m-member-item").remove():$.dialog.error(data.info)}})})}),this.memberListEle.delegate(".leave","click",function(){$.dialog.confirm("确定要退出吗？",function(action){1==action&&$.ajax({url:Config.get("leaveUserUrl"),data:{team_id:self.currentTeamId},context:this,type:"post",success:function(data){data.status?window.location.href="/user/team":$.dialog.error(data.info)}})})}),this.memberListEle.delegate(".role>select","change",function(){var _id=$(this).closest(".m-member-item").data("id");$.ajax({url:Config.get("setMemberRolePath"),data:{id:_id,role:$(this).val(),team_id:self.currentTeamId},context:this,type:"post",success:function(data){data.status?$.dialog.success(data.info):$.dialog.error(data.info)}})})}})}),define("home/team/setting",function(require,exports,module){return require("common/extend/validator/validator"),require("component/jquery.form"),Class({uploadCoverEle:$("#uploadAvatar"),teamAvatarEle:$(".m-manual-info .avatar img"),teamFormEle:$("#teamForm"),uploadNumber:0,teamId:Config.get("teamId"),initial:function(){var self=this;this.uploadCoverEle.click(function(){self.cutImageDialog?self.cutImageDialog.open():(self.cutImageDialog=$.dialog('<div class="m-dialog-loading"><b class="loading-text">裁剪组件加载中...</b></div>',{title:"封面裁剪",cache:!0}),require.async("common/module/cutImage",function(cutImage){self.cutCover=new cutImage({cls:"m-cover-cutting",cutWidth:173,cutHeight:173,boxWidth:420,boxHeight:300,uploadUrl:Config.get("uploadAvatarUrl"),uploadParam:{team_id:Config.get("teamId")},saveCutUrl:Config.get("saveAvatarUrl"),saveCutParam:{team_id:Config.get("teamId")},onSuccess:function(data){var _image=self.uploadCoverEle.find("img"),_src=data.data.url.indexOf("?")>=0?data.data.url+"&v="+self.uploadNumber:data.data.url+"?t="+self.uploadNumber;self.cutImageDialog.close(),self.uploadNumber++,_image.length||(_image=$("<img/>"),self.uploadCoverEle.find(".upload-image").html(_image)),self.teamAvatarEle.attr("src",_src),_image.attr("src",_src)}}),self.cutImageDialog.content(self.cutCover.getHtml()),self.cutImageDialog.offset(self.cutImageDialog._options.offset[0],self.cutImageDialog._options.offset[1])}))}),this.teamFormEle.submitForm({autoValidate:!1,onAfter:function(data){data.status?$.dialog.success(data.info):$.dialog.error(data.info)}})}})}),define("home/topic/send",function(require,exports,module){var editor=require("editor/script/editor");Class({suggestContentEle:$("#suggestContent"),suggestFormEle:$("#suggestForm"),initial:function(){var self=this;this.getEditor(),this.suggestFormEle.submitForm({onBefore:function(options){options.data.content=self.getEditor().getValue()},onAfter:function(data){data.status?$.dialog.success(data.info,function(){data.url?location.href=data.url:location.reload()}):"string"==typeof data.info&&$.dialog.error(data.info)}})},getEditor:function(){var self=this;return this._editor||(self.suggestContentEle.addClass("editor"),this._editor=editor(self.suggestContentEle.find("textarea"),{items:"undo,redo,-,h1,h2,h3,h4,-,bold,italic,-,ul,ol,-,link,image,code,hr,blockquote,table,-,preview,fullscreen,help",uploader:{url:Config.get("uploadImageUrl")}})),this._editor}})}),define("home/user/notification",function(require,exports,module){Class({notificationListEle:$("#notificationList"),readAllEle:$("#readAll"),removeAllEle:$("#removeAll"),initial:function(){this.notificationListEle.on("click","dl",function(){var id=$(this).data("id"),$this=$(this);$.post(Config.get("readUrl"),{id:id}).done(function(){$this.removeClass("unread")})}),this.readAllEle.click(function(){$.post(Config.get("readUrl")).done(function(){location.reload()})}),this.removeAllEle.click(function(){$.dialog.confirm("确定要清空吗",function(action){1==action&&$.post(Config.get("removeUrl")).done(function(){location.reload()})})})}})}),define("common/extend/autocomplete/autocomplete",function(require,exports,module){var autoComplete={dataSource:"",Emoji:{template:'<li data-value="${insert}">${name} <img alt="${name}" height="20" src="${image}" width="20" /></li>'},Members:{template:'<li data-value="${username}">${username} <small>${name}</small></li>'},Issues:{template:'<li data-value="${id}"><small>${id}</small> ${title} </li>'},setup:function(input){var emojis=["smile","iphone","girl","smiley","heart","kiss","copyright","coffee"];$.map(emojis,function(value,i){return{id:i,name:value}});input.atwho({})}};return autoComplete}),define("common/extend/bootstrap/bootstrap",function(require,exports,module){!function(){var Button=$.fn.button.Constructor;$.extend(Button.prototype,{disabled:function(status){return this.isDisabled="undefined"==typeof status?!0:status,this.$element.attr("disabled",this.isDisabled),this},initialed:function(){var _self=this;this.$element.click(function(event){_self.isDisabled&&event.stopImmediatePropagation()})}}),$.fn.button=function(option){var args=arguments;return this.each(function(){var $this=$(this),data=$this.data("bs.button"),options="object"==typeof option&&option;data||($this.data("bs.button",data=new Button(this,options)),$.isFunction(data.initialed)&&data.initialed.call(data)),"toggle"==option?data.toggle():"disabled"==option?data.disabled.apply(data,Array.prototype.slice.call(args,1)):option&&data.setState(option)})}}()}),define("common/extend/dialog/dialog",function(require,exports,module){require("component/dialog/jquery.dialog"),require("common/extend/validator/validator"),function(){$.extend($.dialog,{form:function(url,options){var _options=options||{},_praseData=_options.praseData,_onCreate=(_options.onBefore,_options.onAfter,_options.onCreate);_options=$.extend({drag:!1},_options);var _defineBtn=function(){var _self=this;return _self.cancelBtn=$('<label class="w-btn btn-default btn-m"><button class="btn-input">取消</button></label>'),_self.cancelBtn.click(function(){_self.close()}),_self.cancelBtn},_cancelBtn=function(){var _self=this;return _self.defineBtn=$('<label class="w-btn btn-success btn-m"><button class="btn-input">确定</button></label>'),_self.defineBtn.click(function(){_self.formEle.submit()}),_self.defineBtn};return"string"!=typeof url?(_options.button=[_cancelBtn,_defineBtn],_options.onCreate=function(){var _content=this.content();_content.data("dialog",this),this.formEle=_content.find(".dialog-form"),this.formEle.data("submitButton",this.defineBtn),$.isFunction(_onCreate)&&_onCreate.call(this)},$.dialog(url,_options)):(_options.praseData=function(data){var data=$.isFunction(_praseData)?_praseData.call(this,data):data;return data===!1?!1:(data=$(data),this.setButton([_cancelBtn,_defineBtn]),data.data("dialog",this),this.formEle=data.find("form"),this.formEle.data("submitButton",this.defineBtn),data)},$.dialog.load(url,_options))},open:function(url,options){options=options||{};var cancelBtn=function(){var _self=this;return _self.cancelBtn=$('<label class="w-btn btn-default btn-m"><button class="btn-input">取消</button></label>'),_self.cancelBtn.click(function(){_self.close(),$.isFunction(options.onCancel)?options.onCancel.call(this):""}),_self.cancelBtn},okBtn=function(){var _self=this;return _self.okBtn=$('<label class="w-btn btn-success btn-m"><button class="btn-input">确定</button></label>'),_self.okBtn.click(function(){$.isFunction(options.onOk)?options.onOk.call(_self):""}),_self.okBtn};if("string"!=typeof url)return options.button=[okBtn,cancelBtn],options.content=url,$.dialog(options);var praseData=options.praseData;return options.praseData=function(data){return data=$.isFunction(praseData)?praseData.call(this,data):data,data===!1?!1:(data=$(data),this.setButton([cancelBtn,okBtn]),data)},$.dialog.load(url,options)}})}()}),define("common/extend/template",function(require,exports,module){var Cache=require("common/library/cache"),Template=require("component/template/template");return Template.setData=function(data){Cache.set("TEMPLATE_DATA",$.extend({},Cache.get("TEMPLATE_DATA"),data))},Template.getTemp=function(temp,callback){var _type=$.type(temp),_temp="";if("object"==_type)_temp=$(temp).html(),$.isFunction(callback)&&callback(_temp);else if(Util.isUrl(temp)){var _data=temp.split("#");_temp=Cache.get(_data[0]),_temp?_data[1]&&(_temp=$(_temp).filter("#"+_data[1]).html(),$.isFunction(callback)&&callback(_temp)):Util.ajax({url:_data[0],dataType:"html",success:function(data){_temp=data||"",data&&_data[1]&&(_temp=$(data).filter("#"+_data[1]).html()),Cache.set(_data[0],data),$.isFunction(callback)&&callback(_temp)}})}else _temp=String(temp),$.isFunction(callback)&&callback(_temp)},Template.delData=function(name){var _cacheData=Cache.get("TEMPLATE_DATA");name in _cacheData&&delete _cacheData[name]},Template.parseTemp=function(temp,data,name){return Template.compile(temp)($.extend({},data,Cache.get("TEMPLATE_DATA")),name)},Template}),define("common/extend/thinkeditor/thinkeditor",function(require,exports,module){require("component/showdown/dist/showdown.min"),require("component/thinkeditor/skin/manual/style.css"),require("component/thinkeditor/jquery.thinkeditor"),require("component/prettify/prettify"),require("component/prettify/prettify.css"),require("component/to-markdown/dist/to-markdown"),function(thinkeditor,getThinkeditor){$.thinkeditor.plugin({preview:{keyboard:"ctrl+p",markdown:function(options){var _type=!this.isPreview();this.preview(_type),$.isFunction(options.onPreview)&&options.onPreview.call(this,_type)}},history:{markdown:function(options){$.isFunction(options.onHistory)&&options.onHistory.call(this)}},htmlpaste:{markdown:function(options){var $text,$iframe,$html,doc,dialog,editor=this,ie=navigator.userAgent.toLowerCase().indexOf("msie")>-1&&-1==navigator.userAgent.toLowerCase().indexOf("opera");$text=$("<p />").text(this.lang("htmlpaste-text")),$iframe=$('<iframe frameborder="0" style="width:600px;height:260px;padding: 5px;"></iframe>'),$html=$("<div/>").addClass("thinkeditor-plugin-htmlpaste").append($text).append($iframe),dialog=this.dialog({title:this.lang("htmlpaste-title"),content:$html,onOkClick:function(){var str=doc.body.innerHTML;str=str.replace(/~/g,"~T"),str=str.replace(/`/g,"~E"),str=str.replace(/\$/g,"~D"),str=toMarkdown(str,{gfm:!0});var cnum=0,arrcode=[];str=str.replace(/~~~([\s\S]*?)~~~/g,function(all){return cnum++,arrcode[cnum]=all,"[	codeplace_"+cnum+"	]"}),str=str.replace(/(`+)([^\r]*?[^`])\1(?!`)/g,function(wholeMatch,m1,m2,m3){return cnum++,arrcode[cnum]=wholeMatch,"[	codeplace_"+cnum+"	]"}),str=str.replace(/<\/?.+?>/g,""),str=str.replace(/\n{2,}/g,"\n\n");for(var i=1;cnum>=i;i++)str=str.replace("[	codeplace_"+i+"	]",function(){return arrcode[i]});str=str.replace(/~D/g,"$$"),str=str.replace(/~E/g,"`"),str=str.replace(/~T/g,"~"),editor.insert(str),dialog.remove()}});var $localImageBtn=$('<label class="w-btn btn-m btn-success"><button class="btn-input" type="button">图片本地化</button></label>');$localImageBtn.click(function(){var html=doc.body.innerHTML,reg=/<img\b[^>]*src\s*=\s*(["'])([^>'"]*)\1[^>]*>/gi,images=[];html.replace(reg,function(str,match1,match2){return match2.match(/^(https?:\/\/|\.)/i)&&-1===match2.indexOf(options.downloader.host)&&images.push(match2),str}),dialog.setStatus("远程图片下载中……","success");var total=images.length,i=0,downloader=function(){if(images.length>0){var image=images.shift(),data=$.extend(options.downloader.data,{url:image});i++,dialog.setStatus("远程图片下载中…… ("+i+"/"+total+")","success"),$.post(options.downloader.url,data,function(result){html=html.replace(result.info.old_src,result.info.new_src),doc.body.innerHTML=html,downloader()})}else dialog.setStatus("远程图片下载完成","success")};downloader()}),dialog.status.append($localImageBtn),doc=$iframe[0].contentDocument||$iframe[0].contentWindow.document,ie||(doc.designMode="on"),doc.open(),doc.write('<!doctype html><html style="height:100%;"><head><title>WordPaste</title></head>'),doc.write('<body style="background-color:#ffffff;font-size:12px;padding:0px;margin:0px;height: 100%;">'),ie||doc.write("<br />"),doc.write("</body></html>"),doc.close(),ie&&(doc.body.contentEditable="true"),$iframe[0].contentWindow.focus()}},toc:{markdown:function(){this.insert("\n[TOC]\n")}},help:{markdown:function(){window.open("http://help.kancloud.cn/editor")}},sidebar:{markdown:function(options){var _type=!this.isSidebar();this.sidebar(_type),$.isFunction(options.onSidebar)&&options.onSidebar.call(this)}},more:{markdown:function(options){$.isFunction(options.onMore)&&options.onMore.call(this)}}}),$.thinkeditor.language({"zh-cn":{h1:"标题一 (Ctrl+1)",h2:"标题二 (Ctrl+2)",h3:"标题三 (Ctrl+3)",h4:"标题四 (Ctrl+4)",h5:"标题五 (Ctrl+5)",h6:"标题六 (Ctrl+6)",link:"链接 (Ctrl+L)",image:"图片 (Ctrl+G)",bold:"加粗 (Ctrl+B)",italic:"斜体 (Ctrl+I)",code:"代码 (Ctrl+D)",ul:"无序列表 (Ctrl+U)",ol:"有序列表 (Ctrl+O)",blockquote:"引用 (Ctrl+Q)",hr:"分割线 (Ctrl+H)",fullscreen:"全屏编辑 (Ctrl+Shift+F)",save:"保存 (Ctrl+S)",quit:"退出 (Esc)",preview:"预览 (Ctrl+P)",htmlpaste:"从HTML粘贴",history:"历史记录",table:"插入表格",toc:"插入目录",help:"帮助",sidebar:"显示目录",ok:"确定",cancel:"取消","table-title":"插入表格","link-title":"插入链接","image-title":"插入图片","image-text":"拖动图片到这里上传","htmlpaste-title":"从HTML粘贴","htmlpaste-text":"请使用快捷键(Ctrl+V)把内容粘贴到下面的方框里。"}}),$.fn.thinkeditor=function(options){return $(this).each(function(){$.extend(getThinkeditor(thinkeditor.call($(this),options)),{init:function(options){var self=this;this._rewriteHtml(),this.getTextarea().on("keyup cut paste",function(){var _value=self.getValue();_value!=self._prevValue&&(self.getTextarea().trigger("change",self.getTextarea().val()),self._prevValue=_value)}),this.getTextarea().on("change",function(){self.setPreviewContent(self.getValue())}),this.markdownParse=new showdown.Converter({omitExtraWLInCodeBlocks:!0,noHeaderId:!1,simplifiedAutoLink:!0,literalMidWordUnderscores:!0,tables:!0,ghCodeBlocks:!0}),this.preview(options.preview),this.sidebar(options.siderbar);var _timer1=null,_timer2=null;this.getTextarea().on("scroll",function(){if(!self._textareaScrollLock){clearTimeout(_timer1);var _ratio=$(this).scrollTop()/(this.scrollHeight-$(this).outerHeight()),_maxScroll=self.previewAreaElement[0].scrollHeight-self.previewAreaElement.outerHeight();self.previewAreaElement.scrollTop(_ratio*_maxScroll),self._previewScrollLock=!0,_timer1=setTimeout(function(){self._previewScrollLock=!1},60)}}),this.previewAreaElement.on("scroll",function(){if(!self._previewScrollLock){clearTimeout(_timer2);var _ratio=$(this).scrollTop()/(this.scrollHeight-$(this).outerHeight()),_maxScroll=self.getTextarea()[0].scrollHeight-self.getTextarea().outerHeight();self.getTextarea().scrollTop(_ratio*_maxScroll),self._textareaScrollLock=!0,_timer2=setTimeout(function(){self._textareaScrollLock=!1},60)}}),this.previewAreaElement.on("click","ul.markdown-toc-list a",function(e){e.stopImmediatePropagation();var id=$(this).attr("href");return self.previewAreaElement.animate({scrollTop:$(id).offset().top-60},500),!1}),this.previewAreaElement.on("click","a",function(){return window.open($(this).attr("href")),!1});var _insert=this.insert;this.insert=function(){_insert.apply(this,arguments),self.setPreviewContent(self.getValue())},self.setPreviewContent(self.getValue())},_rewriteHtml:function(){var _textarea=this.getTextarea(),_textareaParent=_textarea.closest(".thinkeditor-textarea"),_mainWorkArea=$('<div class="thinkeditor-main"></div>'),_previewArea=$('<div class="thinkeditor-preview"><div class="thinkeditor-preview-inner"><div class="thinkeditor-preview-content think-editor-content"></div></div></div>');_textareaParent.after(_mainWorkArea),this.previewAreaElement=_previewArea.find(".thinkeditor-preview-inner"),this.previewContentElement=_previewArea.find(".thinkeditor-preview-content"),_mainWorkArea.append(_textareaParent).append(_previewArea),_textareaParent.wrap('<div class="thinkeditor-textarea-wrap"></div>')},setPreviewContent:function(content){this.previewContentElement.html(this.filterContent(this.markdownParse.makeHtml(content))),this.highlightCode(this.previewContentElement.find("pre"))},getPreviewContent:function(){return this.previewContentElement.html()},preview:function(status){var _status="undefined"==typeof status?!0:status?!0:!1;_status?(this.getHtml().addClass("thinkeditor-preview-active"),this.getToolbar("preview").addClass("active")):(this.getHtml().removeClass("thinkeditor-preview-active"),this.getToolbar("preview").removeClass("active")),this._isPreview=_status},isPreview:function(){return this._isPreview},sidebar:function(status){var _status="undefined"==typeof status?!0:status?!0:!1;_status?(this.getHtml().removeClass("thinkeditor-fullscreen"),this.getToolbar("sidebar").addClass("active")):(this.getHtml().addClass("thinkeditor-fullscreen"),this.getToolbar("sidebar").removeClass("active")),this._isSidebar=_status},isSidebar:function(){return this._isSidebar},setValue:function(content,status){var self=this;content=(content||"").toString(),status="undefined"==typeof status?!0:status?!0:!1,this.value(content),status&&(Util.setCursorPosition(this.getTextarea()[0],0),self.getTextarea().animate({scrollTop:0},100)),content!=this._prevValue&&this.getTextarea().trigger("change",content),this._prevValue=this.getValue()},getValue:function(){return this.value()},setInterimInitValue:function(content){content=(content||"").toString(),this._interimInitValue=content},delteInterimInitValue:function(){delete this._interimInitValue},findValueChange:function(){return"undefined"!=typeof this._interimInitValue&&this._interimInitValue!=this.getValue()?!0:!1},getHtml:function(){return this.getTextarea().closest(".thinkeditor")},getToolbar:function(name){return"undefined"==typeof name?this.getHtml().find(".thinkeditor-tools"):this.getHtml().find(".thinkeditor-tools").find(".thinkeditor-tools-"+name)},getTextarea:function(){return $(this.range.textarea)},filterContent:function(content){var _content=content;return _content=_content.replace(/(<\/((?:no)script|style)>)/gi,function(str,match1,match2,match3,match4,index){return Util.HTMLEnCode(match1)}),_content=_content.replace(/(<((?:no)script|style).*?>)/gi,function(str,match1){return Util.HTMLEnCode(match1)}),_content||content},highlightCode:function(code){code.each(function(){var $this=$(this),$code=$this.children("code"),lang=$code.attr("class");$this.addClass("prettyprint linenums").data("code",$code.text()),lang&&$this.addClass("lang-"+lang),navigator.userAgent.match(/AppleWebKit/gi)&&$this.addClass("webkit")}),prettyPrint()}}).init(options||{})})}}($.fn.thinkeditor,$.thinkeditor)}),define("common/extend/validator/validator",function(require,exports,module){function serializeObject(form){var _object={};if("FORM"==form.nodeName)for(var _value=$(form).serializeArray(),i=0;i<_value.length;i++)_object[_value[i].name]=_value[i].value;return _object}require("component/jquery-plugs/jquery.validator"),require("component/jquery.form"),$.fn.clearValidate=function(){$(this).find("[name]").each(function(){element=$(this);var _group=element.closest(".form-item"),_msg=_group.find(".field-msg");_group.removeClass("has-error has-success"),_msg.html(_msg.data("defalut-msg"))})},$.fn.submitForm=function(options){function check(element,form){var _name=(element.closest(".form-item"),element.attr("name")),_items=this.getItem(_name),_join=["[name="+_name+"]"];$.each(_items,function(){if(this.must||fetchDefatul(element),$.isArray(this.join))for(var i=0;i<this.join.length;i++)_join.push("[name="+this.join[i]+"]")}),_join=_join.join(","),this.check(form.serializeArray(),_items)}function fetchError(element,message){var _group=element.closest(".form-item"),_msg=_group.find(".field-msg");_msg.length||(_msg=$('<span class="field-msg"></span>'),_group.find("[name]").after(_msg)),_group.addClass("has-error").removeClass("has-success"),
"undefined"==typeof _msg.data("defalut-msg")&&_msg.attr("data-defalut-msg",_msg.html()),_msg.html(message||this.msg)}function fetchDefatul(element){if(element){var _group=element.closest(".form-item"),_msg=_group.find(".field-msg");_group.removeClass("has-error has-success"),_msg.html(_msg.data("defalut-msg"))}}function _activeForm(){_form.removeClass("form-posting"),_options.handler.each(function(){var _text=$(this).data("text"),_parent=$(this).closest(".w-btn");_parent.length||(_parent=$(this));var _btn=_parent.find("input,button");_btn.length?_btn.val(_text):(_btn=_parent,_btn.html(_text)),_btn.prop("disabled",!1),_parent.removeClass("btn-loading")})}function _disabledForm(){_form.addClass("form-posting"),_options.handler.each(function(){var _parent=$(this).closest(".w-btn");_parent.length||(_parent=$(this));var _btn=_parent.find("input,button");_btn.length?_btn.val("提交中"):(_btn=_parent,_btn.text("提交中")),_btn.prop("disabled",!0),_parent.addClass("btn-loading")})}var _form=$(this),_options=$.extend({validate:null,autoValidate:!1,type:"post",handler:_form.find(":submit"),controlPoint:null,onBefore:null,onAfter:null,loadingTpl:'<span class="form-loading">提交中...</span>'},options),_origValue=_form.serializeArray(),_onComplete=(_origValue.length,_options.complete),_validator=$.validator({map:_options.validate,onAfter:function(status,data){var _element=$("[name="+this.name+"]");status===!0||fetchError.call(this,_element)},onCreate:function(){var _validator=this,_activeElement=!1;_form.find("[name]").click(function(event){_activeElement=$(this),fetchDefatul(_activeElement),_options.autoValidate&&"INPUT"==this.nodeName&&"checkbox"==this.type&&check.call(_validator,_activeElement,_form),event.stopPropagation()}).keyup(function(){fetchDefatul($(this))}).closest("label").click(function(event){event.stopPropagation()}),$(document).bind("click",function(){_activeElement&&_options.autoValidate&&check.call(_validator,_activeElement,_form),_activeElement=!1})}});_options.url=_options.url||$(this).attr("action"),_options.type=_options.type||$(this).attr("method")||"POST",_options.beforeSend=function(){var _data=_form.serializeArray(),_status=_validator.check(_data);return _options.handler=_form.data("submitButton")?_form.data("submitButton"):_options.handler,_options.handler.each(function(){var _btn=$(this).find("input,button");_btn.length?$(this).data("text",_btn.val()||_btn.text()):$(this).data("text",$(this).html()||$(this).val())}),_status&&_disabledForm(),_status},_options.complete=function(){_activeForm(),$.isFunction(_onComplete)&&_onComplete.call(this)},_options.success=function(data){if(!data.status&&$.isPlainObject(data)){var _first=null,_number=0;for(var i in data.info)_number||(_first=_form.find("[name="+i+"]")),fetchError(_form.find("[name="+i+"]"),data.info[i]),_number++}$.isFunction(_options.onAfter)&&_options.onAfter(data,_options)},_form.append(_options.loadingTpl),_form.submit(function(event){if(_options.uploadFile!==!0&&(_options.data=$.extend({},_options.data,serializeObject(_form[0]))),$.isFunction(_options.onBefore)){var _status=_options.onBefore.call(_form,_options);if(_status===!1)return!1}return _options.uploadFile===!0?_form.ajaxSubmit(_options):$.ajax(_options),!1}),$.isFunction(_options.controlPoint)&&_options.controlPoint.call(_form,valueChange)}}),define("common/library/cache",function(require,exports,module){var cacheList=window.top.DATACACHELIST=window.top.DATACACHELIST||{};exports.set=function(name,data){var _proxy=cacheList;if(null!==name)if($.isPlainObject(name))$.extend(!0,_proxy,name);else{name=name.toString();for(var _name=name.split("."),_leng=_name.length,i=0;_leng>i;i++)"undefined"==typeof _proxy[_name[i]]?i==_leng-1?_proxy[_name[i]]=data:_proxy[_name[i]]={}:_proxy[_name[i]]=$.extend(!0,_proxy[_name[i]],data),_proxy=_proxy[_name[i]]}},exports.del=function(name){if(null!==name)for(var _name=name.toString().split("."),_leng=_name.length,_proxy=cacheList,i=0;_leng>i;i++){if("undefined"!=typeof _proxy[_name[i]]&&i==_leng-1){delete _proxy[_name[i]];break}_proxy=_proxy[_name[i]]}},exports.get=function(name){if(null!==name)for(var _name=name.toString().split("."),_leng=_name.length,_proxy=cacheList,i=0;_leng>i;i++)if("undefined"!=typeof _proxy[_name[i]]){if(i==_leng-1)return _proxy[_name[i]];_proxy=_proxy[_name[i]]}}}),define("common/library/function",function(require,exports,module){window.Class=exports.Class=function(object,callback){var _attrs={},_F=function(){$.extend(!0,this,_attrs),this.initial&&this.initial.apply(this,arguments),this.parent&&this.parent.initial&&this.parent.initial.apply(this,arguments)};_F.prototype.setConfig=function(name,data){return Config.set.apply(Config,arguments)},_F.prototype.getConfig=function(name){return Config.get.apply(Config,arguments)},_F.prototype.getStatic=function(name){return _F[name]};for(var i=0;i<arguments.length;i++)if($.isPlainObject(arguments[i]))for(var j in arguments[i])$.isFunction(arguments[i][j])?_F.prototype[j]=arguments[i][j]:_attrs[j]=arguments[i][j];return $.isFunction(callback)&&callback.call(_F),object.instantiation===!1&&object.single!==!0?_F:new _F},window.Util={friendlyDate:function(time){var time=Number(time),text="",msec=1e3*time,differ=Math.floor(((new Date).getTime()-msec)/1e3);return text=30>differ?"刚刚":60>differ?differ+"秒前":3600>differ?Math.floor(differ/60)+"分钟前":86400>differ?Math.floor(differ/3600)+"小时前":259200>differ?1==Math.floor(time/86400)?"昨天 ":"前天 ":2592e3>differ?Util.formartDate(msec,"M月d日"):31536e3>differ?Util.formartDate(msec,"M月d日"):Util.formartDate(msec,"yyyy年M月d日")},formartDate:function(date,format){var _type=$.type(date),_date=new Date;if("date"==_type)_date=date;else if("number"==_type)_date.setTime(Number(date));else if("string"==_type){var _arr=_type.split(/\D/);_date=new Date(_arr[0]?_arr[0]:1,_arr[1]?_arr[1]-1:0,_arr[2]?_arr[2]:1,_arr[3]?_arr[3]:0,_arr[4]?_arr[4]:0,_arr[5]?_arr[5]:0)}var o={"M+":_date.getMonth()+1,"d+":_date.getDate(),"h+":_date.getHours(),"m+":_date.getMinutes(),"s+":_date.getSeconds(),"q+":Math.floor((_date.getMonth()+3)/3),S:_date.getMilliseconds()};/(y+)/.test(format)&&(format=format.replace(RegExp.$1,(_date.getFullYear()+"").substr(4-RegExp.$1.length)));for(var k in o)new RegExp("("+k+")").test(format)&&(format=format.replace(RegExp.$1,1==RegExp.$1.length?o[k]:("00"+o[k]).substr((""+o[k]).length)));return format},getDate:function(date){var _type=$.type(date);if("date"==_type)return date;if("number"==_type)return new Date(date);if("string"==_type){var _arr=_type.split(/\D/);return new Date(_arr[0]?_arr[0]:1,_arr[1]?_arr[1]-1:0,_arr[2]?_arr[2]:1,_arr[3]?_arr[3]:0,_arr[4]?_arr[4]:0,_arr[5]?_arr[5]:0)}return new Date},scrollTop:function(element,wrapElement,offset,callback){return $.isFunction(wrapElement)&&(callback=wrapElement,offset=0,wrapElement=null),$.isNumeric(wrapElement)&&(callback=offset,offset=wrapElement,wrapElement=null),$.isFunction(offset)&&(callback=offset,offset=0),$.isNumeric(offset)||(offset=0),wrapElement||(wrapElement=$("html,body")),offset=Math.floor(element.offset().top+offset),wrapElement.animate({scrollTop:offset},400,callback)},substr:function(content,start,length){var _start=start?start:0,_content=content;return _content&&"string"==typeof _content?($.isNumeric(start)&&(_start=parseInt(_start,10)),_content=length?_content.substr(start,length):_content.substr(start),_content!==content&&(_content+="..."),_content):""},HTMLEnCode:function(str){var s="";return 0==str.length?"":(s=str.replace(/</g,"&lt;"),s=s.replace(/>/g,"&gt;"))},HTMLDeCode:function(str){var s="";return 0==str.length?"":(s=str.replace(/&lt;/g," <"),s=s.replace(/&gt;/g,">"))},setCursorPosition:function(elem,index){if($(elem).is(":visible")){var val=elem.value,len=val.length;index>len||setTimeout(function(){if(elem.focus(),elem.setSelectionRange)elem.setSelectionRange(index,index);else{var range=elem.createTextRange();range.moveStart("character",-len),range.moveEnd("character",-len),range.moveStart("character",index),range.moveEnd("character",0),range.select()}},10)}},isPhone:function(){for(var userAgentInfo=navigator.userAgent,Agents=new Array("Android","iPhone","SymbianOS","Windows Phone","iPod"),v=0;v<Agents.length;v++)if(userAgentInfo.indexOf(Agents[v])>0)return!0;return!1},getMemberAvatar:function(id,size){if($.isNumeric(id)){for(var _src=[],_id=id.toString(),_i=_id.length,_size=size||"middle";10>_i;_i++)_id="0"+_id;return _src.push(_id.substr(0,3)),_src.push(_id.substr(3,3)),_src.push(_id.substr(6,2)),_src.push(_id.substr(8,2)),_src=_src.join("/"),"/Uploads/Avatar/"+_src+"/"+_size+".gif"}return""},selectable:function(element,status){var status=status?!0:!1;status?element.attr("unselectable","on").css({"-moz-user-select":"-moz-none","-moz-user-select":"none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"}).bind("selectstart",function(){return!1}):element.attr("unselectable","off").css({"-moz-user-select":"-moz-auto","-moz-user-select":"auto","-o-user-select":"auto","-khtml-user-select":"auto","-webkit-user-select":"auto","-ms-user-select":"auto","user-select":"auto"}).bind("selectstart",function(){return!0})},cnstrlen:function(str,shortUrl){return Math.ceil(1==shortUrl?str.replace(/((news|telnet|nttp|file|http|ftp|https):\/\/){1}(([-A-Za-z0-9]+(\.[-A-Za-z0-9]+)*(\.[-A-Za-z]{2,5}))|([0-9]{1,3}(\.[0-9]{1,3}){3}))(:[0-9]*)?(\/[-A-Za-z0-9_\$\.\+\!\*\(\),;:@&=\?\/~\#\%]*)*/gi,"http://goo.gl/fkKB ").replace(/^\s+|\s+$/gi,"").replace(/[^\x00-\xff]/gi,"xx").length/2:str.replace(/^\s+|\s+$/gi,"").replace(/[^\x00-\xff]/gi,"xx").length/2)},wranStyle:function(element,cls){function _wran(){element.toggleClass(_cls)}var _number=0,_cls=cls||"wran-style";element.__TIMER__&&clearInterval(element.__TIMER__),element.__TIMER__=setInterval(function(){_number++,_wran(),_number>=1&&clearInterval(element.__TIMER__)},300),_wran()},pathinfo:function(path){var ext,name,index1=path.lastIndexOf("."),index2=path.length;return index1>-1?(ext=path.substring(index1+1,index2),name=path.substring(0,index1)):(name=path,ext=""),{name:name,ext:ext}},isMac:function(){var os=(navigator.platform.match(/mac|win|linux/i)||["other"])[0].toLowerCase();return"mac"==os}}}),define("common/module/comment",function(require,exports,module){require("common/extend/validator/validator");var Template=require("common/extend/template");return require("component/jquery.atwho/dist/css/jquery.atwho.min.css"),require("component/Caret.js/dist/jquery.caret.min"),require("component/jquery.atwho/dist/js/jquery.atwho.min"),Template.helper("friendlyDate",Util.friendlyDate),Class({_options:{pageSize:10,wrapEle:null,listPath:null,votePath:null,onePath:null,postParam:{},delParam:{},itemTpl:['<p class="info">','<a href="/@<%=username%>" class="name"><%=nickname%></a>','<span class="date"><%=friendlyDate(create_time)%>评论</span>',"</p>",'<div class="content">',"<%=#resolveCode(content)%>","</div>",'<p class="util">','<span class="vote">','<a class="agree e-agree" data-href="<%=votePath%>" data-id="<%=id%>" title="赞成"><i class="icon icon-thumbs-up"></i></a>','<b class="count"><%=(vote)||0%></b>','<a class="oppose e-oppose" data-href="<%=votePath%>" data-id="<%=id%>" title="反对"><i class="icon icon-thumbs-down"></i></a>',"</span>","<%if(username){%>",'<a class="reply e-reply" data-username="<%=username%>" >回复</a>',"<%}%>",'<span class="operate<%if(is_delete){%> toggle<%}%>">',"<%if(is_delete == 1){%>",'<a class="delete e-delete" data-id="<%=id%>" data-href="<%=delPath%>"><i class="icon icon-cross"></i></a>',"<%}%>",'<span class="number"><%=number%>#</span>',"</span>","</p>"].join(""),emptyTpl:'<i class="image"></i><b class="text">暂无相关评论</b>',disabledPost:!1,hidePost:!1,disabledTemp:['<div class="comment-post-disabeld">','<span>没有登录不能发表评论，请 <a class="login" href="/user/login" target="_blank">登录</a> 或 <a class="register" target="_blank" href="/user/register">注册</a></span>',"</div>"].join(""),delPath:null,addPath:null,onDelItem:null,onAddItem:null,onLoadList:null,onCreate:null,is_delete:1},listParam:{},items:[],isEnterFocus:!1,initLoadData:!1,initial:function(options){function error(){self.postEnterEle.parent().addClass("textarea-error"),self.postTipEle.text(this.msg).removeClass("fragment-tip").addClass("fragment-error")}function success(){self.postEnterEle.parent().removeClass("textarea-error"),self.postTipEle.text(self.postTipEle.data("defaultText")).addClass("fragment-tip").removeClass("fragment-error")}var self=this;this.options=$.extend({},this._options,options),this.wrapEle=this.options.wrapEle,this.comemntEle=this.createBase(),this.comemntEle.appendTo(this.wrapEle),this.postFormEle=this.wrapEle.find(".comment-post form"),this.options.disabledPost&&this.wrapEle.addClass("comment-disabled")&&this.wrapEle.append(this.options.disabledTemp),this.options.hidePost&&this.postFormEle.parent().hide(),this.postEnterEle=this.postFormEle.find("textarea"),this.postFormEle.attr("action",this.options.addPath),this.postTipEle=this.postFormEle.find(".form-tip"),this.listEle=this.wrapEle.find(".comment-list"),this.emptyEle=$('<div class="comment-empty">'+this.options.emptyTpl+"</div>").appendTo(this.listEle),this.codeEle=this.postFormEle.find(".comment-code"),this.totalEle=this.wrapEle.find(".comment-total"),this.listEle.delegate(".delete","click",function(){var _ele=$(this);return $.dialog.confirm("确定删除评论吗？",function(action){1==action&&self.delItem(_ele)}),!1}),this.listEle.delegate(".reply","click",function(){var _value=self.postEnterEle.val();return _value=_value?_value+"@"+$(this).data("username")+" ":"@"+$(this).data("username")+" ",self.postEnterEle.val(_value).focus(),!1}),this.listEle.delegate(".agree","click",function(){return self.agree($(this)),!1}),this.listEle.delegate(".oppose","click",function(){return self.oppose($(this)),!1}),Template.helper("resolveCode",function(content){return self.resolveCode(content)}),Template.setData({votePath:this.options.votePath,delPath:this.options.delPath}),this.textareaHeightAuto(this.postEnterEle),this.postFormEle.submitForm({data:this.options.postParam,validate:[{name:"content",rule:"require",msg:"评论内容不能为空！",onBefore:function(data){var reg=/\[code\](.*?)\[\/code\]/gi,codes=[],code=!0,length=0,max=0,data=data.replace(/\s/g,"");data=data.replace(reg,function(r1,r2,i,s){return codes.push(r2),""}),length=codes.length,max=length-1;for(var i=0;length>i;i++){if(codes[i]&&"/*填写代码*/"!=codes[i])return!0;i>=max&&(code=!1)}return""!=data||code?void 0:!1},onAfter:function(status,data){status||error.call(this)}}],autoValidate:!1,onAfter:function(data,options){data.status?(self.resetForm(),data.data.number=self.getTotal()+1,data.data.is_delete=self.options.is_delete,self.addItem(data.data,!0),success(),self.postEnterEle.focus()):$.dialog.error(data.info)}}),self.postEnterEle.focus(function(){self.isEnterFocus=!0,success()}).blur(function(){self.isEnterFocus=!1}),$(document).keyup(function(event){self.isEnterFocus&&event.ctrlKey&&13==event.which&&self.postFormEle.submit()}),self.postTipEle.data("defaultText",self.postTipEle.text()),this.postEnterEle.atwho({at:"@",displayTpl:'<li><img class="avatar" src="${avatar}" /> ${name} <small>${username}</small></li>',insertTpl:"${atwho-at}${username}",callbacks:{sorter:function(query,items,searchKey){var _results,i,item,len;if(!query)return items;for(_results=[],i=0,len=items.length;len>i;i++)item=items[i],item.atwho_order=new String(item.name).toLowerCase().indexOf(query.toLowerCase())+new String(item.username).toLowerCase().indexOf(query.toLowerCase()),item.atwho_order>-2&&_results.push(item);return _results.sort(function(a,b){return b.atwho_order-a.atwho_order})},filter:function(query,data,searchKey){var _results,i,item,len;for(_results=[],i=0,len=data.length;len>i;i++)item=data[i],(new String(item.name).toLowerCase().indexOf(query.toLowerCase())>-1||new String(item.username).toLowerCase().indexOf(query.toLowerCase())>-1)&&_results.push(item);return _results},remoteFilter:function(query,callback){$.getJSON("/autocomplete/user",{search:query},function(data){callback(data)})}}}),this.codeEle.click(function(){var _value=self.postEnterEle.val();_value=_value?_value+"\n[code]\n/*填写代码*/\n[/code]":"[code]\n/*填写代码*/\n[/code]",self.postEnterEle.val(_value).focus()}),this.setPage(this.options.page||1),this.setPageSize(this.options.pageSize),this.getLoadMoreEle(),$.isFunction(this.options.onCreate)&&this.options.onCreate.call(this)},loadList:function(param,callback){return $.extend(this.listParam,param),this.emptyEle.removeClass("empty-active"),this.listEle.loading("评论加载中","loading-ripple-empty"),this.getLoadMoreEle().removeClass("more-active"),$.ajax({url:this.options.listPath,data:this.listParam,type:"post",context:this,success:function(data){this.initLoadData||this.setTotal(data.data.count),this.initLoadData=!0,$.isFunction(callback)&&callback.call(this,data.data.list)},complete:function(){this.listEle.loading("hide")}})},loadOne:function(param,callback){return this.emptyEle.removeClass("empty-active"),this.getLoadMoreEle().removeClass("more-active"),this.listEle.loading("评论加载中","loading-ripple-empty"),$.ajax({url:this.options.onePath,data:param,type:"post",context:this,success:function(data){data.status||$.dialog.error(data.info),$.isFunction(callback)&&callback.call(this,data)},complete:function(){this.listEle.loading("hide")}})},assignList:function(param,callback){this.empty(),this.initLoadData=!1,this._replaceEle&&this._replaceEle.remove(),this.loadList(param,function(data){$.isFunction(callback)&&callback.call(this,data),this._addItem(data),this.find()})},moreList:function(param){this.setPage(Math.min(this.getPage()+1,this.getPageTotal())),this.loadList(param,function(data){this._addItem(data),this.find()})},agree:function(element,callback){var _vote=element.parent();_vote.hasClass("disabled")||element.hasClass("loading")||(element.addClass("loading"),$.ajax({url:element.data("href"),type:"post",data:{comm_id:element.data("id"),type:1},success:function(data){var _count=_vote.find(".count");data.status?_count.text(Number(_count.text())+1):$.dialog.error(data.info),("投票成功"==data.info||"已经投过票了"==data.info)&&(_vote.addClass("disabled"),_vote.find("a").attr("title","你已投过票！"))},complete:function(){element.removeClass("loading")}}))},oppose:function(element,callback){var _vote=element.parent();_vote.hasClass("disabled")||element.hasClass("loading")||(element.addClass("loading"),$.ajax({url:element.data("href"),type:"post",data:{comm_id:element.data("id"),type:0},success:function(data){var _count=_vote.find(".count");data.status?_count.text(Number(_count.text())-1):$.dialog.error(data.info),("投票成功"==data.info||"已经投过票了"==data.info)&&(_vote.addClass("disabled"),_vote.find("a").attr("title","你已投过票！"))},complete:function(){element.removeClass("loading")}}))},getPageTotal:function(){return Math.ceil(this.getTotal()/this.getPageSize())},setPageSize:function(size){return $.isNumeric(size)&&(this._pageSize=size,this.listParam.pageSize=this._pageSize),this},getPageSize:function(){return this._pageSize},setPage:function(page){return $.isNumeric(page)&&(this._page=page,this.listParam.page=this._page),this},getPage:function(){return this._page},setTotal:function(total){return $.isNumeric(total)&&(this._total=Number(total),this.totalEle.text(this._total)),this},getTotal:function(){return this._total||0},getItemAt:function(id){for(var i=0;i<this.items.length;i++)if(this.items[i].data("id")==id)return i;return-1},_addItem:function(data,prepend,sumTotal){var _data=$.isArray(data)?data:[data],_length=0,_i=0,_item=null,_temp='<div class="comment-item" data-id="<%=id%>">'+this.options.itemTpl+"</div>",_callback=$.isFunction(this.options.onAddItem)?this.options.onAddItem:$.noop,_items=[],_prepend=prepend?!0:!1;for(_data=this.formartData(this.removeRepeat(_data)),_length=_data.length;_length>_i;_i++){_data[_i].is_delete=this.options.is_delete,_item=Template.parseTemp(_temp,_data[_i]),_item=$(_item),_items.push(_item),this.listEle[_prepend?"prepend":"append"](_item),_callback.call(this,_item)}return this.items=this.items.concat(_items),sumTotal===!1?0:_data.length},addItem:function(data,prepend,sumTotal){var _num=this._addItem.apply(this,arguments);return this.setTotal(this._total+_num),this},delItem:function(element,callback){element.hasClass("loading")||(element.addClass("loading"),$.ajax({url:element.data("href"),data:$.extend({id:element.data("id")},this.options.delParam),type:"post",context:this,success:function(data){if(data.status){var _index=this.getItemAt(element.data("id")),_prev=this.items[_index].prevAll(".comment-item");"undefined"!=typeof _index&&(this.items[_index].remove(),this.items.splice(_index,1),this.setTotal(Math.max(--this._total,0)),_prev.each(function(){var _text=$(this).find(".number").text().replace("#","");$(this).find(".number").html(_text-1+"#")}),this.find())}else $.dialog.error(data.info);$.isFunction(callback)&&callback.call(this,data)},complete:function(){element.removeClass("loading")}}))},setDelParam:function(param){this.options.delParam=$.extend(this.options.delParam||{},param)},empty:function(){for(var i=this.items.length-1;i>=0;i--)this.items[i].remove(),this.items.splice(i,1);this.setTotal(0),this.setPage(1),this.find()},find:function(){var _total=this.getTotal(),_length=this.items.length||0,_differ=Math.max(_total-_length,0);_length?this.emptyEle.removeClass("empty-active"):this.options.hidePost&&this.emptyEle.addClass("empty-active"),_differ?this.getLoadMoreEle(_differ).addClass("more-active"):this.getLoadMoreEle(_differ).removeClass("more-active")},resetForm:function(){return this.postEnterEle.val("").blur(),this},createBase:function(){var _tpl=['<div class="comment-result">','<strong class="title">相关评论(<b class="comment-total">0</b>)</strong>','<div class="comment-post">','<form class="form" action="#" method="post">','<label class="enter w-textarea textarea-full"><textarea class="textarea-input" name="content" placeholder="文明上网，理性发言"></textarea></label>','<div class="util cf">','<div class="left">','<span class="comment-code"><b class="e-code icon-embed2" title="插入代码"></b></span>',"</div>",'<div class="right">','<span class="form-tip w-fragment fragment-tip">Ctrl + Enter快速发布</span>','<label class="form-submit w-btn btn-success btn-m"><button class="btn-input" type="submit">发布</button></label>',"</div>","</div>","</form>","</div>",'<div class="comment-list"></div>',"</div>"].join("");return $(_tpl)},getLoadMoreEle:function(differ){var self=this;return this._loadMoreEle||(this._loadMoreEle=$('<div class="comment-more"><span class="more-inner">加载剩余<b class="number">0</b>条评论</span></div>'),this.listEle.after(this._loadMoreEle),this._loadMoreEle.children().click(function(){self.moreList()})),$.isNumeric(differ)&&this._loadMoreEle.find(".number").text(differ),this._loadMoreEle},formartData:function(data){for(var data=$.isArray(data)?data:[data],_data=[],_count=this.items.length,_total=this.getTotal(),i=0;i<data.length;i++)"undefined"==typeof data[i].number&&(data[i].number=_total-_count-i),_data.push(data[i]);return _data},removeRepeat:function(data){for(var data1=$.isArray(data)?data:[data],data2=[],i=0;i<data1.length;i++)this.getItemAt(data1[i].id)<0&&data2.push(data1[i]);return data2},resolveCode:function(content){var reg=/(\[code\])([\s \S]*?)(\[\/code\])/gi;return res=content.replace(reg,function(r1,r2,r3,r4,n,s){var str="";return"[code]"==r2&&(str+="<pre><code>"),str+=$.trim(r3),"[/code]"==r4&&(str+="</code></pre>"),str}),res},textareaHeightAuto:function(element){function autoHeight(elem){var _pt=parseInt(element.css("paddingTop")),_pb=parseInt(element.css("paddingBottom"));elem.style.height="auto",elem.scrollTop=0,elem.style.height=Math.max(elem.scrollHeight-_pt-_pb,0)+"px"}element=element||this.postEnterEle,autoHeight(element[0]),arguments.callee._inited||(element.on("keyup focus cut paste",function(){autoHeight(this)}),arguments.callee._inited=!0)},instantiation:!1},function(){this.resolveCode=function(content){var reg=/(\[code\])([\s \S]*?)(\[\/code\])/gi;return res=content.replace(reg,function(r1,r2,r3,r4,n,s){var str="";return"[code]"==r2&&(str+="<pre><code>"),str+=$.trim(r3),"[/code]"==r4&&(str+="</code></pre>"),str}),res},this.replaceCode=function(content,replaceString){var _replaceString=replaceString||'<span class="code-placehoder" title="查看代码"></span>',reg=/(\[code\])([\s \S]*?)(\[\/code\])/gi;return res=content.replace(reg,function(r1,r2,r3,r4,n,s){var str='<div class="m-replace-code">';return str+='<div class="code-show">',str+=_replaceString,str+="</div>",str+='<div class="code-hide">',"[code]"==r2&&(str+="<pre><code>"),str+=$.trim(r3),"[/code]"==r4&&(str+="</code></pre>"),str+="</div>",str+="</div>"}),res}})}),define("common/module/config",function(require,exports,module){var Cache=require("common/library/cache");return window.Config={set:function(name,data){return"string"==typeof name?Cache.set("CONFIG."+name,data):$.isPlainObject(name)?Cache.set({CONFIG:name}):void 0},get:function(name){return"string"==typeof name?Cache.get("CONFIG."+name):void 0},del:function(name){return"string"==typeof name?Cache.del("CONFIG."+name):void 0}}}),define("common/module/cutImage",function(require,exports,module){require("component/jcrop/css/jquery.Jcrop.css"),require("component/jcrop/js/jquery.Jcrop"),require("component/jquery.form");var Template=require("common/extend/template");return Class({_options:{cls:null,boxWidth:0,boxHeight:0,cutWidth:0,cutHeight:0,uploadUrl:null,uploadParam:null,saveCutUrl:null,saveCutParam:null,onUploadStart:null,onUploadEnd:null,onSuccess:null},cutImageData:{},cutImageKey:"",initial:function(options){var self=this;this.options=$.extend({},this._options,options),this.createTemp(),this.wrapEle.addClass(this.options.cls),this.setUploadUrl(this.options.uploadUrl),this.setUploadParam(this.options.uploadParam),this.setSaveCutUrl(this.options.saveCutUrl),this.setSaveCutParam(this.options.saveCutParam),this.uploadFileEle.change(function(){self.uploadFormEle.submit()}),this.cropImage=null,self.cropImage=$.Jcrop(this.cropImageEle,{aspectRatio:this.options.cutWidth/this.options.cutHeight,bgOpacity:.5,boxWidth:this.options.boxWidth,boxHeight:this.options.boxHeight,onSelect:function(c){self.cutImageData=c},onRelease:function(){self.cutImageData={x:0,y:0,w:self.options.cutWidth,h:self.options.cutHeight}}}),this.uploadFormEle.submit(function(){return self.uploadFileEle.hasClass("disabled")||($(this).ajaxSubmit({data:self._uploadParam,beforesend:self.options.onUploadStart,success:function(data){if("string"==typeof data&&(data=$.parseJSON(data)),data.status){self.wrapEle.addClass("cutimg-enable");var _src=data.data.url.indexOf("?")>=0?data.data.url+"&v="+(new Date).getTime():data.data.url+"?v="+(new Date).getTime();self.cutImageKey=data.data.key,self.cropImage.setImage(_src,function(){var _ar=this.getOptions().aspectRatio,_is=this.getBounds(),_ms=Math.min(_is[0],_is[1]),_hw=Math.floor(.8*_ms),_hh=Math.floor(_hw/_ar),_x=(_is[0]-_hw)/2,_y=(_is[1]-_hh)/2;self.cropImage.setSelect([_x,_y,_hw+_x,_hh+_y])})}else $.dialog.error(data.info);$.isFunction(self.options.onUploadEnd)&&self.options.onUploadEnd.call(this,data)},complete:function(){self.uploadBtnEle.removeClass("btn-loading"),self.uploadBtnEle.find("button").text("选择图片"),self.uploadFileEle.removeClass("disabled"),self.uploadFileEle.show()}}),self.uploadBtnEle.addClass("btn-loading"),self.uploadBtnEle.find("button").text("正在上传"),self.uploadFileEle.addClass("disabled"),self.uploadFileEle.hide()),!1}),this.saveCutFormEle.submitForm({data:this._saveCutParam,onBefore:function(options){self.cropImage&&(options.data.key=self.cutImageKey,options.data.x=self.cutImageData.x,options.data.y=self.cutImageData.y,options.data.w=self.cutImageData.w,options.data.h=self.cutImageData.h)},onAfter:function(data){data.status?(self.cropImage.release(),$.dialog.success(data.info),$.isFunction(self.options.onSuccess)&&self.options.onSuccess.call(this,data)):$.dialog.error(data.info)}}),this.reuploadEle.click(function(){self.reupload()})},getHtml:function(){return this.wrapEle},createTemp:function(){var _html=['<div class="m-cutimg-work">','<div class="work-area">','<div class="work-upload">','<form class="w-form" id="uploadForm" method="post" enctype="multipart/form-data">','<div class="upload-input">','<input name="cover" class="file" type="file">','<i class="icon icon-cloud-storage"></i>','<label class="w-btn btn-success btn-l">','<button type="button" class="btn-input">选择图片</button>',"</label>","</div>",'<p class="upload-tip">图片大小不能超过5M，且只允许为png、gif、jpg格式图片</p>',"</form>","</div>",'<div class="work-crop">','<form class="w-form" id="saveCutForm" method="post" enctype="multipart/form-data">','<div class="crop-image">','<div class="image-inner">','<img width="200">',"</div>","</div>",'<div class="crop-util">','<span class="util-left">','<a class="reupload e-link"><i class="icon-undo2"></i>重新上传</a>',"</span>",'<span class="util-right">','<label class="w-btn btn-success btn-m">','<button class="btn-input" type="submit">保存裁剪</button>',"</label>","</span>","</div>","</form>","</div>","</div>","</div>"].join("");this.wrapEle=$(Template.parseTemp(_html)),this.uploadFileEle=this.wrapEle.find("[type=file]"),this.uploadWorkEle=this.wrapEle.find(".work-upload"),this.uploadBtnEle=this.uploadWorkEle.find(".w-btn"),this.cropWorkEle=this.wrapEle.find(".work-crop"),this.cropImageEle=this.wrapEle.find(".crop-image img"),this.uploadFormEle=this.wrapEle.find("#uploadForm"),this.saveCutFormEle=this.wrapEle.find("#saveCutForm"),this.reuploadEle=this.wrapEle.find(".reupload")},setUploadUrl:function(url){return this.uploadFormEle.attr("action",url),this},setUploadParam:function(param){return this._uploadParam=param,this},setSaveCutUrl:function(url){return this.saveCutFormEle.attr("action",url),this},setSaveCutParam:function(param){return this._saveCutParam=param,this},reupload:function(){return this.wrapEle.removeClass("cutimg-enable"),this},instantiation:!1})}),define("common/module/doing",function(require,exports,module){var Template=require("common/extend/template");return Template.helper("formartDate",Util.formartDate),Template.helper("friendlyDate",Util.friendlyDate),Class({_options:{run:!0,cls:"default",doingListEle:$(),pageSize:10,page:1,param:{},url:null,parseData:null,groupTpl:['<strong class="title"><%=postDate%></strong>'].join(""),activeItemTpl:1,tempData:{jumpPath:"",isShowManual:!0},itemTpl:[['<b class="radius"></b>','<b class="date"><%=formartDate(create_time,"hh:mm")%></b>','<p class="info">','<a class="avatar"><img width="80" height="80" src="<%=getMemberAvatar(uid)%>"></a>','<a class="name"><%=nickname%></a>','<span class="type"><%=name%></span>',"</p>",'<p class="content">',"<%if(type==1001){%>",'<%if(isShowManual){%><a href="<%=jumpPath%>?book_id=<%=book_id%>" target="_blank">《<%=title%>》</a><%}%>',"<%}else if(type==1002){%>",'<%if(isShowManual){%><a href="<%=jumpPath%>?book_id=<%=book_id%>" target="_blank">《<%=title%>》</a><%}%>',"<%}else if(type==1003){%>",'<%if(isShowManual){%><a href="<%=jumpPath%>?book_id=<%=book_id%>" target="_blank">《<%=title%>》</a><%}%>',"<%}else if(type==1004){%>","《<%=title%>》","<%}else if(type==2001){%>",'<%if(isShowManual){%><a href="<%=jumpPath%>?book_id=<%=book_id%>" target="_blank">《<%=booktitle%>》</a><%}%>',"<%=title%>","<%}else if(type==2002){%>",'<%if(isShowManual){%><a href="<%=jumpPath%>?book_id=<%=book_id%>" target="_blank">《<%=booktitle%>》</a><%}%>',"<%=title%>","<%}else if(type==2003){%>",'<%if(isShowManual){%><a href="<%=jumpPath%>?book_id=<%=book_id%>" target="_blank">《<%=booktitle%>》</a><%}%>',"<%=title%>","<%}else if(type==3001){%>",'<%if(isShowManual){%><a href="<%=jumpPath%>?book_id=<%=book_id%>" target="_blank">《<%=booktitle%>》</a><%}%>','<a href="<%=jumpPath%>?book_id=<%=book_id%>&doc_id=<%=doc_id%>" target="_blank"><%=title%></a>',"<%}else if(type==3002){%>",'<%if(isShowManual){%><a href="<%=jumpPath%>?book_id=<%=book_id%>" target="_blank">《<%=booktitle%>》</a><%}%>','<a href="<%=jumpPath%>?book_id=<%=book_id%>&doc_id=<%=doc_id%>" target="_blank"><%=title%></a>',"<%}else if(type==3003){%>",'<%if(isShowManual){%><a href="<%=jumpPath%>?book_id=<%=book_id%>" target="_blank">《<%=#booktitle%>》</a><%}%>','<a href="<%=jumpPath%>?book_id=<%=book_id%>&doc_id=<%=doc_id%>" target="_blank"><%=#title%></a>',"<%}else if(type==3004){%>",'<%if(isShowManual){%><a href="<%=jumpPath%>?book_id=<%=book_id%>" target="_blank">《<%=booktitle%>》</a><%}%>',"<%=title%>","<%}else if(type==3005){%>",'<%if(isShowManual){%><a href="<%=jumpPath%>?book_id=<%=book_id%>" target="_blank">《<%=booktitle%>》</a><%}%>','<a href="<%=jumpPath%>?book_id=<%=book_id%>&doc_id=<%=doc_id%>" target="_blank"><%=title%></a>',"<%}else if(type==1005){%>",'<%if(isShowManual){%><a href="<%=jumpPath%>?book_id=<%=book_id%>" target="_blank">《<%=booktitle%>》</a><%}%>',"<%}else{%>","<%=title%>","<%}%>","</p>"].join(""),['<b class="radius"></b>','<b class="date"><%=formartDate(create_time,"hh:mm")%></b>','<div class="info">','<a class="avatar"><img width="80" height="80" src="<%=getMemberAvatar(uid)%>"></a>',"<div>",'<a class="name"><%=nickname%></a>','<%if(booktitle && book_id){%>在<a href="<%=jumpPath%>?book_id=<%=book_id%>" target="_blank">《<%=booktitle%>》</a>中<%}%>',"发表评论","</div>","</div>",'<div class="content"><%=#content%></div>','<div class="more"><a href="<%=jumpPath%>?book_id=<%=book_id%>&doc_id=<%=doc_id%>#<%=doc_id%>-<%=id%>" target="_blank">点击查看</a></div>'].join(""),['<div class="system-message">','<a class="avatar"><img width="80" height="80" src="<%=getMemberAvatar(uid)%>"></a>','<div class="main">','<div class="head">','<strong class="title"><a href="<%=jumpPath%>?book_id=<%=book_id%>&doc_id=<%=id%>" target="_blank"><%=title%></a></strong>',"</div>",'<div class="body">',"<%=#content%>","</div>",'<div class="foot">','<span class="date">发布于<%=friendlyDate(create_time/1000)%></span>',"</div>",'<b class="arrow"><b></b></b>',"</div>","</div>"].join("")],
onAddDoingItem:null,onCreate:null},doingGroupData:{},initial:function(options){this.options=$.extend(!0,{},this._options,options),this.appendToEle=this.options.doingListEle,this.doingListEle=$('<div class="group-list"></div>').appendTo(this.appendToEle),this._groupTpl=['<div class="doing-group group-'+this.options.cls+'">','<div class="group-head">'+this.options.groupTpl+"</div>",'<div class="group-body"></div>',"</div>"].join(""),this.setShowTemp(this.options.activeItemTpl),Template.setData(this.options.tempData),this.options.run&&this.targetPageDoing(this.options.page),$.isFunction(this.options.onCreate)&&this.options.onCreate.call(this)},getData:function(callback){this.options.param.page=this.options.page,$.ajax({url:this.options.url,data:this.options.param,type:"post",context:this,success:function(data){if(data.status){var _data=$.isFunction(this.options.parseData)?this.options.parseData.call(this,data.data):data.data;this.run=!0,this.findMoreDoing(_data),$.isFunction(callback)&&callback.call(this,_data)}else $.dialog.error(data.info)},complete:function(){}})},formartData:function(data){for(var _data=$.isArray(data)?data:[data],i=0;i<_data.length;i++)$.isPlainObject(_data[i])&&(_data[i].create_time=1e3*_data[i].create_time,_data[i].postDate=Util.formartDate(_data[i].create_time,"yyyy-MM-dd"),_data[i].itemElement=$(Template.parseTemp(this.currentDoingTemp,_data[i])));return _data},addGroupData:function(data){for(var _data=$.isArray(data)?data:[data],i=0;i<_data.length;i++)_data[i].postDate in this.doingGroupData||(this.doingGroupData[_data[i].postDate]={doingItems:[]},this.doingGroupData[_data[i].postDate].element=$(Template.parseTemp(this._groupTpl,_data[i])),this.doingGroupData[_data[i].postDate].element.appendTo(this.doingListEle)),this.doingGroupData[_data[i].postDate].doingItems.push(_data[i]),_data[i].groupElement=this.doingGroupData[_data[i].postDate].element;return this},getDoingItem:function(id){for(var i in this.doingGroupData)for(var j=0;j<this.doingGroupData[i].doingItems.length;j++)if(this.doingGroupData[i].doingItems[j].id==id)return this.doingGroupData.doingItems[j]},inGoupData:function(id){for(var i in this.doingGroupData)for(var j=0;j<this.doingGroupData[i].doingItems.length;j++)if(this.doingGroupData[i].doingItems[j].id==id)return i;return-1},targetPageDoing:function(page,callback){this.options.page=page,this.getData(function(data){this.addDoingItem(data),$.isFunction(callback)&&callback(data)})},reloadDoing:function(callback){return this.doingListEle.loading(null,"loading-ripple"),this.loadMoreEle&&this.loadMoreEle.removeClass("active"),this.clearDoing(),this.options.page=1,this.getData(function(data){this.doingListEle.loading("hide"),this.addDoingItem(data),$.isFunction(callback)&&callback(data)}),this},moreDoing:function(callback){return this.options.page+=1,this.getData(function(data){this.addDoingItem(data),$.isFunction(callback)&&callback(data)}),this},clearDoing:function(){for(var i in this.doingGroupData)this.delGroupItem(i)},findDoingList:function(){$.isEmptyObject(this.doingGroupData)?(this.emptyEle||(this.emptyEle=$('<div class="group-empty">暂无相关数据！</div>'),this.appendToEle.append(this.emptyEle)),this.emptyEle.addClass("active")):this.emptyEle&&this.emptyEle.removeClass("active")},findMoreDoing:function(data){var self=this;data.length>=this.options.pageSize?(this.loadMoreEle||(this.loadMoreEle=$('<div class="group-more-load"><b>点击加载更多</b></div>'),this.loadMoreEle.click(function(){self.moreDoing()}),this.appendToEle.append(this.loadMoreEle)),this.loadMoreEle.addClass("active"),this.emptyMoreEle&&this.emptyMoreEle.removeClass("active"),this.emptyEle&&this.emptyEle.removeClass("active")):$.isEmptyObject(this.doingGroupData)?(this.emptyEle||(this.emptyEle=$('<div class="group-empty m-empty empty-theme-a"><img class="empty-image" src="'+Config.get("STATIC")+'/home/image/status/3.png" /><span class="empty-text">暂无相关动态</span></div>'),this.appendToEle.append(this.emptyEle)),this.emptyEle&&this.emptyEle.addClass("active"),this.loadMoreEle&&this.loadMoreEle.removeClass("active"),this.emptyMoreEle&&this.emptyMoreEle.removeClass("active")):(this.emptyMoreEle||(this.emptyMoreEle=$('<div class="group-more-empty"><b class="text">没有更多动态了</b></div>'),this.appendToEle.append(this.emptyMoreEle)),this.emptyMoreEle.addClass("active"),this.loadMoreEle&&this.loadMoreEle.removeClass("active"),this.emptyEle&&this.emptyEle.removeClass("active"))},addDoingItem:function(data){var _data=this.formartData(data),_callback=$.isFunction(this.options.onAddDoingItem)?this.options.onAddDoingItem:$.noop;this.addGroupData(_data);for(var i=0;i<_data.length;i++)_data[i].groupElement&&(_data[i].itemElement.appendTo(_data[i].groupElement.find(".group-body")),_callback.call(this,_data[i].itemElement));return this.findDoingList(),this},delDoingItem:function(id){var _index=this.inGoupData(id);if(_index>=0)for(var _group=this.doingGroupData[_index],i=0;i<_group.doingItems.length;i++)if(_group.doingItems[i].id==id){_group.doingItems.element.remove(),_group.doingItems.splice(i,1),_group.doingItems.length||this.delGroupItem(_index);break}},setParam:function(param){return $.extend(this.options.param,param),this},setShowTemp:function(num){return 1==num?this.currentDoingTemp='<div class="doing-item">'+this.options.itemTpl[0]+"</div>":2==num?this.currentDoingTemp='<div class="doing-item">'+this.options.itemTpl[1]+"</div>":3==num&&(this.currentDoingTemp='<div class="doing-item">'+this.options.itemTpl[2]+"</div>"),this},setUrl:function(url){return this.options.url=url,this},delGroupItem:function(mask){if(mask in this.doingGroupData){for(var i=0;i<this.doingGroupData[mask].doingItems.length;i++)this.doingGroupData[mask].doingItems[i].itemElement.remove();this.doingGroupData[mask].doingItems=[],this.doingGroupData[mask].element.remove(),delete this.doingGroupData[mask]}return this},instantiation:!1})}),define("common/module/sharing",function(){return Class({options:{url:location.href,title:null,summary:null,cover:null},initial:function(options){var self=this;this.options=$.extend({},this.options,options),$(document).on("click","a[data-sharing],button[data-sharing]",function(e){console.log(2),e&&e.preventDefault();var type=$(this).data("sharing");self.social[type](self.options)})},config:function(options){this.options=$.extend({},this.options,options)},social:{qq:function(options){var param=["url="+options.url,"desc=刚看到这篇文章不错，推荐给你看看～","summary="+options.summary,"site=看云","title="+options.title];options.cover&&param.push("pics="+encodeURIComponent(options.cover)),param=param.join("&"),window.open("http://connect.qq.com/widget/shareqq/index.html?"+param)},wechat:function(options){$.dialog('<img src="http://www.kancloud.cn/qrcode?url='+options.url+'" width="300" height="300" style="margin:15px;" />',{title:"分享到微信",cache:!0})},weibo:function(options){var param=["url="+options.url,"title=【"+options.title+"】"+options.summary];options.cover&&param.push("pic="+encodeURIComponent(options.cover)),param=param.join("&"),window.open("http://service.weibo.com/share/share.php?"+param)}},instantiation:!1})}),define("common/module/tagCreate",function(require,exports,module){var Template=require("common/extend/template");return Class({_options:{appendEle:$(),data:null,maxNumber:null,maxEnterLength:7,hiddenName:"tag",itemTpl:['<span class="text"><%=name%></span>'].join(""),onAdd:null,onDel:null,onRepeat:null,onChange:null,onCreate:null,onMaxLimit:null},tagList:[],wranTimer:null,wranEle:$(),initial:function(options){var self=this;this.options=$.extend({},this._options,options),this.appendEle=this.options.appendEle.addClass("m-tag-create"),this.createEle=this.createHtml(),this.tagListEle=this.createEle.filter(".tag-list"),this.enterEle=this.createEle.filter(".tag-enter"),this.hiddenEle=this.createEle.filter(".tag-hidden"),this.setTpl(this.options.itemTpl),this.setMaxNumber(this.options.maxNumber),this.setMaxEnterLength(this.options.maxEnterLength);var _prevValue=this.enterEle.val();this.enterEle.keydown(function(event){return 32!=event.which&&13!=event.which||!_prevValue?void 0:(self.addItem(_prevValue),_prevValue="",$(this).val(""),!1)}).keyup(function(event){var _value=$.trim($(this).val());return Util.cnstrlen(_value)>self._maxEnter?(_value=_prevValue,$(this).val(_value),!1):($(this).val(_value),void(_prevValue=_value))}).blur(function(){var _value=$.trim($(this).val());_value&&(self.addItem($(this).val()),$(this).val(""))}),this.appendEle.click(function(){self.enterEle.focus()}),this.addItem(this.options.data),this.createEle.appendTo(this.appendEle),$(document).trigger("onCompatible",["placeholder",this.enterEle]),$.isFunction(this.options.onCreate)&&this.options.onCreate.call(this)},addItem:function(data){$.isFunction(data)&&(data=data.call(this));var _self=this,_data=$.isArray(data)?data:[data],_text=[];if(null===this._maxNumber||this.tagList.length<this._maxNumber){for(var i=0;i<_data.length;i++)if(_data[i]){var _name=_data[i].replace(/\s/g,"");if(!this.isRepeat(_name)){var _item=$(Template.parseTemp(this._itemTpl,{name:_name}));_item.find(".close").click(function(item){return function(){_self.delItem(item)}}(_item)),this.tagList.push(_item),this.tagListEle.append(_item),$.isFunction(this.options.onItem)&&this.options.onItem.call(this,_item)}}for(var i=0;i<this.tagList.length;i++)_text.push(this.tagList[i].find(".text").text());this.hiddenEle.val(_text.join(",")),$.isFunction(this.options.onChange)&&this.options.onChange.call(this)}else $.isFunction(this.options.onMaxLimit)&&this.options.onMaxLimit.call(this,this._maxNumber)},delItem:function(item){var _text=[],_index=this.inItem(item);if(_index>=0){item.remove(),this.tagList.splice(_index,1);for(var i=0;i<this.tagList.length;i++)_text.push(this.tagList[i].find(".text").text());this.hiddenEle.val(_text.join(",")),$.isFunction(this.options.onChange)&&this.options.onChange.call(this),$.isFunction(this.options.onDel)&&this.options.onDel.call(this,_index)}},inItem:function(item){for(var i=0;i<this.tagList.length;i++)if(this.tagList[i].is(item))return i;return-1},isRepeat:function(text){for(var _self=this,_step=0,i=0;i<this.tagList.length;i++)if(this.tagList[i].find(".text").text()==text)return clearTimeout(this.wranTimer),this.wranEle.removeClass("tag-wran"),this.wranTimer=setInterval(function(){6>_step?_self.tagList[i].toggleClass("tag-wran"):clearInterval(_self.wranTimer),++_step},200),this.wranEle=this.tagList[i],$.isFunction(this.options.onRepeat)&&this.options.onRepeat.call(this,this.tagList[i],text),!0;return!1},setTpl:function(tpl){return this._itemTpl='<span class="tag-item">'+tpl+'<b class="close icon-cross"></b></span>',this},setMaxNumber:function(number){return"number"==$.type(number)?this._maxNumber=parseInt(number,10):this._maxNumber=null,this},setMaxEnterLength:function(number){return"number"==$.type(number)?this._maxEnter=parseInt(number,10):this._maxEnter=null,this},createHtml:function(){var _html=['<span class="tag-list"></span>','<input class="tag-enter" type="text" placeholder="点击空白处输入标签" />','<input class="tag-hidden" type="hidden" name="'+this.options.hiddenName+'" />'].join("");return $(_html)},instantiation:!1})});